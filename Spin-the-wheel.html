<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Spin the Wheel ‚Äî n8n Automation Basics (Offline)</title>
  <style>
    :root{
      --bg0:#050b1f;
      --bg1:#071232;
      --card:#0b1d43;
      --card2:#0e2657;
      --fg:#eaf0ff;
      --muted:#b7c5ff;
      --muted2:#93a7f7;
      --line:rgba(255,255,255,.12);
      --line2:rgba(255,255,255,.18);
      --shadow: 0 16px 42px rgba(0,0,0,.45);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --space-1: 6px;
      --space-2: 10px;
      --space-3: 14px;
      --space-4: 18px;
      --space-5: 24px;
      --tap: 44px;

      --ok:#2be7a4;
      --bad:#ff5b7b;
      --warn:#ffd166;
      --info:#7aa7ff;
      --accent:#6d7dff;

      --maxw: 1180px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(109,125,255,.26), transparent 55%),
        radial-gradient(900px 520px at 70% 20%, rgba(43,231,164,.14), transparent 55%),
        radial-gradient(900px 520px at 60% 90%, rgba(122,167,255,.12), transparent 50%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--fg);
      overflow:hidden;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--space-3);
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.10));
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: var(--space-3);
      min-width: 240px;
      user-select:none;
    }
    .logo{
      width: 34px; height: 34px;
      border-radius: 10px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      display:grid;
      place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .brand h1{
      margin:0;
      font-size: 14px;
      line-height: 1.2;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:2px 0 0;
      font-size: 11px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap: var(--space-2);
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .chip{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      box-shadow: 0 8px 18px rgba(0,0,0,.2);
      min-height: var(--tap);
      user-select:none;
      font-size: 13px;
    }
    .chip .k{color: var(--muted)}
    .chip .v{font-weight:900}
    .chip .em{font-size: 15px}

    .progress{
      width: 180px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      position:relative;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(109,125,255,.95), rgba(43,231,164,.9));
      border-radius: 999px;
      transition: width .22s ease;
    }
    .bar.danger{
      background: linear-gradient(90deg, rgba(255,209,102,.95), rgba(255,91,123,.9));
    }

    .iconbtn{
      width: var(--tap);
      height: var(--tap);
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--fg);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .iconbtn:hover{background: rgba(255,255,255,.09); border-color: var(--line2)}
    .iconbtn:active{transform: scale(.98)}
    .iconbtn:focus-visible{
      outline: 3px solid rgba(109,125,255,.55);
      outline-offset: 2px;
    }

    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--fg);
      border-radius: 14px;
      padding: 12px 12px;
      min-height: var(--tap);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-weight: 800;
      letter-spacing:.1px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }
    .btn:hover{background: rgba(255,255,255,.10); border-color: var(--line2)}
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn:focus-visible{
      outline: 3px solid rgba(109,125,255,.55);
      outline-offset: 2px;
    }
    .btn.primary{
      border-color: rgba(109,125,255,.6);
      background: linear-gradient(180deg, rgba(109,125,255,.25), rgba(109,125,255,.14));
    }
    .btn.good{
      border-color: rgba(43,231,164,.55);
      background: linear-gradient(180deg, rgba(43,231,164,.18), rgba(43,231,164,.10));
    }
    .btn.danger{
      border-color: rgba(255,91,123,.55);
      background: linear-gradient(180deg, rgba(255,91,123,.18), rgba(255,91,123,.10));
    }
    .btn.ghost{background: transparent}
    .btn[disabled]{opacity:.55; cursor:not-allowed}

    main{
      height: calc(100% - 84px);
      display:flex;
      gap: var(--space-4);
      padding: var(--space-4) var(--space-5);
      width: 100%;
      max-width: calc(var(--maxw) + 520px);
      margin: 0 auto;
      overflow:hidden;
    }

    /* Teacher panel */
    .teacher{
      width: 420px;
      max-width: 420px;
      flex: 0 0 420px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .teacher.collapsed{width:56px; max-width:56px; flex-basis:56px}
    .t-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    .t-title{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .t-title h2{
      margin:0;
      font-size: 13px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      white-space:nowrap;
    }
    .t-body{
      padding: 12px;
      overflow:auto;
      min-height:0;
    }
    .t-body::-webkit-scrollbar{width:10px}
    .t-body::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.0);
      background-clip: padding-box;
    }
    .teacher.collapsed .t-title,
    .teacher.collapsed .t-body,
    .teacher.collapsed .t-foot{display:none}
    .teacher.collapsed .t-head{justify-content:center; padding:10px}

    fieldset{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      margin: 0 0 12px;
      background: rgba(0,0,0,.10);
    }
    legend{
      padding: 0 8px;
      font-size: 12px;
      color: var(--muted);
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--fg);
      padding: 10px 12px;
      outline:none;
      font-size: 13px;
    }
    textarea{min-height: 120px; resize: vertical}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(109,125,255,.7);
      box-shadow: 0 0 0 3px rgba(109,125,255,.25);
    }
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .status{
      display:flex;
      align-items:center;
      gap: 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(0,0,0,.12);
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(122,167,255,.8);
      box-shadow: 0 0 0 4px rgba(122,167,255,.18);
      flex: 0 0 auto;
    }
    .status.ok .dot{background: rgba(43,231,164,.9); box-shadow: 0 0 0 4px rgba(43,231,164,.18)}
    .status.err .dot{background: rgba(255,91,123,.95); box-shadow: 0 0 0 4px rgba(255,91,123,.18)}
    .status.warn .dot{background: rgba(255,209,102,.95); box-shadow: 0 0 0 4px rgba(255,209,102,.18)}
    .spinner{
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.9);
      animation: spin .8s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin{to{transform: rotate(360deg)}}

    /* Game panel */
    .game{
      flex: 1 1 auto;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      position:relative;
    }
    .g-body{
      flex:1;
      padding: 14px;
      min-height:0;
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
    }
    .panel{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.12);
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panel .p-head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .panel .p-head h3{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .panel .p-body{
      padding: 14px;
      overflow:auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .panel .p-body::-webkit-scrollbar{width:10px}
    .panel .p-body::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.0);
      background-clip: padding-box;
    }

    /* Wheel */
    .wheelWrap{
      display:grid;
      place-items:center;
      gap: 12px;
    }
    .wheelStage{
      position: relative;
      width: min(420px, 100%);
      aspect-ratio: 1/1;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    canvas#wheel{
      width: 100%;
      height: 100%;
      display:block;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.30));
    }
    .pointer{
      position:absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 22px solid rgba(255,255,255,.92);
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.35));
    }
    .hub{
      position:absolute;
      inset: 50% auto auto 50%;
      transform: translate(-50%,-50%);
      width: 92px;
      height: 92px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: radial-gradient(circle at 30% 30%, rgba(109,125,255,.35), rgba(0,0,0,.25));
      display:grid;
      place-items:center;
      box-shadow: 0 16px 30px rgba(0,0,0,.35);
    }
    .hub button{
      width: 68px;
      height: 68px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--fg);
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.2px;
      display:grid;
      place-items:center;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .hub button:hover{background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22)}
    .hub button:active{transform: scale(.98)}
    .hub button:focus-visible{
      outline: 3px solid rgba(109,125,255,.55);
      outline-offset: 2px;
    }

    .wheelActions{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    /* Q display / answers */
    .qTitle{
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.2px;
      margin: 0;
    }
    .qMeta{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }
    .qCard{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.06);
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }

    .options{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    .opt{
      display:flex;
      align-items:flex-start;
      gap: 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.10);
      padding: 12px 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      min-height: var(--tap);
    }
    .opt:hover{background: rgba(255,255,255,.08); border-color: var(--line2)}
    .opt:active{transform: translateY(1px) scale(.99)}
    .opt[aria-disabled="true"]{opacity:.6; cursor:not-allowed}
    .opt:focus-visible{
      outline: 3px solid rgba(109,125,255,.55);
      outline-offset: 2px;
    }
    .opt .idx{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:grid;
      place-items:center;
      font-weight: 900;
      flex: 0 0 auto;
    }
    .opt .txt{
      flex: 1 1 auto;
      font-size: 13px;
      line-height: 1.35;
      color: var(--fg);
    }
    .opt.selected{
      border-color: rgba(109,125,255,.55);
      background: rgba(109,125,255,.10);
    }
    .opt.correct{
      border-color: rgba(43,231,164,.55);
      background: rgba(43,231,164,.12);
    }
    .opt.wrong{
      border-color: rgba(255,91,123,.55);
      background: rgba(255,91,123,.12);
    }

    .feedback{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.12);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      min-height: var(--tap);
    }
    .badge{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      user-select:none;
      min-height: var(--tap);
      font-size: 13px;
    }
    .badge.ok{border-color: rgba(43,231,164,.55)}
    .badge.bad{border-color: rgba(255,91,123,.55)}
    .badge.warn{border-color: rgba(255,209,102,.55)}
    .badge .big{font-weight: 900}
    .explain{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      padding: 10px 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      display:none;
    }

    /* History */
    .history{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .hItem{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.10);
      padding: 10px 12px;
      display:flex;
      align-items:flex-start;
      gap: 10px;
    }
    .hIcon{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .hText{
      flex: 1 1 auto;
      min-width:0;
    }
    .hText b{
      display:block;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hText span{
      display:block;
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
      line-height:1.3;
    }

    /* Overlay pause */
    .overlay{
      position: absolute;
      inset: 0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index: 20;
      padding: 14px;
    }
    .overlay.show{display:grid}
    .modal{
      max-width: min(720px, 100%);
      width: 100%;
      border: 1px solid rgba(255,255,255,.16);
      border-radius: var(--radius);
      background: rgba(0,0,0,.45);
      box-shadow: var(--shadow2);
      padding: 14px;
    }
    .modal h2{margin:0 0 6px; font-size: 18px}
    .modal p{margin:0; color: var(--muted); line-height:1.45; font-size: 13px}
    .modal .actions{margin-top: 12px; display:flex; gap: 10px; justify-content:flex-end; flex-wrap:wrap}

    .toast{
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(8px);
      background: rgba(0,0,0,.52);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 999px;
      padding: 10px 12px;
      display:flex;
      gap: 10px;
      align-items:center;
      box-shadow: var(--shadow2);
      max-width: min(860px, calc(100vw - 24px));
      z-index: 50;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      color: var(--fg);
      font-size: 13px;
      backdrop-filter: blur(10px);
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(0)}

    .help{
      border-top: 1px solid var(--line);
      margin-top: 12px;
      padding-top: 12px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .help kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--fg);
    }

    @media (max-width: 980px){
      header{padding: 12px}
      main{
        height: calc(100% - 74px);
        flex-direction:column;
        padding: 12px;
        gap: 12px;
      }
      .teacher{width:100%; max-width:none; flex-basis:auto}
      .teacher.collapsed{width:100%; max-width:none; flex-basis:auto}
      .teacher.collapsed .t-title,
      .teacher.collapsed .t-body,
      .teacher.collapsed .t-foot{display:block}
      .teacher.collapsed .t-head{justify-content:space-between}
      .g-body{grid-template-columns: 1fr; }
      .progress{width: 140px}
      main{max-width: var(--maxw)}
      .wheelStage{width: min(380px, 100%)}
    }

    @media (prefers-reduced-motion: reduce){
      *{transition:none !important; animation:none !important; scroll-behavior:auto !important;}
    }
  </style>
</head>

<body>
  <!--
    SPIN THE WHEEL ‚Äî n8n Automation Basics (Offline Single HTML)
    ============================================================
    C√ÅCH CH·∫†Y:
    1) L∆∞u file th√†nh: spin-the-wheel-n8n.html
    2) M·ªü tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát (Chrome/Edge/Firefox) ‚Äî kh√¥ng c·∫ßn internet.
    3) (Tu·ª≥ ch·ªçn) Teacher Unlock ƒë·ªÉ ch·ªânh set/timer v√† export CSV.

    PH√çM T·∫ÆT:
    - Space: Next (sang c√¢u/ v√≤ng ti·∫øp theo sau khi ch·∫•m)
    - R: Reveal (Teacher) / Reveal ƒë√°p √°n
    - Esc: Pause/Resume
    - 1/2/3/4: ch·ªçn ƒë√°p √°n A/B/C/D (n·∫øu c√≥)

    CU·ªêI FILE c√≥ h∆∞·ªõng d·∫´n nhanh: ƒë·ªïi d·ªØ li·ªáu & c√°ch ch∆°i tr√™n l·ªõp.
  -->

  <header>
    <div class="brand" aria-label="Game header">
      <div class="logo" id="brandLogo" aria-hidden="true"></div>
      <div style="min-width:0">
        <h1 id="brandName">Spin the Wheel: n8n Automation Basics</h1>
        <p id="brandTagline">Quay v√≤ng ƒë·ªÉ ch·ªçn c√¢u h·ªèi / th·ª≠ th√°ch ‚Äî tr·∫£ l·ªùi nhanh ‚Äî ghi k·∫øt qu·∫£</p>
      </div>
    </div>

    <div class="topbar" aria-label="Header stats and actions">
      <div class="chip" aria-label="Timer">
        <span class="em" aria-hidden="true">‚è±Ô∏è</span>
        <span class="k">Time</span>
        <span class="v" id="kpiTime">--</span>
      </div>

      <div class="chip" aria-label="Score">
        <span class="em" aria-hidden="true">üèÜ</span>
        <span class="k">Score</span>
        <span class="v" id="kpiScore">0</span>
      </div>

      <div class="chip" aria-label="Progress">
        <span class="em" aria-hidden="true">üìå</span>
        <span class="k">Q</span>
        <span class="v" id="kpiProg">0/0</span>
      </div>

      <div class="progress" role="progressbar" aria-label="Progress bar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="bar" id="progressBar"></div>
      </div>

      <button class="iconbtn" id="btnReset" type="button" aria-label="Reset game" title="Reset">
        <span aria-hidden="true">üîÑ</span>
      </button>

      <button class="iconbtn" id="btnTeacher" type="button" aria-label="Teacher mode" title="Teacher Mode">
        <span aria-hidden="true">üßë‚Äçüè´</span>
      </button>

      <button class="iconbtn" id="btnDownload" type="button" aria-label="Download this HTML file" title="Download HTML">
        <span aria-hidden="true">‚¨áÔ∏è</span>
      </button>
    </div>
  </header>

  <main>
    <aside class="teacher" id="teacherPanel" aria-label="Teacher panel">
      <div class="t-head">
        <div class="t-title">
          <span aria-hidden="true">üßë‚Äçüè´</span>
          <h2>Teacher Mode</h2>
          <span class="pill" id="teacherPill">Locked</span>
        </div>
        <button class="iconbtn" id="btnCollapseTeacher" type="button" aria-label="Collapse teacher panel">
          <span aria-hidden="true">‚ü®‚ü®</span>
        </button>
      </div>

      <div class="t-body">
        <fieldset>
          <legend>Access</legend>
          <div class="row2">
            <button class="btn" id="btnUnlock" type="button" aria-label="Unlock teacher mode">
              üîí Unlock
            </button>
            <button class="btn ghost" id="btnLock" type="button" aria-label="Lock teacher mode" disabled>
              üîê Lock
            </button>
          </div>
          <div class="status warn" id="teacherStatus" role="status" aria-live="polite" style="margin-top:10px">
            <span class="dot" aria-hidden="true"></span>
            <span id="teacherStatusText">Teacher Mode ƒëang kh√≥a. Nh·∫•n Unlock ƒë·ªÉ c·∫•u h√¨nh.</span>
          </div>
        </fieldset>

        <fieldset>
          <legend>Game Control</legend>
          <label for="setSelect">Ch·ªçn b·ªô c√¢u h·ªèi</label>
          <select id="setSelect" aria-label="Question set select" disabled></select>

          <div class="row2">
            <div>
              <label for="timePerQ">‚è±Ô∏è Time / v√≤ng (gi√¢y)</label>
              <input id="timePerQ" type="number" min="20" max="120" step="1" value="40" aria-label="Time per round seconds" disabled />
            </div>
            <div>
              <label for="spinMin">üé° Spin (v√≤ng t·ªëi thi·ªÉu)</label>
              <input id="spinMin" type="number" min="3" max="10" step="1" value="4" aria-label="Minimum spins" disabled />
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <button class="btn primary" id="btnStart" type="button" aria-label="Start game" disabled>‚ñ∂Ô∏è Start</button>
            <button class="btn" id="btnNext" type="button" aria-label="Next round" disabled>‚è≠Ô∏è Next</button>
          </div>

          <div class="row2" style="margin-top:10px">
            <button class="btn danger" id="btnReveal" type="button" aria-label="Reveal answer" disabled>üëÅÔ∏è Reveal</button>
            <button class="btn" id="btnExport" type="button" aria-label="Export CSV" disabled>‚¨áÔ∏è Export CSV</button>
          </div>
        </fieldset>

        <fieldset>
          <legend>Edit Data (JSON)</legend>
          <label for="jsonEditor">D√°n/s·ª≠a CONFIG.questionSets (array)</label>
          <textarea id="jsonEditor" spellcheck="false" aria-label="JSON editor" disabled></textarea>
          <div class="row2" style="margin-top:10px">
            <button class="btn good" id="btnApplyJson" type="button" aria-label="Apply JSON" disabled>‚úÖ Apply</button>
            <button class="btn" id="btnExportJson" type="button" aria-label="Export JSON" disabled>‚¨ÜÔ∏è Export</button>
          </div>
          <p style="margin:10px 0 0;color:var(--muted);font-size:12px;line-height:1.35">
            Schema item: {"label":"...","question":"...","options":["A","B","C","D"],"correct":[0],"explain":"..."}
          </p>
        </fieldset>

        <div class="help">
          <div><b>Ph√≠m t·∫Øt:</b> <kbd>Space</kbd> Next ‚Ä¢ <kbd>R</kbd> Reveal ‚Ä¢ <kbd>Esc</kbd> Pause/Resume ‚Ä¢ <kbd>1</kbd>/<kbd>2</kbd>/<kbd>3</kbd>/<kbd>4</kbd> ch·ªçn ƒë√°p √°n</div>
        </div>
      </div>

      <div class="t-foot" style="padding:12px; border-top:1px solid var(--line); background:rgba(0,0,0,.10)">
        <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap">
          <div style="color:var(--muted); font-size:12px">
            Tip: Collapse Teacher panel ƒë·ªÉ t·ªëi ∆∞u m√°y chi·∫øu.
          </div>
          <button class="btn ghost" id="btnFullscreen" type="button" aria-label="Toggle browser fullscreen">‚õ∂ Fullscreen</button>
        </div>
      </div>
    </aside>

    <section class="game" aria-label="Game play area">
      <div class="g-body">
        <!-- Left: Wheel -->
        <div class="panel" aria-label="Wheel panel">
          <div class="p-head">
            <h3><span aria-hidden="true">üé°</span> Spin the Wheel</h3>
            <div class="badge" aria-label="Round status" id="roundBadge">
              <span aria-hidden="true">‚ö°</span>
              <span class="big" id="roundTitle">S·∫µn s√†ng</span>
              <span style="color:var(--muted)" id="roundSub">Nh·∫•n Start (Teacher) r·ªìi b·∫•m SPIN</span>
            </div>
          </div>
          <div class="p-body">
            <div class="wheelWrap">
              <div class="wheelStage" aria-label="Wheel stage">
                <div class="pointer" aria-hidden="true"></div>
                <canvas id="wheel" width="900" height="900" aria-label="Wheel canvas"></canvas>
                <div class="hub">
                  <button id="btnSpin" type="button" aria-label="Spin the wheel" title="Spin">SPIN</button>
                </div>
              </div>

              <div class="wheelActions">
                <button class="btn" id="btnPause" type="button" aria-label="Pause game">‚è∏ Pause</button>
                <button class="btn" id="btnMarkCorrect" type="button" aria-label="Mark correct">‚úÖ Correct</button>
                <button class="btn" id="btnMarkWrong" type="button" aria-label="Mark wrong">‚ùå Wrong</button>
              </div>

              <div class="feedback" aria-label="Feedback">
                <div class="badge warn" id="fbBadge">
                  <span aria-hidden="true" id="fbIcon">‚è±Ô∏è</span>
                  <span class="big" id="fbTitle">Ch∆∞a quay</span>
                  <span id="fbSub" style="color:var(--muted)">B·∫•m SPIN ƒë·ªÉ ch·ªçn c√¢u h·ªèi</span>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap">
                  <button class="btn ghost" id="btnDownloadCsv" type="button" aria-label="Export CSV quick">‚¨áÔ∏è CSV</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Question + History -->
        <div class="panel" aria-label="Question panel">
          <div class="p-head">
            <h3><span aria-hidden="true">üß©</span> C√¢u h·ªèi / Th·ª≠ th√°ch</h3>
            <div class="badge" aria-label="Set name">
              <span aria-hidden="true">üìö</span>
              <span class="big" id="setName">‚Äî</span>
            </div>
          </div>
          <div class="p-body">
            <div class="qCard" aria-label="Question card">
              <p class="qTitle" id="qTitle">‚Äî</p>
              <div class="qMeta" id="qMeta">
                <span>Lo·∫°i: <b id="qType">‚Äî</b></span>
                <span>ƒêi·ªÉm: <b id="qPoints">‚Äî</b></span>
                <span>Wheel: <b id="qLabel">‚Äî</b></span>
              </div>

              <div class="options" id="options" aria-label="Options"></div>

              <div class="explain" id="explain" aria-live="polite"></div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
                <button class="btn primary" id="btnSubmit" type="button" aria-label="Submit answer">üì® Submit</button>
                <button class="btn danger" id="btnRevealStudent" type="button" aria-label="Reveal answer">üëÅÔ∏è Reveal</button>
                <button class="btn" id="btnNextStudent" type="button" aria-label="Next round">‚è≠Ô∏è Next</button>
              </div>
            </div>

            <div class="history" aria-label="History">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
                <div style="color:var(--muted); font-size:12px">üìú L·ªãch s·ª≠ v√≤ng quay (m·ªõi nh·∫•t ·ªü tr√™n)</div>
                <button class="btn ghost" id="btnClearHistory" type="button" aria-label="Clear history">üßπ Clear</button>
              </div>
              <div id="historyList"></div>
            </div>

            <div class="help">
              <div><b>Flow g·ª£i √Ω:</b> Quay ‚Üí ƒë·ªçc c√¢u ‚Üí h·ªçc vi√™n ch·ªçn 1/2/3/4 ‚Üí Submit ‚Üí Correct/Wrong ‚Üí Next.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="overlay" id="pauseOverlay" aria-label="Pause overlay">
        <div class="modal" role="dialog" aria-modal="true" aria-label="Paused dialog">
          <h2>‚è∏ ƒêang t·∫°m d·ª´ng</h2>
          <p>Nh·∫•n <b>Esc</b> ho·∫∑c b·∫•m Resume ƒë·ªÉ ti·∫øp t·ª•c. (Timer s·∫Ω d·ª´ng l·∫°i.)</p>
          <div class="actions">
            <button class="btn" id="btnResume" type="button" aria-label="Resume">‚ñ∂Ô∏è Resume</button>
            <button class="btn danger" id="btnReveal2" type="button" aria-label="Reveal answer">üëÅÔ∏è Reveal</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span aria-hidden="true" id="toastIcon">‚ÑπÔ∏è</span>
    <span id="toastText">...</span>
  </div>

  <script>
    "use strict";

    /* =========================
       CONFIG (Teacher ch·ªânh nhanh)
       ========================= */
    const CONFIG = {
      topic: "·ª®ng d·ª•ng n8n t·ª± ƒë·ªông h√≥a c∆° b·∫£n",
      brand: { name: "Spin the Wheel: n8n Automation Basics", tagline: "Quay v√≤ng ƒë·ªÉ ch·ªçn c√¢u h·ªèi / th·ª≠ th√°ch ‚Äî tr·∫£ l·ªùi nhanh ‚Äî ghi k·∫øt qu·∫£" },
      teacher: {
        password: "n8n",
        allowJsonEdit: true
      },
      gameplay: {
        timePerRoundSec: 40,   // 20‚Äì40s ph√π h·ª£p l·ªõp
        scoreCorrect: 100,
        scoreWrong: -20,
        scoreNoAnswer: 0,
        spinMinTurns: 4,
        spinMaxTurns: 7,
        spinDurationMs: 4200,
        shuffle: true
      },
      // 10‚Äì20 c√¢u h·ªèi/keyword m·∫´u (demo). M·ªói item v·ª´a l√† "√¥" tr√™n wheel v·ª´a l√† 1 c√¢u h·ªèi.
      // type: "single" (1 ƒë√°p √°n ƒë√∫ng) / "multi" (nhi·ªÅu ƒë√°p √°n ƒë√∫ng)
      questionSets: [
        {
          id: "basics",
          name: "n8n Automation ‚Äî Core Concepts",
          items: [
            {
              label: "TRIGGER",
              question: "Trong n8n, Trigger d√πng ƒë·ªÉ l√†m g√¨?",
              type: "single",
              options: ["B·∫Øt ƒë·∫ßu workflow khi c√≥ s·ª± ki·ªán", "V·∫Ω bi·ªÉu ƒë·ªì d·ªØ li·ªáu", "TƒÉng t·ªëc Internet", "M√£ h√≥a m·∫≠t kh·∫©u"],
              correct: [0],
              explain: "Trigger l√† ƒëi·ªÉm kh·ªüi ƒë·∫ßu: Webhook, Cron, Manual, App events‚Ä¶",
              points: 100
            },
            {
              label: "WEBHOOK",
              question: "Webhook trong n8n ph√π h·ª£p nh·∫•t ƒë·ªÉ l√†m g√¨?",
              type: "single",
              options: ["Nh·∫≠n request t·ª´ h·ªá th·ªëng ngo√†i", "L∆∞u file video", "T·∫°o database", "T·∫Øt server"],
              correct: [0],
              explain: "Webhook nh·∫≠n HTTP request ‚Üí k√≠ch ho·∫°t lu·ªìng (form, chatbot, app).",
              points: 120
            },
            {
              label: "CRON",
              question: "Cron gi√∫p workflow ch·∫°y theo c∆° ch·∫ø n√†o?",
              type: "single",
              options: ["Theo l·ªãch th·ªùi gian", "Theo c·∫£m x√∫c", "Theo pin thi·∫øt b·ªã", "Theo s·ªë ng∆∞·ªùi d√πng"],
              correct: [0],
              explain: "Cron ch·∫°y ƒë·ªãnh k·ª≥ (m·ªói gi·ªù/m·ªói ng√†y‚Ä¶).",
              points: 90
            },
            {
              label: "HTTP REQUEST",
              question: "Node HTTP Request th∆∞·ªùng d√πng ƒë·ªÉ:",
              type: "single",
              options: ["G·ªçi API (GET/POST) l·∫•y/ƒë·∫©y d·ªØ li·ªáu", "Ch∆°i nh·∫°c", "T·∫°o slide", "Ch·∫°y game 3D"],
              correct: [0],
              explain: "HTTP Request l√† n·ªÅn t·∫£ng t√≠ch h·ª£p API trong n8n.",
              points: 120
            },
            {
              label: "CREDENTIALS",
              question: "Credentials trong n8n gi√∫p √≠ch g√¨?",
              type: "single",
              options: ["L∆∞u th√¥ng tin x√°c th·ª±c k·∫øt n·ªëi (token/key)", "TƒÉng FPS", "T·∫°o ·∫£nh AI", "X√≥a l·ªãch s·ª≠"],
              correct: [0],
              explain: "Qu·∫£n l√Ω auth an to√†n h∆°n hardcode trong node.",
              points: 110
            },
            {
              label: "IF",
              question: "IF node d√πng ƒë·ªÉ l√†m g√¨?",
              type: "single",
              options: ["R·∫Ω nh√°nh True/False theo ƒëi·ªÅu ki·ªán", "T·∫°o file PDF", "N√©n ·∫£nh", "T·∫£i driver"],
              correct: [0],
              explain: "IF chia lu·ªìng x·ª≠ l√Ω theo ƒëi·ªÅu ki·ªán.",
              points: 100
            },
            {
              label: "SET",
              question: "SET node th∆∞·ªùng d√πng ƒë·ªÉ:",
              type: "multi",
              options: ["T·∫°o field m·ªõi", "Ch·ªânh s·ª≠a d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i", "Map/ƒë·ªïi t√™n c·ªôt", "Ch·∫°y cron theo gi·ªù"],
              correct: [0,1,2],
              explain: "SET gi√∫p bi·∫øn ƒë·ªïi d·ªØ li·ªáu output (t·∫°o/ch·ªânh/map field).",
              points: 130
            },
            {
              label: "MERGE",
              question: "MERGE node d√πng ƒë·ªÉ:",
              type: "single",
              options: ["G·ªôp d·ªØ li·ªáu t·ª´ 2 nh√°nh", "T·∫°o user m·ªõi", "B·∫Øt l·ªói m·∫°ng", "M√£ h√≥a d·ªØ li·ªáu"],
              correct: [0],
              explain: "Merge k·∫øt h·ª£p d·ªØ li·ªáu theo nhi·ªÅu ch·∫ø ƒë·ªô (append/merge by key‚Ä¶).",
              points: 110
            },
            {
              label: "EXPRESSIONS",
              question: "Expressions {{ }} gi√∫p l√†m g√¨?",
              type: "multi",
              options: ["Tham chi·∫øu d·ªØ li·ªáu node tr∆∞·ªõc", "T√≠nh to√°n gi√° tr·ªã ƒë·ªông", "Map field linh ho·∫°t", "TƒÉng t·ªëc CPU"],
              correct: [0,1,2],
              explain: "Expressions l√† ‚Äúkeo d√°n‚Äù data ƒë·ªông gi·ªØa c√°c node.",
              points: 140
            },
            {
              label: "ITEMS",
              question: "Trong n8n, ‚Äúitems‚Äù th∆∞·ªùng l√†:",
              type: "single",
              options: ["Danh s√°ch record JSON (m·ªói item l√† 1 record)", "File .exe", "M·ªôt lo·∫°i database", "M·ªôt API gateway"],
              correct: [0],
              explain: "n8n x·ª≠ l√Ω m·∫£ng items, m·ªói item ƒë·∫°i di·ªán 1 record.",
              points: 120
            },
            {
              label: "ERROR HANDLING",
              question: "Khi workflow l·ªói, c√°ch l√†m ƒë√∫ng l√†:",
              type: "multi",
              options: ["Ghi log (Executions)", "Thi·∫øt l·∫≠p error workflow/notify", "Retry/backoff khi g·ªçi API", "B·ªè qua kh√¥ng c·∫ßn x·ª≠ l√Ω"],
              correct: [0,1,2],
              explain: "Quan tr·ªçng: log + th√¥ng b√°o + retry h·ª£p l√Ω ƒë·ªÉ ·ªïn ƒë·ªãnh.",
              points: 150
            },
            {
              label: "RATE LIMIT",
              question: "Rate limit l√† g√¨?",
              type: "single",
              options: ["Gi·ªõi h·∫°n s·ªë request API trong 1 kho·∫£ng th·ªùi gian", "T·ªëc ƒë·ªô wifi", "S·ªë l∆∞·ª£ng node t·ªëi ƒëa", "Dung l∆∞·ª£ng RAM"],
              correct: [0],
              explain: "G·∫∑p rate limit: delay/retry/batch.",
              points: 110
            },
            {
              label: "PAGINATION",
              question: "Pagination c·∫ßn khi:",
              type: "single",
              options: ["API tr·∫£ d·ªØ li·ªáu theo t·ª´ng trang (page)", "B·∫°n mu·ªën ƒë·ªïi giao di·ªán", "B·∫°n mu·ªën ƒë·ªïi password", "B·∫°n mu·ªën tƒÉng score"],
              correct: [0],
              explain: "X·ª≠ l√Ω pagination th∆∞·ªùng d√πng loop / SplitInBatches.",
              points: 120
            },
            {
              label: "SPLIT IN BATCHES",
              question: "Split in Batches h·ªØu √≠ch nh·∫•t khi:",
              type: "multi",
              options: ["X·ª≠ l√Ω danh s√°ch l·ªõn t·ª´ng ph·∫ßn", "Gi·∫£m r·ªßi ro rate limit", "L√†m pagination API", "T·∫°o bi·ªÉu ƒë·ªì"],
              correct: [0,1,2],
              explain: "Batching gi√∫p ·ªïn ƒë·ªãnh v√† ki·ªÉm so√°t t·ªëc ƒë·ªô x·ª≠ l√Ω.",
              points: 140
            },
            {
              label: "CHALLENGE",
              question: "Th·ª≠ th√°ch: H√£y n√™u 1 v√≠ d·ª• workflow n8n b·∫°n mu·ªën √°p d·ª•ng trong c√¥ng vi·ªác (30 gi√¢y).",
              type: "single",
              options: ["OK ‚Äî chia s·∫ª v√≠ d·ª•", "Pass", "Ch∆∞a nghƒ© ra", "Kh√¥ng li√™n quan"],
              correct: [0],
              explain: "M·ª•c ti√™u: li√™n h·ªá th·ª±c t·∫ø, kh√¥ng c·∫ßn ƒë√∫ng/sai qu√° g·∫Øt.",
              points: 100
            }
          ]
        }
      ],
      assets: {
        logoSvg:
          '<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">' +
          '<defs><linearGradient id="g" x1="2" y1="2" x2="26" y2="26" gradientUnits="userSpaceOnUse">' +
          '<stop stop-color="#6D7DFF"/><stop offset="1" stop-color="#2BE7A4"/></linearGradient></defs>' +
          '<rect x="3" y="3" width="22" height="22" rx="8" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.16)"/>' +
          '<path d="M9 16c2.2-5 7.8-5 10 0" stroke="url(#g)" stroke-width="2.6" stroke-linecap="round"/>' +
          '<circle cx="11" cy="11" r="1.2" fill="rgba(255,255,255,0.85)"/>' +
          '<circle cx="17" cy="11" r="1.2" fill="rgba(255,255,255,0.85)"/>' +
          '</svg>'
      },
      ui: { toastMs: 1700 }
    };

    /* =========================
       Helpers
       ========================= */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
    const nowMs = ()=> (performance && performance.now) ? performance.now() : Date.now();

    function csvEscape(v){
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    }

    function escapeHtml(s){
      const d = document.createElement("div");
      d.textContent = String(s ?? "");
      return d.innerHTML;
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
    }

    /* =========================
       State
       ========================= */
    const state = {
      teacherUnlocked: false,
      teacherCollapsed: false,
      setId: CONFIG.questionSets[0]?.id || "",
      items: [],
      order: [],
      idx: 0,
      score: 0,
      paused: false,
      started: false,

      // round
      current: null,           // selected item
      selectedIdxs: new Set(), // selected answers
      revealed: false,
      marked: null,            // "correct"|"wrong"|null

      // wheel physics
      spinning: false,
      angle: 0,        // radians
      targetAngle: 0,  // radians
      spinStartMs: 0,
      spinDurationMs: CONFIG.gameplay.spinDurationMs,

      // timer
      timer: { running:false, durationSec: CONFIG.gameplay.timePerRoundSec, endAtMs:0, raf:0 },

      // history/results
      history: [],
      results: []
    };

    /* =========================
       Elements
       ========================= */
    const els = {
      brandLogo: $("#brandLogo"),
      brandName: $("#brandName"),
      brandTagline: $("#brandTagline"),

      kpiTime: $("#kpiTime"),
      kpiScore: $("#kpiScore"),
      kpiProg: $("#kpiProg"),
      progressBar: $("#progressBar"),
      progressWrap: $(".progress"),

      btnReset: $("#btnReset"),
      btnTeacher: $("#btnTeacher"),
      btnDownload: $("#btnDownload"),

      teacherPanel: $("#teacherPanel"),
      btnCollapseTeacher: $("#btnCollapseTeacher"),
      teacherPill: $("#teacherPill"),
      teacherStatus: $("#teacherStatus"),
      teacherStatusText: $("#teacherStatusText"),
      btnUnlock: $("#btnUnlock"),
      btnLock: $("#btnLock"),
      setSelect: $("#setSelect"),
      timePerQ: $("#timePerQ"),
      spinMin: $("#spinMin"),
      btnStart: $("#btnStart"),
      btnNext: $("#btnNext"),
      btnReveal: $("#btnReveal"),
      btnExport: $("#btnExport"),
      jsonEditor: $("#jsonEditor"),
      btnApplyJson: $("#btnApplyJson"),
      btnExportJson: $("#btnExportJson"),
      btnFullscreen: $("#btnFullscreen"),

      btnSpin: $("#btnSpin"),
      btnPause: $("#btnPause"),
      btnMarkCorrect: $("#btnMarkCorrect"),
      btnMarkWrong: $("#btnMarkWrong"),
      roundTitle: $("#roundTitle"),
      roundSub: $("#roundSub"),
      roundBadge: $("#roundBadge"),

      fbBadge: $("#fbBadge"),
      fbIcon: $("#fbIcon"),
      fbTitle: $("#fbTitle"),
      fbSub: $("#fbSub"),
      btnDownloadCsv: $("#btnDownloadCsv"),

      setName: $("#setName"),
      qTitle: $("#qTitle"),
      qType: $("#qType"),
      qPoints: $("#qPoints"),
      qLabel: $("#qLabel"),
      options: $("#options"),
      explain: $("#explain"),
      btnSubmit: $("#btnSubmit"),
      btnRevealStudent: $("#btnRevealStudent"),
      btnNextStudent: $("#btnNextStudent"),

      historyList: $("#historyList"),
      btnClearHistory: $("#btnClearHistory"),

      pauseOverlay: $("#pauseOverlay"),
      btnResume: $("#btnResume"),
      btnReveal2: $("#btnReveal2"),

      toast: $("#toast"),
      toastIcon: $("#toastIcon"),
      toastText: $("#toastText"),

      wheel: $("#wheel")
    };

    /* =========================
       Toast / Status
       ========================= */
    let toastT = 0;
    function toast(msg, icon="‚ÑπÔ∏è"){
      els.toastIcon.textContent = icon;
      els.toastText.textContent = msg;
      els.toast.classList.add("show");
      clearTimeout(toastT);
      toastT = setTimeout(()=> els.toast.classList.remove("show"), CONFIG.ui.toastMs);
    }

    function setTeacherStatus(type, text, loading=false){
      els.teacherStatus.classList.remove("ok","err","warn");
      if(type) els.teacherStatus.classList.add(type);
      const dot = els.teacherStatus.querySelector(".dot");
      const oldSpinner = els.teacherStatus.querySelector(".spinner");
      if(oldSpinner) oldSpinner.remove();
      if(loading){
        const sp = document.createElement("span");
        sp.className = "spinner";
        sp.setAttribute("aria-hidden","true");
        dot.insertAdjacentElement("afterend", sp);
      }
      els.teacherStatusText.textContent = text;
    }

    function setRoundBadge(title, sub, icon="‚ö°"){
      els.roundTitle.textContent = title;
      els.roundSub.textContent = sub || "";
      const iconSpan = els.roundBadge.querySelector("span[aria-hidden='true']");
      if(iconSpan) iconSpan.textContent = icon;
    }

    function setFeedback(kind, title, sub, icon){
      els.fbBadge.classList.remove("ok","bad","warn");
      if(kind) els.fbBadge.classList.add(kind);
      els.fbTitle.textContent = title;
      els.fbSub.textContent = sub || "";
      els.fbIcon.textContent = icon || "‚ö°";
    }

    /* =========================
       Timer
       ========================= */
    function stopTimer(){
      state.timer.running = false;
      if(state.timer.raf) cancelAnimationFrame(state.timer.raf);
      state.timer.raf = 0;
    }

    function setTimerUI(secLeft){
      els.kpiTime.textContent = secLeft <= 0 ? "0s" : `${secLeft}s`;
      const danger = secLeft <= Math.max(6, Math.floor(state.timer.durationSec * 0.22));
      els.progressBar.classList.toggle("danger", danger && state.started && !state.revealed);
    }

    function startTimer(){
      stopTimer();
      state.timer.durationSec = clamp(Number(CONFIG.gameplay.timePerRoundSec), 20, 120);
      state.timer.endAtMs = nowMs() + state.timer.durationSec * 1000;
      state.timer.running = true;

      const tick = ()=>{
        if(!state.timer.running) return;
        if(state.paused){ state.timer.raf = requestAnimationFrame(tick); return; }

        const leftMs = state.timer.endAtMs - nowMs();
        const leftSec = Math.ceil(leftMs / 1000);
        setTimerUI(Math.max(0, leftSec));

        if(leftMs <= 0){
          stopTimer();
          if(state.started && !state.revealed){
            // timeout => auto reveal
            revealAnswer("H·∫øt gi·ªù!");
            setFeedback("warn","‚è±Ô∏è H·∫øt gi·ªù", "ƒê√£ t·ª± ƒë·ªông Reveal. Space ƒë·ªÉ Next.", "‚è±Ô∏è");
          }
          return;
        }
        state.timer.raf = requestAnimationFrame(tick);
      };
      state.timer.raf = requestAnimationFrame(tick);
    }

    function timeUsedSec(){
      const leftMs = state.timer.endAtMs - nowMs();
      const left = clamp(Math.ceil(leftMs / 1000), 0, state.timer.durationSec);
      return clamp(state.timer.durationSec - left, 0, state.timer.durationSec);
    }

    function pauseToggle(force){
      const want = typeof force === "boolean" ? force : !state.paused;
      state.paused = want;
      els.pauseOverlay.classList.toggle("show", state.paused);
      if(state.paused){
        toast("Paused", "‚è∏");
        setRoundBadge("Paused", "Nh·∫•n Esc ho·∫∑c Resume ƒë·ªÉ ti·∫øp t·ª•c", "‚è∏");
      }else{
        toast("Resumed", "‚ñ∂Ô∏è");
        setRoundBadge("ƒêang ch∆°i", "Quay v√≤ng ho·∫∑c ch·ªçn ƒë√°p √°n", "‚ö°");
      }
    }

    /* =========================
       Sets / Progress
       ========================= */
    function applyBrand(){
      els.brandLogo.innerHTML = CONFIG.assets.logoSvg;
      els.brandName.textContent = CONFIG.brand.name;
      els.brandTagline.textContent = CONFIG.brand.tagline;
      document.title = CONFIG.brand.name + " ‚Äî Offline";
    }

    function getSetById(id){
      return CONFIG.questionSets.find(s => s.id === id) || CONFIG.questionSets[0];
    }

    function loadSet(id){
      const set = getSetById(id);
      state.setId = set.id;
      state.items = (set.items || []).map(it => ({
        label: String(it.label || "").trim() || "ITEM",
        question: String(it.question || "").trim() || "‚Äî",
        type: (it.type === "multi" ? "multi" : "single"),
        options: Array.isArray(it.options) ? it.options.map(x=>String(x)) : [],
        correct: Array.isArray(it.correct) ? it.correct.map(n=>Number(n)) : [],
        explain: String(it.explain || ""),
        points: Number(it.points || 100)
      }));
      state.order = state.items.map((_,i)=>i);
      if(CONFIG.gameplay.shuffle) shuffle(state.order);
      state.idx = 0;

      state.current = null;
      state.selectedIdxs = new Set();
      state.revealed = false;
      state.marked = null;
      state.spinning = false;

      els.setName.textContent = set.name || set.id;
      els.jsonEditor.value = JSON.stringify(CONFIG.questionSets, null, 2);

      updateHeader();
      drawWheel();
      clearQuestionUI();
      setRoundBadge("S·∫µn s√†ng", "Nh·∫•n Start (Teacher) r·ªìi b·∫•m SPIN", "‚ö°");
      setFeedback("warn","Ch∆∞a quay","B·∫•m SPIN ƒë·ªÉ ch·ªçn c√¢u h·ªèi","üé°");
      setTimerUI(CONFIG.gameplay.timePerRoundSec);
    }

    function updateHeader(){
      els.kpiScore.textContent = String(state.score);
      const total = state.order.length || 0;
      const current = total ? clamp(state.idx + (state.started ? 1 : 0), 0, total) : 0;
      els.kpiProg.textContent = `${current}/${total}`;
      const pct = total ? Math.round((state.started ? state.idx : 0) / total * 100) : 0;
      els.progressWrap.setAttribute("aria-valuenow", String(pct));
      els.progressBar.style.width = `${pct}%`;
    }

    /* =========================
       Wheel drawing & spin
       ========================= */
    function getWheelPalette(n){
      // deterministic neon-ish palette without hardcoding per segment
      const out = [];
      for(let i=0;i<n;i++){
        const hue = (220 + i * (360 / Math.max(6,n))) % 360;
        out.push({h: hue, s: 75, l: 55});
      }
      return out;
    }

    function drawWheel(){
      const canvas = els.wheel;
      const ctx = canvas.getContext("2d");
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      const items = state.items;
      const n = items.length || 1;
      const cx = W/2, cy = H/2;
      const r = Math.min(W,H)*0.46;

      // subtle bg ring
      ctx.save();
      ctx.translate(cx,cy);
      ctx.beginPath();
      ctx.arc(0,0,r*1.02,0,Math.PI*2);
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = r*0.04;
      ctx.stroke();
      ctx.restore();

      const palette = getWheelPalette(n);
      const slice = (Math.PI*2)/n;

      // rotate by state.angle so pointer at top hits selected segment
      const angle = state.angle;

      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate(angle);

      for(let i=0;i<n;i++){
        const a0 = i*slice;
        const a1 = a0 + slice;

        // segment
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,r,a0,a1);
        ctx.closePath();

        // gradient
        const col = palette[i];
        const g = ctx.createRadialGradient(-r*0.2,-r*0.2,r*0.2, 0,0,r);
        g.addColorStop(0, `hsla(${col.h},${col.s}%,${col.l+8}%,0.95)`);
        g.addColorStop(1, `hsla(${col.h},${col.s}%,${col.l-8}%,0.85)`);
        ctx.fillStyle = g;
        ctx.fill();

        // divider line
        ctx.strokeStyle = "rgba(255,255,255,0.14)";
        ctx.lineWidth = 2;
        ctx.stroke();

        // label
        const mid = (a0+a1)/2;
        ctx.save();
        ctx.rotate(mid);
        ctx.translate(r*0.64, 0);
        ctx.rotate(Math.PI/2);
        ctx.fillStyle = "rgba(255,255,255,0.92)";
        ctx.font = "900 30px ui-sans-serif, system-ui, -apple-system, Segoe UI";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        const text = items[i]?.label || ("ITEM " + (i+1));
        ctx.fillText(trimText(ctx, text, 16), 0, 0);
        ctx.restore();
      }

      // center cutout ring
      ctx.beginPath();
      ctx.arc(0,0,r*0.18,0,Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,0.16)";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.restore();
    }

    function trimText(ctx, text, maxChars){
      const s = String(text||"");
      if(s.length <= maxChars) return s;
      return s.slice(0, Math.max(0,maxChars-1)) + "‚Ä¶";
    }

    function pointerIndexFromAngle(){
      // pointer at top ( -90deg ) in canvas coords
      // we rotate wheel by state.angle, so segment at pointer is computed accordingly.
      const n = state.items.length || 1;
      const slice = (Math.PI*2)/n;

      // pointer absolute angle in wheel-rotated space: at -90deg
      // effective angle to map: (-pi/2 - state.angle) normalized to [0,2pi)
      let a = (-Math.PI/2 - state.angle) % (Math.PI*2);
      if(a < 0) a += Math.PI*2;
      const idx = Math.floor(a / slice);
      return clamp(idx, 0, n-1);
    }

    function spin(){
      if(!state.started){
        toast("Teacher: nh·∫•n Start tr∆∞·ªõc.", "üßë‚Äçüè´");
        return;
      }
      if(state.spinning) return;
      if(state.paused) return;

      // must finish current round first? allow re-spin only if no current or revealed/marked
      if(state.current && !state.revealed){
        toast("H√£y Submit/Reveal v√≤ng hi·ªán t·∫°i tr∆∞·ªõc.", "‚ö†Ô∏è");
        return;
      }

      // choose target segment by selecting next unused (or cycle)
      const n = state.items.length;
      if(n === 0){
        toast("Set r·ªóng.", "‚ö†Ô∏è");
        return;
      }

      // compute a random target index among remaining order
      const remaining = state.order.slice(state.idx); // remaining in session
      const pickIndex = remaining.length ? remaining[Math.floor(Math.random()*remaining.length)] : state.order[Math.floor(Math.random()*state.order.length)];
      const targetSegment = pickIndex; // this is index in items

      // compute target angle so that targetSegment lands at pointer (top)
      // We want pointerIndexFromAngle() == targetSegment at end.
      // pointerIndex uses (-pi/2 - angle). Solve:
      // targetSegment * slice <= (-pi/2 - angle mod 2pi) < (targetSegment+1)*slice
      // pick center of segment:
      const slice = (Math.PI*2)/n;
      const center = (targetSegment + 0.5) * slice;
      // We need (-pi/2 - angle) mod 2pi = center
      // => angle = -pi/2 - center (mod 2pi)
      let desired = (-Math.PI/2 - center);
      // normalize close to current with additional spins
      const minTurns = clamp(Number(CONFIG.gameplay.spinMinTurns), 1, 12);
      const maxTurns = clamp(Number(CONFIG.gameplay.spinMaxTurns), minTurns, 14);
      const turns = Math.floor(Math.random() * (maxTurns - minTurns + 1)) + minTurns;
      desired += turns * Math.PI*2;

      state.spinning = true;
      state.spinStartMs = nowMs();
      state.spinDurationMs = clamp(Number(CONFIG.gameplay.spinDurationMs), 1800, 8000);
      state.startAngle = state.angle;
      state.targetAngle = desired;

      // reset round UI
      state.current = null;
      state.selectedIdxs = new Set();
      state.revealed = false;
      state.marked = null;
      clearQuestionUI();
      setRoundBadge("ƒêang quay‚Ä¶", "Ch·ªù v√≤ng quay d·ª´ng", "üé°");
      setFeedback("warn","üé° ƒêang quay","Chu·∫©n b·ªã c√¢u h·ªèi‚Ä¶","üé°");

      animateSpin();
    }

    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

    function animateSpin(){
      const tick = ()=>{
        if(!state.spinning) return;
        if(state.paused){ requestAnimationFrame(tick); return; }

        const t = (nowMs() - state.spinStartMs) / state.spinDurationMs;
        const p = clamp(t, 0, 1);
        const e = easeOutCubic(p);
        state.angle = lerp(state.startAngle, state.targetAngle, e);

        drawWheel();

        if(p >= 1){
          state.spinning = false;
          // settle angle (reduce huge value)
          state.angle = state.angle % (Math.PI*2);
          drawWheel();

          // determine selected segment
          const seg = pointerIndexFromAngle();
          selectItem(seg);
          toast("ƒê√£ ch·ªçn: " + state.items[seg].label, "üéØ");
          return;
        }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }

    function lerp(a,b,t){ return a + (b-a)*t; }

    /* =========================
       Round / Question logic
       ========================= */
    function startGame(){
      if(state.items.length === 0){
        toast("Kh√¥ng c√≥ c√¢u h·ªèi trong set.", "‚ö†Ô∏è");
        return;
      }
      state.started = true;
      state.score = 0;
      state.results = [];
      state.history = [];
      renderHistory();
      state.idx = 0;
      if(CONFIG.gameplay.shuffle) shuffle(state.order);

      setRoundBadge("ƒêang ch∆°i", "B·∫•m SPIN ƒë·ªÉ ch·ªçn c√¢u h·ªèi", "‚ö°");
      setFeedback("warn","Ch∆∞a quay","B·∫•m SPIN ƒë·ªÉ ch·ªçn c√¢u h·ªèi","üé°");
      updateHeader();
      drawWheel();
      setTimerUI(CONFIG.gameplay.timePerRoundSec);
    }

    function selectItem(itemIdx){
      state.current = { ...state.items[itemIdx], itemIdx };
      state.selectedIdxs = new Set();
      state.revealed = false;
      state.marked = null;

      // progress: consume this question from remaining order if present
      const posInRemaining = state.order.indexOf(itemIdx, state.idx);
      if(posInRemaining >= state.idx){
        // swap to current idx to mark consumed
        const tmp = state.order[state.idx];
        state.order[state.idx] = itemIdx;
        state.order[posInRemaining] = tmp;
      }

      // show UI
      renderQuestion();
      startTimer();
      setRoundBadge("ƒê√£ ch·ªçn", "Tr·∫£ l·ªùi trong th·ªùi gian", "üéØ");
      setFeedback("warn","üéØ ƒê√£ ch·ªçn", "Ch·ªçn ƒë√°p √°n 1/2/3/4 r·ªìi Submit", "üéØ");
    }

    function clearQuestionUI(){
      els.qTitle.textContent = "‚Äî";
      els.qType.textContent = "‚Äî";
      els.qPoints.textContent = "‚Äî";
      els.qLabel.textContent = "‚Äî";
      els.options.innerHTML = "";
      els.explain.style.display = "none";
      els.explain.textContent = "";
      els.btnSubmit.disabled = true;
      els.btnRevealStudent.disabled = true;
      els.btnNextStudent.disabled = true;
      disableMarkButtons(true);
    }

    function renderQuestion(){
      const q = state.current;
      if(!q){ clearQuestionUI(); return; }

      els.qTitle.textContent = q.question || "‚Äî";
      els.qType.textContent = q.type === "multi" ? "Multiple" : "Single";
      els.qPoints.textContent = String(q.points || 0);
      els.qLabel.textContent = q.label || "‚Äî";

      els.options.innerHTML = "";
      const letters = ["1","2","3","4","5","6"];
      q.options.forEach((opt, i)=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "opt";
        btn.setAttribute("data-idx", String(i));
        btn.setAttribute("aria-label", `Option ${i+1}`);
        btn.innerHTML = `<div class="idx">${letters[i] || (i+1)}</div><div class="txt">${escapeHtml(opt)}</div>`;
        btn.addEventListener("click", ()=> toggleOption(i));
        els.options.appendChild(btn);
      });

      els.btnSubmit.disabled = false;
      els.btnRevealStudent.disabled = false;
      els.btnNextStudent.disabled = false;
      disableMarkButtons(false);
      state.revealed = false;
      state.marked = null;

      els.explain.style.display = "none";
      els.explain.textContent = "";
    }

    function toggleOption(i){
      if(!state.current) return;
      if(state.paused) return;
      if(state.revealed) return;

      if(state.current.type === "single"){
        state.selectedIdxs = new Set([i]);
      }else{
        if(state.selectedIdxs.has(i)) state.selectedIdxs.delete(i);
        else state.selectedIdxs.add(i);
      }
      updateOptionUI();
    }

    function updateOptionUI(){
      $$(".opt", els.options).forEach(el=>{
        const i = Number(el.getAttribute("data-idx"));
        el.classList.toggle("selected", state.selectedIdxs.has(i));
      });
    }

    function arraysEqualAsSet(a, setB){
      const setA = new Set(a);
      if(setA.size !== setB.size) return false;
      for(const x of setA) if(!setB.has(x)) return false;
      return true;
    }

    function submitAnswer(){
      if(!state.current) return;
      if(state.revealed) return;
      stopTimer();

      const picked = state.selectedIdxs;
      const correctSet = new Set(state.current.correct || []);
      const ok = arraysEqualAsSet(state.current.correct || [], picked);

      revealAnswer(ok ? "ƒê√∫ng!" : "Sai!", ok);
      if(ok){
        const add = Number(state.current.points || CONFIG.gameplay.scoreCorrect || 100);
        state.score += add;
        setFeedback("ok","‚úÖ ƒê√∫ng", `+${add} ƒëi·ªÉm ‚Ä¢ Space ƒë·ªÉ Next`, "‚úÖ");
        setRoundBadge("‚úÖ Correct", "Space/Next ƒë·ªÉ ti·∫øp t·ª•c", "‚úÖ");
        state.marked = "correct";
      }else{
        state.score += Number(CONFIG.gameplay.scoreWrong || -20);
        setFeedback("bad","‚ùå Sai", `${CONFIG.gameplay.scoreWrong} ƒëi·ªÉm ‚Ä¢ Space ƒë·ªÉ Next`, "‚ùå");
        setRoundBadge("‚ùå Wrong", "Space/Next ƒë·ªÉ ti·∫øp t·ª•c", "‚ùå");
        state.marked = "wrong";
      }

      updateHeader();
      recordResult(ok ? "correct" : "wrong");
      addHistoryItem(ok ? "‚úÖ" : "‚ùå", state.current.label, state.current.question);
      state.idx = clamp(state.idx + 1, 0, state.order.length);
      updateHeader();
    }

    function revealAnswer(reason="Reveal", ok=null){
      if(!state.current) return;
      state.revealed = true;

      // mark correct/wrong options visually
      const correctSet = new Set(state.current.correct || []);
      $$(".opt", els.options).forEach(el=>{
        const i = Number(el.getAttribute("data-idx"));
        el.classList.remove("selected");
        el.setAttribute("aria-disabled","true");
        el.disabled = true;
        if(correctSet.has(i)) el.classList.add("correct");
        else if(state.selectedIdxs.has(i)) el.classList.add("wrong");
      });

      els.explain.style.display = "block";
      const exp = state.current.explain ? state.current.explain : "Gi·∫£i th√≠ch: (kh√¥ng c√≥)";
      const picked = Array.from(state.selectedIdxs).map(i=>i+1).join(", ") || "‚Äî";
      const correct = (state.current.correct||[]).map(i=>i+1).join(", ") || "‚Äî";
      const head = ok === true ? "‚úÖ ƒê√∫ng!" : ok === false ? "‚ùå Sai!" : "üëÅÔ∏è Reveal";
      els.explain.innerHTML = `<b>${escapeHtml(head)}</b> ‚Ä¢ B·∫°n ch·ªçn: <b>${escapeHtml(picked)}</b> ‚Ä¢ ƒê√°p √°n: <b>${escapeHtml(correct)}</b><br>${escapeHtml(exp)}`;

      if(ok === null){
        setFeedback("warn","üëÅÔ∏è Reveal", reason + " ‚Ä¢ Space ƒë·ªÉ Next", "üëÅÔ∏è");
        setRoundBadge("üëÅÔ∏è Reveal", "Space/Next ƒë·ªÉ ti·∫øp t·ª•c", "üëÅÔ∏è");
        recordResult("reveal");
        addHistoryItem("üëÅÔ∏è", state.current.label, state.current.question);
        state.idx = clamp(state.idx + 1, 0, state.order.length);
        updateHeader();
      }

      disableMarkButtons(true);
    }

    function disableMarkButtons(disabled){
      els.btnMarkCorrect.disabled = disabled;
      els.btnMarkWrong.disabled = disabled;
    }

    function nextRound(){
      if(!state.started){
        toast("Teacher: nh·∫•n Start tr∆∞·ªõc.", "üßë‚Äçüè´");
        return;
      }
      if(state.spinning) return;

      if(state.idx >= state.order.length){
        stopTimer();
        setRoundBadge("K·∫øt th√∫c", "ƒê√£ h·∫øt c√¢u h·ªèi. Export CSV ƒë·ªÉ l∆∞u.", "üèÅ");
        setFeedback("ok","üèÅ K·∫øt th√∫c", "Export CSV ƒë·ªÉ l∆∞u k·∫øt qu·∫£", "üèÅ");
        toast("H·∫øt c√¢u h·ªèi!", "üèÅ");
        return;
      }

      // clear current to allow spin
      state.current = null;
      state.selectedIdxs = new Set();
      state.revealed = false;
      state.marked = null;

      clearQuestionUI();
      stopTimer();
      setTimerUI(CONFIG.gameplay.timePerRoundSec);
      setRoundBadge("ƒêang ch∆°i", "B·∫•m SPIN ƒë·ªÉ ch·ªçn c√¢u h·ªèi ti·∫øp theo", "‚ö°");
      setFeedback("warn","Ch∆∞a quay","B·∫•m SPIN ƒë·ªÉ ch·ªçn c√¢u h·ªèi","üé°");
    }

    function markCorrectWrong(type){
      // Manual override (teacher)
      if(!state.current || state.revealed) return;
      stopTimer();

      if(type === "correct"){
        const add = Number(state.current.points || CONFIG.gameplay.scoreCorrect || 100);
        state.score += add;
        state.marked = "correct";
        setFeedback("ok","‚úÖ Teacher marked Correct", `+${add} ƒëi·ªÉm ‚Ä¢ Space ƒë·ªÉ Next`, "‚úÖ");
        setRoundBadge("‚úÖ Correct", "Space/Next ƒë·ªÉ ti·∫øp t·ª•c", "‚úÖ");
        recordResult("correct_manual");
        addHistoryItem("‚úÖ", state.current.label, state.current.question);
      }else{
        state.score += Number(CONFIG.gameplay.scoreWrong || -20);
        state.marked = "wrong";
        setFeedback("bad","‚ùå Teacher marked Wrong", `${CONFIG.gameplay.scoreWrong} ƒëi·ªÉm ‚Ä¢ Space ƒë·ªÉ Next`, "‚ùå");
        setRoundBadge("‚ùå Wrong", "Space/Next ƒë·ªÉ ti·∫øp t·ª•c", "‚ùå");
        recordResult("wrong_manual");
        addHistoryItem("‚ùå", state.current.label, state.current.question);
      }

      revealAnswer("Teacher mark", type === "correct");
      state.idx = clamp(state.idx + 1, 0, state.order.length);
      updateHeader();
    }

    /* =========================
       History & Results
       ========================= */
    function addHistoryItem(icon, label, question){
      state.history.unshift({ icon, label, question, ts: new Date().toLocaleTimeString() });
      if(state.history.length > 8) state.history.pop();
      renderHistory();
    }

    function renderHistory(){
      els.historyList.innerHTML = "";
      if(state.history.length === 0){
        const d = document.createElement("div");
        d.className = "hintbox";
        d.textContent = "Ch∆∞a c√≥ l·ªãch s·ª≠. B·∫•m SPIN ƒë·ªÉ b·∫Øt ƒë·∫ßu.";
        els.historyList.appendChild(d);
        return;
      }
      state.history.forEach(h=>{
        const div = document.createElement("div");
        div.className = "hItem";
        div.innerHTML = `
          <div class="hIcon" aria-hidden="true">${escapeHtml(h.icon)}</div>
          <div class="hText">
            <b>${escapeHtml(h.label)} <span style="color:var(--muted); font-weight:700">‚Ä¢ ${escapeHtml(h.ts)}</span></b>
            <span>${escapeHtml(h.question)}</span>
          </div>
        `;
        els.historyList.appendChild(div);
      });
    }

    function recordResult(outcome){
      if(!state.current) return;
      const used = Math.round(timeUsedSec());
      const picked = Array.from(state.selectedIdxs).sort((a,b)=>a-b).join("|");
      const correct = (state.current.correct||[]).slice().sort((a,b)=>a-b).join("|");

      state.results.push({
        timestamp: new Date().toISOString(),
        setId: state.setId,
        label: state.current.label,
        question: state.current.question,
        type: state.current.type,
        picked,
        correct,
        outcome,
        timeUsedSec: used,
        points: state.current.points,
        scoreAfter: state.score
      });
    }

    function exportCSV(){
      if(state.results.length === 0){
        toast("Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ export.", "‚ö†Ô∏è");
        return;
      }
      const cols = [
        "timestamp","setId","label","question","type",
        "picked","correct","outcome","timeUsedSec","points","scoreAfter"
      ];
      const lines = [];
      lines.push(cols.join(","));
      state.results.forEach(r=>{
        lines.push(cols.map(c=>csvEscape(r[c])).join(","));
      });

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `spin_the_wheel_n8n_results_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
      toast("ƒê√£ xu·∫•t CSV.", "‚¨áÔ∏è");
    }

    /* =========================
       Teacher mode (lock/unlock)
       ========================= */
    function setTeacherUnlocked(on){
      state.teacherUnlocked = !!on;
      els.teacherPill.textContent = state.teacherUnlocked ? "Unlocked" : "Locked";

      const enable = (el, ok)=>{ el.disabled = !ok; };
      enable(els.btnLock, state.teacherUnlocked);
      enable(els.btnUnlock, !state.teacherUnlocked);

      const controls = [els.setSelect, els.timePerQ, els.spinMin, els.btnStart, els.btnNext, els.btnReveal, els.btnExport];
      controls.forEach(c=> enable(c, state.teacherUnlocked));

      const allowJson = state.teacherUnlocked && CONFIG.teacher.allowJsonEdit;
      enable(els.jsonEditor, allowJson);
      enable(els.btnApplyJson, allowJson);
      enable(els.btnExportJson, allowJson);

      if(state.teacherUnlocked){
        setTeacherStatus("ok","‚úÖ Teacher Mode ƒë√£ m·ªü. B·∫°n c√≥ th·ªÉ Start/Next/Reveal v√† ch·ªânh timer.", false);
        toast("Teacher unlocked", "üßë‚Äçüè´");
      }else{
        setTeacherStatus("warn","üîí Teacher Mode ƒëang kh√≥a.", false);
        toast("Teacher locked", "üîê");
      }
    }

    function unlockPrompt(){
      const pw = prompt("Nh·∫≠p m·∫≠t kh·∫©u Teacher Mode:");
      if(pw === null) return;
      if(String(pw).trim() === CONFIG.teacher.password){
        setTeacherUnlocked(true);
      }else{
        setTeacherStatus("err","‚ùå Sai m·∫≠t kh·∫©u. Th·ª≠ l·∫°i.", false);
        toast("Sai m·∫≠t kh·∫©u", "‚ùå");
      }
    }

    function toggleTeacherPanel(){
      state.teacherCollapsed = !state.teacherCollapsed;
      els.teacherPanel.classList.toggle("collapsed", state.teacherCollapsed);
      $("#btnCollapseTeacher span").textContent = state.teacherCollapsed ? "‚ü©‚ü©" : "‚ü®‚ü®";
      toast(state.teacherCollapsed ? "Teacher collapsed" : "Teacher expanded", "üßë‚Äçüè´");
    }

    async function toggleFullscreen(){
      try{
        if(!document.fullscreenElement){
          await document.documentElement.requestFullscreen();
          toast("Fullscreen ON", "‚õ∂");
        }else{
          await document.exitFullscreen();
          toast("Fullscreen OFF", "‚õ∂");
        }
      }catch(e){
        toast("Fullscreen b·ªã ch·∫∑n.", "‚ö†Ô∏è");
      }
    }

    function applyTeacherSettings(){
      const t = clamp(Number(els.timePerQ.value), 20, 120);
      const spinMin = clamp(Number(els.spinMin.value), 2, 12);
      CONFIG.gameplay.timePerRoundSec = t;
      CONFIG.gameplay.spinMinTurns = spinMin;
      state.timer.durationSec = t;
      toast(`Applied: ${t}s ‚Ä¢ min turns=${spinMin}`, "‚úÖ");
      setTimerUI(t);
    }

    function applyJson(){
      const txt = String(els.jsonEditor.value || "").trim();
      if(!txt){ toast("JSON tr·ªëng.", "‚ö†Ô∏è"); return; }
      setTeacherStatus("", "ƒêang parse JSON...", true);
      setTimeout(()=>{
        try{
          const data = JSON.parse(txt);
          if(!Array.isArray(data)) throw new Error("Root ph·∫£i l√† array questionSets.");
          data.forEach((s, i)=>{
            if(!s || typeof s !== "object") throw new Error(`Set #${i} invalid`);
            if(!Array.isArray(s.items)) throw new Error(`Set #${i} missing items`);
          });
          CONFIG.questionSets = data;
          rebuildSetSelect();
          loadSet(CONFIG.questionSets[0].id);
          setTeacherStatus("ok","‚úÖ Applied JSON sets.", false);
          toast("Applied JSON", "‚úÖ");
        }catch(e){
          setTeacherStatus("err","‚ùå " + (e && e.message ? e.message : String(e)), false);
          toast("JSON l·ªói", "‚ùå");
        }
      }, 120);
    }

    function exportJson(){
      els.jsonEditor.value = JSON.stringify(CONFIG.questionSets, null, 2);
      toast("Exported JSON v√†o √¥ editor.", "‚¨ÜÔ∏è");
    }

    function rebuildSetSelect(){
      els.setSelect.innerHTML = "";
      CONFIG.questionSets.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name || s.id;
        els.setSelect.appendChild(opt);
      });
      els.setSelect.value = state.setId || CONFIG.questionSets[0]?.id || "";
    }

    /* =========================
       Download current HTML (offline)
       ========================= */
    function downloadThisHtml(){
      try{
        const html = "<!doctype html>\n" + document.documentElement.outerHTML;
        const blob = new Blob([html], {type:"text/html;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "spin-the-wheel-n8n.html";
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{
          URL.revokeObjectURL(a.href);
          a.remove();
        }, 0);
        toast("ƒê√£ t·∫£i file HTML.", "‚¨áÔ∏è");
      }catch(e){
        toast("Kh√¥ng th·ªÉ t·∫£i HTML (tr√¨nh duy·ªát ch·∫∑n).", "‚ö†Ô∏è");
      }
    }

    /* =========================
       Reveal / Next / Reset
       ========================= */
    function teacherReveal(){
      if(!state.current){
        toast("Ch∆∞a c√≥ c√¢u h·ªèi. H√£y SPIN.", "‚ö†Ô∏è");
        return;
      }
      stopTimer();
      revealAnswer("Teacher Reveal");
      setFeedback("warn","üëÅÔ∏è Reveal","Space ƒë·ªÉ Next","üëÅÔ∏è");
    }

    function hardReset(){
      stopTimer();
      state.started = false;
      state.score = 0;
      state.results = [];
      state.history = [];
      renderHistory();
      loadSet(state.setId);
      toast("Reset to√†n b·ªô.", "üîÑ");
    }

    /* =========================
       Keyboard shortcuts
       ========================= */
    function onKeyDown(e){
      const key = e.key;

      if(key === "Escape"){
        e.preventDefault();
        pauseToggle();
        return;
      }

      if(key === "r" || key === "R"){
        e.preventDefault();
        // Teacher reveals or student reveal
        teacherReveal();
        return;
      }

      if(key === " "){
        e.preventDefault();
        nextRound();
        return;
      }

      if(key === "1" || key === "2" || key === "3" || key === "4"){
        e.preventDefault();
        const idx = Number(key) - 1;
        if(state.current && idx < (state.current.options||[]).length){
          toggleOption(idx);
        }
        return;
      }
    }

    /* =========================
       Init
       ========================= */
    function init(){
      applyBrand();
      rebuildSetSelect();
      loadSet(state.setId);

      // defaults
      els.timePerQ.value = String(CONFIG.gameplay.timePerRoundSec);
      els.spinMin.value = String(CONFIG.gameplay.spinMinTurns);

      // teacher panel
      els.btnTeacher.addEventListener("click", toggleTeacherPanel);
      els.btnCollapseTeacher.addEventListener("click", toggleTeacherPanel);

      els.btnUnlock.addEventListener("click", unlockPrompt);
      els.btnLock.addEventListener("click", ()=> setTeacherUnlocked(false));

      els.setSelect.addEventListener("change", ()=>{
        loadSet(els.setSelect.value);
        toast("ƒê√£ ƒë·ªïi set.", "üìö");
      });

      [els.timePerQ, els.spinMin].forEach(inp=>{
        inp.addEventListener("change", ()=>{
          if(!state.teacherUnlocked) return;
          applyTeacherSettings();
          setTeacherStatus("ok","‚úÖ Settings updated.", false);
        });
      });

      els.btnStart.addEventListener("click", ()=>{
        applyTeacherSettings();
        startGame();
      });
      els.btnNext.addEventListener("click", nextRound);
      els.btnReveal.addEventListener("click", teacherReveal);
      els.btnReveal2.addEventListener("click", teacherReveal);
      els.btnExport.addEventListener("click", exportCSV);

      els.btnApplyJson.addEventListener("click", applyJson);
      els.btnExportJson.addEventListener("click", exportJson);

      els.btnFullscreen.addEventListener("click", toggleFullscreen);

      // game actions
      els.btnSpin.addEventListener("click", spin);
      els.btnPause.addEventListener("click", ()=> pauseToggle());
      els.btnResume.addEventListener("click", ()=> pauseToggle(false));

      els.btnSubmit.addEventListener("click", submitAnswer);
      els.btnRevealStudent.addEventListener("click", teacherReveal);
      els.btnNextStudent.addEventListener("click", nextRound);

      els.btnMarkCorrect.addEventListener("click", ()=> markCorrectWrong("correct"));
      els.btnMarkWrong.addEventListener("click", ()=> markCorrectWrong("wrong"));

      els.btnClearHistory.addEventListener("click", ()=>{
        state.history = [];
        renderHistory();
        toast("ƒê√£ x√≥a l·ªãch s·ª≠.", "üßπ");
      });

      // header buttons
      els.btnReset.addEventListener("click", hardReset);
      els.btnDownload.addEventListener("click", downloadThisHtml);
      els.btnDownloadCsv.addEventListener("click", exportCSV);

      // keyboard
      document.addEventListener("keydown", onKeyDown, {passive:false});

      // start locked
      setTeacherUnlocked(false);
      renderHistory();
      drawWheel();
      clearQuestionUI();
      setRoundBadge("S·∫µn s√†ng", "Nh·∫•n Start (Teacher) r·ªìi b·∫•m SPIN", "‚ö°");
      setFeedback("warn","Ch∆∞a quay","B·∫•m SPIN ƒë·ªÉ ch·ªçn c√¢u h·ªèi","üé°");
      setTeacherStatus("warn","Teacher Mode ƒëang kh√≥a. Nh·∫•n Unlock ƒë·ªÉ c·∫•u h√¨nh.", false);
    }

    init();

    /* =========================
       Teacher-friendly: End-of-file quick guide
       =========================
       C√ÅCH ƒê·ªîI D·ªÆ LI·ªÜU:
       - S·ª≠a CONFIG.questionSets[].items[]:
         {
           label:"TRIGGER",
           question:"...",
           type:"single"|"multi",
           options:["A","B","C","D"],
           correct:[0] ho·∫∑c [0,2],
           explain:"...",
           points:100
         }

       C√ÅCH CH∆†I TRONG L·ªöP (5‚Äì15 ph√∫t):
       1) Teacher Unlock ‚Üí ch·ªçn set ‚Üí ch·ªânh time ‚Üí Start.
       2) B·∫•m SPIN ƒë·ªÉ ch·ªçn ‚Äú√¥‚Äù (label) + c√¢u h·ªèi.
       3) H·ªçc vi√™n ch·ªçn ƒë√°p √°n (ph√≠m 1/2/3/4 ho·∫∑c click) ‚Üí Submit.
       4) Hi·ªÉn th·ªã ƒë√∫ng/sai + gi·∫£i th√≠ch ‚Üí Space/Next sang v√≤ng ti·∫øp theo.
       5) Cu·ªëi bu·ªïi: Export CSV (ƒëi·ªÉm, th·ªùi gian, k·∫øt qu·∫£).

       PH√çM T·∫ÆT:
       - Space: Next
       - R: Reveal
       - Esc: Pause/Resume
       - 1/2/3/4: ch·ªçn ƒë√°p √°n A/B/C/D
    */
  </script>
</body>
</html>
