<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flappy n8n ‚Äî Mini Game L·ªõp H·ªçc</title>
  <style>
    :root{
      --bg0:#060b1a;
      --bg1:#0b1533;
      --card:#0c1b3f;
      --card2:#0a1433;
      --fg:#eaf0ff;
      --muted:#a9b7e5;
      --blue:#4aa3ff;
      --blue2:#2b6dff;
      --green:#31d39a;
      --red:#ff5b6a;
      --amber:#ffcc66;
      --shadow: 0 14px 45px rgba(0,0,0,.45);
      --shadow2: 0 10px 22px rgba(0,0,0,.35);
      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --ring: 0 0 0 3px rgba(74,163,255,.28);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--fg);
      background:
        radial-gradient(1100px 650px at 20% 15%, rgba(74,163,255,.18), transparent 55%),
        radial-gradient(1100px 700px at 90% 20%, rgba(49,211,154,.12), transparent 60%),
        radial-gradient(900px 600px at 60% 95%, rgba(43,109,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    button, input, select{ font:inherit; color:inherit; }

    .app{ min-height:100%; display:flex; flex-direction:column; }

    /* ===== Header (ONE ROW) ===== */
    header.topbar{
      position: sticky;
      top: 0;
      z-index: 60;
      background: linear-gradient(180deg, rgba(6,11,26,.92), rgba(6,11,26,.72));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .topbar-inner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 12px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 230px;
    }
    .logo{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, rgba(74,163,255,.22), rgba(43,109,255,.16));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      flex: 0 0 auto;
    }
    .brand-title{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }
    .brand-title strong{
      font-size: 14px;
      font-weight: 850;
      letter-spacing: .2px;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand-title small{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 290px;
    }

    .stats{
      display:flex;
      gap: 8px;
      align-items:center;
      overflow:auto;
      padding-bottom: 2px;
      scrollbar-width: thin;
    }
    .stats::-webkit-scrollbar{ height: 8px; }
    .stats::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius: 999px; }

    .pill{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
      flex: 0 0 auto;
    }
    .pill .k{ color: var(--muted); font-weight: 650; }
    .pill .v{ font-variant-numeric: tabular-nums; font-weight: 850; }

    .dot{ width: 8px; height: 8px; border-radius: 999px; background: rgba(255,255,255,.22); box-shadow: 0 0 0 2px rgba(255,255,255,.08) inset; }
    .dot.live{ background: var(--green); box-shadow: 0 0 0 2px rgba(49,211,154,.25) inset, 0 0 20px rgba(49,211,154,.22); }
    .dot.pause{ background: var(--amber); box-shadow: 0 0 0 2px rgba(255,204,102,.25) inset, 0 0 18px rgba(255,204,102,.18); }
    .dot.over{ background: var(--red); box-shadow: 0 0 0 2px rgba(255,91,106,.25) inset, 0 0 18px rgba(255,91,106,.18); }

    .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
      white-space: nowrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{ background: linear-gradient(135deg, rgba(74,163,255,.22), rgba(43,109,255,.18)); border-color: rgba(74,163,255,.22); }
    .btn.danger{ background: linear-gradient(135deg, rgba(255,91,106,.16), rgba(255,91,106,.10)); border-color: rgba(255,91,106,.22); }
    .btn.ghost{ background: transparent; border-color: rgba(255,255,255,.14); box-shadow:none; }
    .btn:focus-visible{ outline:none; box-shadow: var(--ring), 0 10px 20px rgba(0,0,0,.25); }
    .btn svg{ width:18px; height:18px; opacity:.95; }

    /* compact on small screens: keep one row by hiding labels */
    @media (max-width: 860px){
      .topbar-inner{ grid-template-columns: auto 1fr auto; }
      .brand{ min-width: 0; }
      .brand-title small{ display:none; }
      .btn span.txt{ display:none; }
      .btn{ padding: 10px 10px; }
    }

    main{ flex:1 1 auto; padding: 14px 12px 18px; display:flex; justify-content:center; }
    .wrap{ width:min(1200px,100%); display:grid; gap: 12px; }

    .stage{
      position:relative;
      border-radius: var(--radius-xl);
      background: linear-gradient(180deg, rgba(12,27,63,.86), rgba(10,20,51,.78));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .canvas-shell{ position:relative; width:100%; aspect-ratio: 16/9; }

    canvas#game{
      position:relative;
      z-index: 1;
      width:100%;
      height:100%;
      display:block;
    }

    .overlay{
      position:absolute;
      inset:0;
      z-index: 10;
      display:grid;
      place-items:center;
      padding: 16px;
      background: linear-gradient(180deg, rgba(6,11,26,.55), rgba(6,11,26,.82));
      pointer-events: auto;
    }
    .overlay[hidden]{ display:none !important; }

    .panel{
      width:min(920px, 100%);
      border-radius: var(--radius-xl);
      background: linear-gradient(180deg, rgba(12,27,63,.92), rgba(10,20,51,.88));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      padding: 16px;
      animation: inUp .22s ease both;
    }

    @keyframes inUp{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .panel-head{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .panel-head h2{ margin:0; font-size:18px; font-weight:900; letter-spacing:.2px; }
    .panel-head p{ margin: 4px 0 0; color: var(--muted); font-size:13px; line-height:1.45; }

    .grid{
      margin-top: 12px;
      display:grid;
      gap: 12px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--radius-lg);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      padding: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
    }

    .card h3{
      margin:0 0 10px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .sub{ margin: 0 0 10px; color: var(--muted); font-size: 12px; line-height: 1.5; }

    .form-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    label{ display:flex; flex-direction:column; gap:6px; font-size:12px; color: var(--muted); min-width: 220px; flex: 1 1 220px; }

    select, input[type="number"], input[type="password"]{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(6,11,26,.45);
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
    }
    select:focus, input:focus{ box-shadow: var(--ring); border-color: rgba(74,163,255,.35); background: rgba(6,11,26,.62); }

    .hint{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(74,163,255,.10);
      border: 1px solid rgba(74,163,255,.18);
      color: rgba(234,240,255,.92);
      font-size: 12px;
      line-height: 1.5;
    }

    .kbd{
      display:inline-flex;
      align-items:center;
      padding: 2px 8px;
      border-radius: 9px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      font-size: 12px;
    }

    .toast{
      position:absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      z-index: 20;
      width:min(720px, 92%);
      border-radius: 999px;
      padding: 10px 12px;
      background: rgba(6,11,26,.72);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:center;
      opacity: 0;
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
      color: rgba(234,240,255,.92);
      font-size: 12px;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-2px); }
    .toast .tag{ padding: 3px 8px; border-radius: 999px; font-weight: 900; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); }
    .tag.ok{ border-color: rgba(49,211,154,.22); background: rgba(49,211,154,.10); }
    .tag.bad{ border-color: rgba(255,91,106,.25); background: rgba(255,91,106,.10); }

    /* ===== Modal ===== */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 100;
      display:grid;
      place-items:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .modal.open{ opacity: 1; pointer-events:auto; }

    .modal-card{
      width: min(920px, 100%);
      border-radius: var(--radius-xl);
      background: linear-gradient(180deg, rgba(12,27,63,.96), rgba(10,20,51,.94));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: inUp .20s ease both;
    }

    .modal-head{
      padding: 14px 14px 12px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .modal-title{ display:flex; flex-direction:column; gap:4px; min-width: 0; }
    .modal-title strong{ font-size: 15px; font-weight: 950; letter-spacing:.2px; }
    .modal-title span{ color: var(--muted); font-size: 12px; }
    .modal-body{ padding: 14px; display:grid; gap: 12px; }

    .q{ font-size: 15px; line-height: 1.45; font-weight: 800; margin:0; }

    .choices{ display:grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 680px){ .choices{ grid-template-columns: 1fr; } }

    .choice{
      text-align:left;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }
    .choice:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.07); }
    .choice:focus-visible{ outline:none; box-shadow: var(--ring); }
    .choice .badge{ width: 28px; height: 28px; border-radius: 10px; display:grid; place-items:center; font-weight: 950; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); flex: 0 0 auto; }
    .choice.correct{ border-color: rgba(49,211,154,.35); background: rgba(49,211,154,.10); }
    .choice.wrong{ border-color: rgba(255,91,106,.35); background: rgba(255,91,106,.10); }
    .choice.reveal{ border-color: rgba(74,163,255,.35); background: rgba(74,163,255,.10); }

    .feedback{
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(6,11,26,.35);
      line-height: 1.55;
      font-size: 13px;
      display:grid;
      gap: 8px;
    }
    .feedback .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    .feedback .status{ display:flex; gap: 10px; align-items:center; }

    .badge2{ padding: 3px 10px; border-radius: 999px; font-weight: 950; font-size: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); }
    .badge2.ok{ border-color: rgba(49,211,154,.30); background: rgba(49,211,154,.12); }
    .badge2.bad{ border-color: rgba(255,91,106,.35); background: rgba(255,91,106,.12); }
    .badge2.info{ border-color: rgba(74,163,255,.30); background: rgba(74,163,255,.12); }

    .modal-actions{
      padding: 12px 14px 14px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
      border-top: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, transparent, rgba(255,255,255,.03));
    }

    /* ===== Teacher Drawer ===== */
    .backdrop{
      position: fixed;
      inset: 0;
      z-index: 80;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .backdrop.show{ opacity: 1; pointer-events:auto; }

    .drawer{
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(420px, 96vw);
      z-index: 90;
      transform: translateX(105%);
      transition: transform .18s ease;
      background: linear-gradient(180deg, rgba(12,27,63,.98), rgba(10,20,51,.96));
      border-left: 1px solid rgba(255,255,255,.12);
      box-shadow: -18px 0 45px rgba(0,0,0,.45);
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform: translateX(0); }
    .drawer header{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .drawer header .t{ display:flex; flex-direction:column; gap:2px; }
    .drawer header strong{ font-weight: 950; letter-spacing:.2px; }
    .drawer header small{ color: var(--muted); }
    .drawer .content{ padding: 14px; overflow:auto; display:grid; gap: 12px; }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
      .btn:hover{ transform:none; }
      .toast.show{ transform: translateX(-50%); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar" role="banner">
      <div class="topbar-inner">
        <div class="brand" aria-label="Game title">
          <div class="logo" id="brandLogo" aria-hidden="true"></div>
          <div class="brand-title">
            <strong id="brandTitle">Flappy n8n</strong>
            <small id="brandTagline">Bay qua c·ªïng ‚Ä¢ Sai th√¨ tr·∫£ l·ªùi c√¢u h·ªèi ƒë·ªÉ h·ªìi sinh</small>
          </div>
        </div>

        <div class="stats" aria-label="Game stats">
          <div class="pill" title="Tr·∫°ng th√°i">
            <span class="dot" id="statusDot" aria-hidden="true"></span>
            <span class="k">Status</span>
            <span class="v" id="statusText">Idle</span>
          </div>
          <div class="pill" title="Th·ªùi gian c√≤n l·∫°i">
            <span aria-hidden="true">‚è±Ô∏è</span>
            <span class="k">Timer</span>
            <span class="v" id="timerText">05:00</span>
          </div>
          <div class="pill" title="ƒêi·ªÉm qua c·ªïng">
            <span aria-hidden="true">üèÅ</span>
            <span class="k">Score</span>
            <span class="v" id="scoreText">0</span>
          </div>
          <div class="pill" title="S·ªë l·∫ßn h·ªìi sinh (ƒë√∫ng c√¢u h·ªèi)">
            <span aria-hidden="true">üíô</span>
            <span class="k">Lives+</span>
            <span class="v" id="livesText">0</span>
          </div>
          <div class="pill" title="Ti·∫øn ƒë·ªô c√¢u h·ªèi">
            <span aria-hidden="true">üß©</span>
            <span class="k">Progress</span>
            <span class="v" id="progressText">0/10</span>
          </div>
        </div>

        <div class="actions" aria-label="Actions">
          <button class="btn ghost" id="btnStartTop" type="button" title="Start / Resume">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 5v14l12-7L8 5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
            <span class="txt">Start</span>
          </button>
          <button class="btn" id="btnExport" type="button" title="Xu·∫•t k·∫øt qu·∫£ d·∫°ng ·∫£nh">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M8 8V6a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 14l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 19V10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M5 20h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="txt">Xu·∫•t</span>
          </button>
          <button class="btn danger" id="btnReset" type="button" title="Reset game">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 12a9 9 0 1 1-3-6.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M21 3v7h-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="txt">Reset</span>
          </button>
          <button class="btn primary" id="btnTeacher" type="button" title="Teacher Mode (ph√≠m T) ‚Äî m·∫≠t kh·∫©u: n8n">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 2l9 5-9 5-9-5 9-5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M3 7v10l9 5 9-5V7" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M12 12v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="txt">Teacher</span>
          </button>
        </div>
      </div>
    </header>

    <main role="main">
      <div class="wrap">
        <section class="stage" aria-label="Game stage">
          <div class="canvas-shell">
            <canvas id="game" width="1280" height="720" role="img" aria-label="Flappy Bird canvas"></canvas>

            <!-- Start overlay (Student Mode) -->
            <div class="overlay" id="startOverlay">
              <div class="panel" role="region" aria-label="Student Mode panel">
                <div class="panel-head">
                  <div>
                    <h2>Student Mode</h2>
                    <p>Ch·ªçn b·ªô c√¢u h·ªèi, b·∫•m <b>Start</b>. Nh·∫•n <span class="kbd">Space</span> (ho·∫∑c ch·∫°m) ƒë·ªÉ bay. M·ªü Teacher Mode ·ªü n√∫t <b>Teacher</b> (g√≥c ph·∫£i header) ho·∫∑c ph√≠m <span class="kbd">T</span>.</p>
                  </div>
                  <div class="form-row" style="justify-content:flex-end;">
                    <button class="btn primary" id="btnStart" type="button" aria-label="Start game">
                      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 5v14l12-7L8 5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
                      <span class="txt">Start</span>
                    </button>
                  </div>
                </div>

                <div class="grid" aria-label="Setup grid">
                  <div class="card">
                    <h3><span aria-hidden="true">‚öôÔ∏è</span> Thi·∫øt l·∫≠p nhanh</h3>
                    <p class="sub">Va ch·∫°m ‚Üí hi·ªán ‚Äúc√¢u h·ªèi c·ª©u m·∫°ng‚Äù. Tr·∫£ l·ªùi ƒë√∫ng ‚Üí h·ªìi sinh + th∆∞·ªüng ƒëi·ªÉm.</p>

                    <div class="form-row">
                      <label>
                        B·ªô c√¢u h·ªèi
                        <select id="selDifficulty" aria-label="Ch·ªçn b·ªô c√¢u h·ªèi">
                          <option value="easy">D·ªÖ (10 c√¢u)</option>
                          <option value="medium">Trung b√¨nh (10 c√¢u)</option>
                          <option value="hard">Kh√≥ (10 c√¢u)</option>
                        </select>
                      </label>
                      <label>
                        Th·ªùi gian (ph√∫t)
                        <input id="inpMinutes" type="number" min="1" max="60" step="1" value="5" inputmode="numeric" aria-label="Th·ªùi gian ph√∫t" />
                      </label>
                    </div>

                    <div class="hint" style="margin-top:10px;">
                      <div aria-hidden="true">üéÆ</div>
                      <div>
                        <div><b>ƒêi·ªÅu khi·ªÉn:</b> <span class="kbd">Space</span> flap ‚Ä¢ <span class="kbd">P</span> pause/resume ‚Ä¢ <span class="kbd">R</span> reset</div>
                        <div><b>Teacher:</b> <span class="kbd">T</span> m·ªü Teacher Mode (m·∫≠t kh·∫©u: <b>n8n</b>)</div>
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <h3><span aria-hidden="true">üß†</span> Demo c√¢u h·ªèi</h3>
                    <p class="sub">B·∫•m ƒë·ªÉ xem c√¢u h·ªèi ngay (kh√¥ng ·∫£nh h∆∞·ªüng ƒëi·ªÉm). D√πng ƒë·ªÉ ‚Äúwarm-up‚Äù c·∫£ l·ªõp.</p>
                    <div class="form-row">
                      <button class="btn" id="btnWarmup" type="button" aria-label="Xem th·ª≠ c√¢u h·ªèi (demo)">
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M9.09 9a3 3 0 1 1 5.82 1c-.48 1.18-1.91 1.65-2.41 2.75-.17.37-.2.8-.2 1.25" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M12 22c5.52 0 10-4.48 10-10S17.52 2 12 2 2 6.48 2 12s4.48 10 10 10z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span class="txt">Demo</span>
                      </button>
                    </div>
                    <div class="hint" style="margin-top:10px;">
                      <div aria-hidden="true">üí°</div>
                      <div>G·ª£i √Ω d·∫°y nhanh: cho c·∫£ l·ªõp tr·∫£ l·ªùi ƒë·ªìng thanh tr∆∞·ªõc khi ch∆°i (30‚Äì60 gi√¢y).</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>
          </div>
        </section>
      </div>
    </main>

    <!-- Question Modal -->
    <div class="modal" id="questionModal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="qTitle">
        <div class="modal-head">
          <div class="modal-title">
            <strong id="qTitle">C√¢u h·ªèi c·ª©u m·∫°ng</strong>
            <span id="qMeta">Set: D·ªÖ ‚Ä¢ C√¢u 1/10</span>
          </div>
          <button class="btn ghost" id="btnCloseQuestion" type="button" aria-label="ƒê√≥ng">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <span class="txt">ƒê√≥ng</span>
          </button>
        </div>
        <div class="modal-body">
          <p class="q" id="qText">...</p>
          <div class="choices" id="qChoices" aria-label="Danh s√°ch l·ª±a ch·ªçn"></div>

          <div class="feedback" id="qFeedback" hidden>
            <div class="row">
              <div class="status">
                <span class="badge2 info" id="qBadge">...</span>
                <span id="qShort">...</span>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <button class="btn" id="btnReveal" type="button" aria-label="Reveal ƒë√°p √°n">
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <span class="txt">Reveal</span>
                </button>
              </div>
            </div>
            <div id="qHint"></div>
            <div id="qExplain"></div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn" id="btnContinue" type="button" aria-label="Ti·∫øp t·ª•c ch∆°i" hidden>
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 5v14l12-7L8 5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
            <span class="txt">Ti·∫øp t·ª•c</span>
          </button>
          <button class="btn danger" id="btnGameOver" type="button" aria-label="K·∫øt th√∫c" hidden>
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <span class="txt">Game Over</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="exportTitle">
        <div class="modal-head">
          <div class="modal-title">
            <strong id="exportTitle">Xu·∫•t k·∫øt qu·∫£</strong>
            <span>·∫¢nh 16:9 (PNG) ‚Äî c√≥ th·ªÉ t·∫£i v·ªÅ ho·∫∑c copy (n·∫øu tr√¨nh duy·ªát h·ªó tr·ª£)</span>
          </div>
          <button class="btn ghost" id="btnCloseExport" type="button" aria-label="ƒê√≥ng">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <span class="txt">ƒê√≥ng</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="card" style="padding:12px;">
            <p class="sub" style="margin:0 0 10px;">Preview</p>
            <img id="exportPreview" alt="K·∫øt qu·∫£ xu·∫•t" style="width:100%;height:auto;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.20);" />
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn" id="btnCopyImage" type="button">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M9 9h10v10H9V9z" stroke="currentColor" stroke-width="2"/>
              <path d="M5 15H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="txt">Copy ·∫£nh</span>
          </button>
          <a class="btn primary" id="btnDownloadImage" href="#" download="flappy-n8n-result.png" role="button">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 11l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5 21h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="txt">T·∫£i PNG</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Teacher Drawer -->
    <div class="backdrop" id="drawerBackdrop" aria-hidden="true"></div>
    <aside class="drawer" id="teacherDrawer" aria-label="Teacher Mode">
      <header>
        <div class="t">
          <strong>Teacher Mode</strong>
          <small>M·ªü b·∫±ng n√∫t Teacher ho·∫∑c ph√≠m T ‚Ä¢ m·∫≠t kh·∫©u: n8n</small>
        </div>
        <button class="btn ghost" id="btnCloseTeacher" type="button" aria-label="ƒê√≥ng Teacher Mode">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <span class="txt">ƒê√≥ng</span>
        </button>
      </header>

      <div class="content">
        <div class="card" id="teacherLockCard">
          <h3><span aria-hidden="true">üîí</span> M·ªü kh√≥a</h3>
          <p class="sub">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü Teacher Mode. M·∫∑c ƒë·ªãnh: <b>n8n</b></p>
          <div class="form-row">
            <label style="min-width: 100%;">
              Password
              <input id="inpTeacherPass" type="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." autocomplete="off" />
            </label>
          </div>
          <div class="form-row">
            <button class="btn primary" id="btnUnlockTeacher" type="button">M·ªü kh√≥a</button>
          </div>
          <div class="hint">
            <div aria-hidden="true">üõ°Ô∏è</div>
            <div>Teacher Mode ch·ªâ l∆∞u trong phi√™n hi·ªán t·∫°i. Reload trang s·∫Ω kh√≥a l·∫°i.</div>
          </div>
        </div>

        <div class="card" id="teacherPanel" hidden>
          <h3><span aria-hidden="true">üéõÔ∏è</span> ƒêi·ªÅu khi·ªÉn nhanh</h3>
          <p class="sub">Ch·ªçn set/timer v√† Start. B·∫°n c≈©ng c√≥ th·ªÉ m·ªü c√¢u h·ªèi ƒë·ªÉ ‚Äúƒë·ªë nhanh‚Äù c·∫£ l·ªõp.</p>

          <div class="form-row">
            <label>
              Ch·ªçn set
              <select id="selDifficultyTeacher" aria-label="Teacher ch·ªçn b·ªô c√¢u h·ªèi">
                <option value="easy">D·ªÖ</option>
                <option value="medium">Trung b√¨nh</option>
                <option value="hard">Kh√≥</option>
              </select>
            </label>
            <label>
              Timer (ph√∫t)
              <input id="inpMinutesTeacher" type="number" min="1" max="60" step="1" value="5" inputmode="numeric" aria-label="Teacher ch·ªânh th·ªùi gian" />
            </label>
          </div>

          <div class="form-row">
            <button class="btn primary" id="btnTeacherStart" type="button">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 5v14l12-7L8 5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
              <span class="txt">Start</span>
            </button>
            <button class="btn" id="btnTeacherPause" type="button">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 6h2v12H9V6zm4 0h2v12h-2V6z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
              <span class="txt">Pause/Resume</span>
            </button>
            <button class="btn danger" id="btnTeacherReset" type="button">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M21 12a9 9 0 1 1-3-6.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M21 3v7h-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span class="txt">Reset</span>
            </button>
          </div>

          <div class="card" style="margin-top:12px; background: rgba(255,255,255,.03);">
            <h3><span aria-hidden="true">üß©</span> C√¢u h·ªèi (ƒë·ªë nhanh)</h3>
            <p class="sub" id="teacherQMeta">Set: D·ªÖ ‚Ä¢ Con tr·ªè: 0/10</p>
            <div class="form-row">
              <button class="btn" id="btnTeacherOpenQ" type="button">Open</button>
              <button class="btn" id="btnTeacherNextQ" type="button">Next</button>
              <button class="btn" id="btnTeacherRevealQ" type="button">Reveal</button>
            </div>
          </div>

          <div class="hint">
            <div aria-hidden="true">‚å®Ô∏è</div>
            <div><b>Ph√≠m t·∫Øt:</b> Space = Flap ‚Ä¢ P = Pause/Resume ‚Ä¢ R = Reset ‚Ä¢ T = Teacher</div>
          </div>
        </div>
      </div>
    </aside>

    <canvas id="exportCanvas" width="1200" height="675" hidden></canvas>

    <script>
      "use strict";

      /** =========================
       *  CONFIG ‚Äî gi√°o vi√™n s·ª≠a nhanh
       *  ========================= */
      const CONFIG = {
        text: {
          brand: "Flappy n8n",
          tagline: "S·ª≠ d·ª•ng n8n c∆° b·∫£n ‚Ä¢ Flappy Bird + Quiz c·ª©u m·∫°ng",
        },
        assets: {
          logoSvg:
            `<svg viewBox="0 0 48 48" width="22" height="22" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M24 4c9.94 0 18 8.06 18 18S33.94 40 24 40 6 31.94 6 22 14.06 4 24 4Z" stroke="rgba(234,240,255,.92)" stroke-width="2"/>
              <path d="M14 25c3.5-7 7-10 12-10s8.5 3 12 10" stroke="rgba(74,163,255,.95)" stroke-width="2" stroke-linecap="round"/>
              <path d="M16 31c3.2-3.2 6.2-4.8 8.8-4.8 3.3 0 6.3 1.9 9.2 5.8" stroke="rgba(49,211,154,.92)" stroke-width="2" stroke-linecap="round"/>
              <path d="M26 22c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2Z" fill="rgba(234,240,255,.92)"/>
            </svg>`,
        },
        teacher: { password: "n8n" },
        session: { defaultMinutes: 5 },
        game: {
          width: 1280,
          height: 720,
          gravity: 2400,
          flapVelocity: -680,
          maxFallVelocity: 1200,
          pipeSpeed: 440,
          pipeWidth: 110,
          pipeGap: 220,
          pipeSpawnEveryMs: 1350,
          pipeMinTop: 90,
          pipeMinBottom: 120,
          birdRadius: 22,
          birdX: 0.33,
          birdStartY: 0.50,
          tiltMax: 0.65,
          scorePerGate: 1,
          bonusCorrect: 5,
          parallaxSpeed: 0.22,
        },
        questionSets: {
          easy: [
            { question: "Trong n8n, ‚ÄúWorkflow‚Äù d√πng ƒë·ªÉ l√†m g√¨?", options: ["L∆∞u m·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p", "Chu·ªói node t·ª± ƒë·ªông h√≥a c√°c b∆∞·ªõc", "T·∫°o email marketing", "Ch·ªâ ƒë·ªÉ v·∫Ω s∆° ƒë·ªì"], answerIndex: 1, hint: "Workflow = quy tr√¨nh (flow) g·ªìm nhi·ªÅu node.", explanation: "Workflow l√† n∆°i b·∫°n n·ªëi c√°c node th√†nh m·ªôt quy tr√¨nh x·ª≠ l√Ω t·ª± ƒë·ªông (trigger ‚Üí x·ª≠ l√Ω ‚Üí output)." },
            { question: "Node n√†o th∆∞·ªùng d√πng ƒë·ªÉ b·∫Øt ƒë·∫ßu theo l·ªãch (schedule)?", options: ["Cron", "HTTP Request", "Merge", "Set"], answerIndex: 0, hint: "Ch·∫°y theo gi·ªù/ng√†y/tu·∫ßn.", explanation: "Cron Trigger d√πng ƒë·ªÉ k√≠ch ho·∫°t workflow theo l·ªãch ƒë·ªãnh k·ª≥." },
            { question: "Node ‚ÄúSet‚Äù th∆∞·ªùng d√πng ƒë·ªÉ l√†m g√¨?", options: ["G·ªçi API", "T·∫°o/bi·∫øn ƒë·ªïi d·ªØ li·ªáu th·ªß c√¥ng (fields)", "Gh√©p 2 lu·ªìng d·ªØ li·ªáu", "Ch·∫∑n workflow"], answerIndex: 1, hint: "T·∫°o field m·ªõi / s·ª≠a field.", explanation: "Set node gi√∫p t·∫°o/s·ª≠a/x√≥a fields trong item d·ªØ li·ªáu (nhanh, tr·ª±c quan)." },
            { question: "Trong n8n, ‚ÄúNode‚Äù l√† g√¨?", options: ["M·ªôt b∆∞·ªõc x·ª≠ l√Ω trong workflow", "M·ªôt b·∫£ng d·ªØ li·ªáu", "M·ªôt trang web", "M·ªôt lo·∫°i t√†i kho·∫£n"], answerIndex: 0, hint: "Workflow g·ªìm nhi·ªÅu ...", explanation: "Node l√† m·ªôt b∆∞·ªõc (step) th·ª±c hi·ªán m·ªôt h√†nh ƒë·ªông/logic trong workflow." },
            { question: "Mu·ªën g·ªçi API l·∫•y d·ªØ li·ªáu t·ª´ Internet, th∆∞·ªùng d√πng node n√†o?", options: ["HTTP Request", "Cron", "IF", "Wait"], answerIndex: 0, hint: "T√™n node ƒë√£ n√≥i r√µ.", explanation: "HTTP Request node d√πng ƒë·ªÉ g·ªçi REST API (GET/POST/PUT/DELETE...)." },
            { question: "‚ÄúTrigger‚Äù trong n8n c√≥ vai tr√≤ g√¨?", options: ["K·∫øt th√∫c workflow", "K√≠ch ho·∫°t workflow b·∫Øt ƒë·∫ßu ch·∫°y", "Ch·ªâ ƒë·ªÉ trang tr√≠", "Ch·ªâ d√πng khi test"], answerIndex: 1, hint: "Trigger = c√≤ s√∫ng.", explanation: "Trigger l√† ƒëi·ªÉm b·∫Øt ƒë·∫ßu ch·∫°y workflow khi c√≥ s·ª± ki·ªán (cron/webhook/manual...)." },
            { question: "Node ‚ÄúIF‚Äù d√πng ƒë·ªÉ l√†m g√¨?", options: ["So s√°nh ƒëi·ªÅu ki·ªán ƒë·ªÉ r·∫Ω nh√°nh", "G·ªçi API", "G·ªôp d·ªØ li·ªáu", "L∆∞u file ·∫£nh"], answerIndex: 0, hint: "IF = n·∫øu‚Ä¶ th√¨‚Ä¶", explanation: "IF node ki·ªÉm tra ƒëi·ªÅu ki·ªán v√† chia lu·ªìng True/False." },
            { question: "Khi test workflow th·ªß c√¥ng trong n8n, th∆∞·ªùng d√πng c√°ch n√†o?", options: ["Manual Trigger", "Cron", "Webhook (Production)", "Merge"], answerIndex: 0, hint: "Ch·∫°y b·∫±ng tay.", explanation: "Manual Trigger/Execute workflow gi√∫p ch·∫°y th·ª≠ nhanh khi x√¢y d·ª±ng." },
            { question: "‚ÄúCredentials‚Äù trong n8n d√πng ƒë·ªÉ l√†m g√¨?", options: ["L∆∞u th√¥ng tin k·∫øt n·ªëi (API key/OAuth) an to√†n", "TƒÉng t·ªëc ƒë·ªô m·∫°ng", "Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu", "T·∫°o UI ƒë·∫πp h∆°n"], answerIndex: 0, hint: "Li√™n quan login/API key.", explanation: "Credentials l√† n∆°i l∆∞u th√¥ng tin x√°c th·ª±c ƒë·ªÉ c√°c node k·∫øt n·ªëi d·ªãch v·ª• b√™n ngo√†i." },
            { question: "Mu·ªën ‚Äút·∫°m d·ª´ng‚Äù workflow m·ªôt l√∫c r·ªìi ch·∫°y ti·∫øp, d√πng node n√†o?", options: ["Wait", "Set", "Merge", "Cron"], answerIndex: 0, hint: "Ch·ªù...", explanation: "Wait node cho ph√©p delay theo th·ªùi gian ho·∫∑c ch·ªù t·ªõi m·ªôt m·ªëc th·ªùi gian." },
          ],
          medium: [
            { question: "Webhook Trigger trong n8n ph√π h·ª£p nh·∫•t cho t√¨nh hu·ªëng n√†o?", options: ["Ch·∫°y theo l·ªãch", "Nh·∫≠n request t·ª´ h·ªá th·ªëng kh√°c ƒë·ªÉ k√≠ch ho·∫°t", "G·ªôp d·ªØ li·ªáu 2 nh√°nh", "ƒê·ªãnh d·∫°ng JSON"], answerIndex: 1, hint: "C√≥ request g·ª≠i t·ªõi URL.", explanation: "Webhook Trigger t·∫°o endpoint ƒë·ªÉ nh·∫≠n request (POST/GET) v√† b·∫Øt ƒë·∫ßu workflow." },
            { question: "Trong n8n, ‚ÄúExpression‚Äù th∆∞·ªùng d√πng ƒë·ªÉ l√†m g√¨?", options: ["Ch·∫°y workflow nhanh h∆°n", "Ch√®n d·ªØ li·ªáu ƒë·ªông v√†o field (v√≠ d·ª•: {{$json.name}})", "T·∫°o credential", "M·ªü r·ªông RAM"], answerIndex: 1, hint: "D·∫•u {{ }}.", explanation: "Expression gi√∫p tham chi·∫øu d·ªØ li·ªáu t·ª´ node tr∆∞·ªõc v√† t·∫°o gi√° tr·ªã ƒë·ªông." },
            { question: "Node ‚ÄúMerge‚Äù th∆∞·ªùng d√πng ƒë·ªÉ l√†m g√¨?", options: ["R·∫Ω nh√°nh ƒëi·ªÅu ki·ªán", "G·ªôp d·ªØ li·ªáu t·ª´ nhi·ªÅu nh√°nh/ngu·ªìn", "G·ªçi API", "T·∫°o th·ªùi gian tr·ªÖ"], answerIndex: 1, hint: "Merge = g·ªôp.", explanation: "Merge d√πng ƒë·ªÉ k·∫øt h·ª£p d·ªØ li·ªáu gi·ªØa 2 lu·ªìng (append, merge by key, ...)." },
            { question: "Sau khi ch·∫°y workflow, k·∫øt qu·∫£ t·ª´ng b∆∞·ªõc th∆∞·ªùng xem ·ªü ƒë√¢u?", options: ["Trong Execution (L·ªãch s·ª≠ ch·∫°y)", "Ch·ªâ ·ªü email", "Ch·ªâ ·ªü database", "Kh√¥ng xem ƒë∆∞·ª£c"], answerIndex: 0, hint: "Ch·ªó l∆∞u l·ªãch s·ª≠ ch·∫°y.", explanation: "Execution logs hi·ªÉn th·ªã input/output t·ª´ng node v√† gi√∫p debug." },
            { question: "Khi m·ªôt node tr·∫£ v·ªÅ nhi·ªÅu items, n8n s·∫Ω x·ª≠ l√Ω nh∆∞ th·∫ø n√†o m·∫∑c ƒë·ªãnh?", options: ["Ch·ªâ l·∫•y item ƒë·∫ßu", "L·∫∑p node theo t·ª´ng item (item-based)", "B·ªè qua t·∫•t c·∫£", "T·ª± g·ªôp th√†nh 1 item"], answerIndex: 1, hint: "n8n theo t·ª´ng item.", explanation: "n8n th∆∞·ªùng ch·∫°y theo items: m·ªói item l√† m·ªôt b·∫£n ghi ƒë∆∞·ª£c x·ª≠ l√Ω." },
            { question: "Mu·ªën l·∫•y d·ªØ li·ªáu t·ª´ node tr∆∞·ªõc, tham chi·∫øu ƒë√∫ng th∆∞·ªùng l√†?", options: ["$http.data", "{{$json.fieldName}}", "{{$env.DATA}}", "{{$node.id}}"], answerIndex: 1, hint: "$json l√† d·ªØ li·ªáu item hi·ªán t·∫°i.", explanation: "{{$json.field}} l√† c√°ch ph·ªï bi·∫øn ƒë·ªÉ l·∫•y field ·ªü item hi·ªán t·∫°i." },
            { question: "ƒêi·ªÅu g√¨ n√™n l√†m ƒë·ªÉ gi·∫£m l·ªói khi g·ªçi API trong HTTP Request?", options: ["Kh√¥ng d√πng credentials", "Th√™m retry/handle l·ªói, ki·ªÉm tra status code", "Lu√¥n d√πng GET", "T·∫Øt SSL"], answerIndex: 1, hint: "X·ª≠ l√Ω l·ªói + retry.", explanation: "Thi·∫øt l·∫≠p retry/timeout v√† x·ª≠ l√Ω status code gi√∫p workflow b·ªÅn v·ªØng h∆°n." },
            { question: "Node n√†o ph√π h·ª£p ƒë·ªÉ x·ª≠ l√Ω ƒëi·ªÅu ki·ªán ‚Äún·∫øu field r·ªóng th√¨ set default‚Äù m√† kh√¥ng vi·∫øt code?", options: ["Set + Expression", "Webhook", "Cron", "Wait"], answerIndex: 0, hint: "Set k·∫øt h·ª£p expression.", explanation: "Set node + expression c√≥ th·ªÉ g√°n gi√° tr·ªã m·∫∑c ƒë·ªãnh khi field thi·∫øu/r·ªóng." },
            { question: "Khi c·∫ßn debug d·ªØ li·ªáu ƒëi qua t·ª´ng node, c√°ch nhanh nh·∫•t l√†?", options: ["X√≥a workflow", "Xem output node trong execution / pin data", "Restart m√°y", "Chuy·ªÉn sang tool kh√°c"], answerIndex: 1, hint: "Xem output t·ª´ng node.", explanation: "Xem d·ªØ li·ªáu output trong execution v√† d√πng pin data gi√∫p debug nhanh." },
            { question: "Node ‚ÄúFunction/Code‚Äù d√πng khi n√†o l√† h·ª£p l√Ω?", options: ["M·ªçi l√∫c", "Khi c·∫ßn logic ph·ª©c t·∫°p m√† node c√≥ s·∫µn kh√≥ l√†m", "Ch·ªâ ƒë·ªÉ g·ªçi API", "Ch·ªâ ƒë·ªÉ m·ªü UI"], answerIndex: 1, hint: "Khi c·∫ßn custom logic.", explanation: "∆Øu ti√™n node built-in; d√πng code khi c·∫ßn x·ª≠ l√Ω n√¢ng cao." },
          ],
          hard: [
            { question: "Trong n8n, ‚ÄúContinue On Fail‚Äù c√≥ √≠ch nh·∫•t khi n√†o?", options: ["Mu·ªën workflow d·ª´ng ngay khi l·ªói", "Mu·ªën node l·ªói nh∆∞ng workflow v·∫´n ch·∫°y ti·∫øp", "Mu·ªën tƒÉng t·ªëc CPU", "Mu·ªën ƒë·ªïi UI theme"], answerIndex: 1, hint: "Kh√¥ng d·ª´ng workflow v√¨ 1 l·ªói.", explanation: "Continue On Fail gi√∫p workflow kh√¥ng b·ªã d·ª´ng to√†n b·ªô n·∫øu m·ªôt node g·∫∑p l·ªói." },
            { question: "B·∫°n mu·ªën ch·ªâ ch·∫°y nh√°nh True c·ªßa IF v√† b·ªè nh√°nh False, l√†m c√°ch n√†o ƒë√∫ng?", options: ["X√≥a nh√°nh False ho·∫∑c kh√¥ng n·ªëi node sau False", "B·∫Øt bu·ªôc n·ªëi c·∫£ 2 nh√°nh", "Ch·ªâ ƒë·ªïi m√†u node", "Kh√¥ng th·ªÉ"], answerIndex: 0, hint: "Nh√°nh kh√¥ng n·ªëi th√¨ kh√¥ng ch·∫°y.", explanation: "Nh√°nh n√†o kh√¥ng c√≥ node ph√≠a sau th√¨ kh√¥ng th·ª±c thi th√™m." },
            { question: "Khi mu·ªën g·ªôp d·ªØ li·ªáu 2 nh√°nh theo m·ªôt kh√≥a (id/email), n√™n d√πng ki·ªÉu merge n√†o?", options: ["Append", "Merge By Key / Combine", "Pass-through", "Wait"], answerIndex: 1, hint: "Theo kh√≥a chung.", explanation: "Merge by key (combine) gi√∫p match item theo m·ªôt field kh√≥a." },
            { question: "N·∫øu workflow x·ª≠ l√Ω nhi·ªÅu items v√† b·∫°n mu·ªën gi·∫£m s·ªë l·∫ßn g·ªçi API, chi·∫øn l∆∞·ª£c h·ª£p l√Ω l√†?", options: ["G·ªçi API t·ª´ng item", "Batch/aggregate tr∆∞·ªõc, r·ªìi g·ªçi √≠t l·∫ßn", "TƒÉng s·ªë node", "T·∫Øt logs"], answerIndex: 1, hint: "G·ªôp tr∆∞·ªõc khi g·ªçi.", explanation: "Batch h√≥a gi√∫p gi·∫£m s·ªë request, gi·∫£m rate-limit." },
            { question: "Trong Expression, to√°n t·ª≠ 3 ng√¥i (ternary) d√πng ƒë·ªÉ l√†m g√¨?", options: ["T·∫°o array", "Vi·∫øt ƒëi·ªÅu ki·ªán ng·∫Øn g·ªçn: condition ? A : B", "ƒê·ªïi timezone", "G·ªçi HTTP"], answerIndex: 1, hint: "condition ? ... : ...", explanation: "Ternary gi√∫p ƒë·∫∑t logic if-else nhanh trong m·ªôt expression." },
            { question: "B·∫°n mu·ªën l·∫•y d·ªØ li·ªáu output t·ª´ m·ªôt node c·ª• th·ªÉ, c√°ch tham chi·∫øu ph·ªï bi·∫øn l√†?", options: ["{{$node['T√™n Node'].json.field}}", "{{$json.node.field}}", "{{$workflow.field}}", "{{$cred.field}}"], answerIndex: 0, hint: "Tham chi·∫øu theo t√™n node.", explanation: "Tham chi·∫øu d·ªØ li·ªáu theo node: {{$node['NodeName'].json.field}}." },
            { question: "Khi d√πng Webhook Trigger, m√¥i tr∆∞·ªùng Test vs Production th∆∞·ªùng kh√°c nhau ·ªü ƒëi·ªÉm n√†o?", options: ["Kh√¥ng kh√°c", "URL endpoint v√† h√†nh vi listen", "Ch·ªâ kh√°c m√†u", "Ch·ªâ kh√°c ng√¥n ng·ªØ"], answerIndex: 1, hint: "Test URL & Prod URL.", explanation: "Webhook th∆∞·ªùng c√≥ test URL (khi listen) v√† production URL." },
            { question: "Mu·ªën tr√°nh l·ªô API key trong workflow, c√°ch l√†m ƒë√∫ng l√†?", options: ["Hardcode API key", "L∆∞u API key trong Credentials/ENV v√† tham chi·∫øu", "G·ª≠i key qua chat", "D√°n v√†o ghi ch√∫"], answerIndex: 1, hint: "Credentials l√† n∆°i d√†nh cho key.", explanation: "L∆∞u key ·ªü Credentials ho·∫∑c bi·∫øn m√¥i tr∆∞·ªùng, kh√¥ng hardcode." },
            { question: "N·∫øu m·ªôt node c·∫ßn retry khi l·ªói 429 (rate limit), c√°ch ti·∫øp c·∫≠n h·ª£p l√Ω l√†?", options: ["Spam li√™n t·ª•c", "Delay/backoff + retry c√≥ gi·ªõi h·∫°n", "T·∫Øt HTTPS", "ƒê·ªïi endpoint ng·∫´u nhi√™n"], answerIndex: 1, hint: "Backoff.", explanation: "Backoff + retry gi·ªõi h·∫°n gi√∫p tu√¢n th·ªß rate limit." },
            { question: "Mu·ªën l∆∞u log c√≥ c·∫•u tr√∫c ƒë·ªÉ audit, n√™n l√†m g√¨?", options: ["Ch·ªâ xem m√†n h√¨nh", "Ghi log ra DB/Sheet/Storage c√≥ schema + l∆∞u execution id", "X√≥a execution", "T·∫Øt execution history"], answerIndex: 1, hint: "L∆∞u log c√≥ tr∆∞·ªùng v√† id.", explanation: "Ghi log c√≥ c·∫•u tr√∫c gi√∫p audit/tra c·ª©u theo execution id." },
          ]
        }
      };

      /** =========================
       *  DOM helpers
       *  ========================= */
      const $ = (sel, root=document) => root.querySelector(sel);
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const pad2 = (n) => String(n).padStart(2, "0");
      const fmtTime = (sec) => {
        sec = Math.max(0, Math.floor(sec));
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${pad2(m)}:${pad2(s)}`;
      };

      /** =========================
       *  DOM refs
       *  ========================= */
      const brandLogo = $("#brandLogo");
      const brandTitle = $("#brandTitle");
      const brandTagline = $("#brandTagline");

      const canvas = $("#game");
      const ctx = canvas.getContext("2d", { alpha: true, desynchronized: true });

      const startOverlay = $("#startOverlay");
      const btnStart = $("#btnStart");
      const btnStartTop = $("#btnStartTop");
      const btnReset = $("#btnReset");
      const btnExport = $("#btnExport");
      const btnTeacher = $("#btnTeacher");

      const selDifficulty = $("#selDifficulty");
      const inpMinutes = $("#inpMinutes");
      const btnWarmup = $("#btnWarmup");

      const statusDot = $("#statusDot");
      const statusText = $("#statusText");
      const timerText = $("#timerText");
      const scoreText = $("#scoreText");
      const livesText = $("#livesText");
      const progressText = $("#progressText");

      const toast = $("#toast");

      // Question modal
      const questionModal = $("#questionModal");
      const btnCloseQuestion = $("#btnCloseQuestion");
      const qTitle = $("#qTitle");
      const qMeta = $("#qMeta");
      const qText = $("#qText");
      const qChoices = $("#qChoices");
      const qFeedback = $("#qFeedback");
      const qBadge = $("#qBadge");
      const qShort = $("#qShort");
      const qHint = $("#qHint");
      const qExplain = $("#qExplain");
      const btnReveal = $("#btnReveal");
      const btnContinue = $("#btnContinue");
      const btnGameOver = $("#btnGameOver");

      // Export modal
      const exportModal = $("#exportModal");
      const btnCloseExport = $("#btnCloseExport");
      const exportPreview = $("#exportPreview");
      const btnDownloadImage = $("#btnDownloadImage");
      const btnCopyImage = $("#btnCopyImage");
      const exportCanvas = $("#exportCanvas");
      const exportCtx = exportCanvas.getContext("2d");

      // Teacher
      const teacherDrawer = $("#teacherDrawer");
      const drawerBackdrop = $("#drawerBackdrop");
      const btnCloseTeacher = $("#btnCloseTeacher");
      const teacherLockCard = $("#teacherLockCard");
      const inpTeacherPass = $("#inpTeacherPass");
      const btnUnlockTeacher = $("#btnUnlockTeacher");
      const teacherPanel = $("#teacherPanel");
      const selDifficultyTeacher = $("#selDifficultyTeacher");
      const inpMinutesTeacher = $("#inpMinutesTeacher");
      const btnTeacherStart = $("#btnTeacherStart");
      const btnTeacherPause = $("#btnTeacherPause");
      const btnTeacherReset = $("#btnTeacherReset");
      const btnTeacherOpenQ = $("#btnTeacherOpenQ");
      const btnTeacherNextQ = $("#btnTeacherNextQ");
      const btnTeacherRevealQ = $("#btnTeacherRevealQ");
      const teacherQMeta = $("#teacherQMeta");

      /** =========================
       *  Toast / modal / drawer
       *  ========================= */
      let toastT = 0;
      function showToast(message, tagText = "INFO", kind = "info"){
        toast.innerHTML = "";
        const tag = document.createElement("span");
        tag.className = "tag " + (kind === "ok" ? "ok" : kind === "bad" ? "bad" : "");
        tag.textContent = tagText;
        const msg = document.createElement("span");
        msg.textContent = message;
        toast.append(tag, msg);
        toast.classList.add("show");
        clearTimeout(toastT);
        toastT = window.setTimeout(() => toast.classList.remove("show"), 2200);
      }

      function openModal(modalEl){
        modalEl.classList.add("open");
        modalEl.setAttribute("aria-hidden", "false");
      }
      function closeModal(modalEl){
        modalEl.classList.remove("open");
        modalEl.setAttribute("aria-hidden", "true");
      }

      function openDrawer(){
        teacherDrawer.classList.add("open");
        drawerBackdrop.classList.add("show");
        drawerBackdrop.setAttribute("aria-hidden", "false");
      }
      function closeDrawer(){
        teacherDrawer.classList.remove("open");
        drawerBackdrop.classList.remove("show");
        drawerBackdrop.setAttribute("aria-hidden", "true");
      }

      /** =========================
       *  Status
       *  ========================= */
      function setStatus(kind, text){
        statusText.textContent = text;
        statusDot.classList.remove("live","pause","over");
        if (kind) statusDot.classList.add(kind);
      }

      function labelDifficulty(diff){
        if (diff === "easy") return "D·ªÖ";
        if (diff === "medium") return "Trung b√¨nh";
        if (diff === "hard") return "Kh√≥";
        return diff;
      }

      /** =========================
       *  Game state
       *  ========================= */
      const GAME = {
        state: "idle", // idle | running | paused | question | over | finished
        difficulty: "easy",
        questions: [],
        qIndex: 0,
        answered: 0,
        livesPlus: 0,
        score: 0,
        timeTotal: 300,
        timeLeft: 300,
        lastTick: 0,
        accSpawn: 0,
        accParallax: 0,
        rngSeed: 1234567,
        pendingDeath: false,
        lastQuestionWasWarmup: false,
        revealRequested: false,
        teacherUnlocked: false,

        bird: { x: 0, y: 0, vy: 0, rot: 0 },
        pipes: [],
        pipeId: 0,
        scale: 1,
      };

      const now = () => performance.now();

      function rand01(){
        let x = GAME.rngSeed | 0;
        x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
        GAME.rngSeed = x;
        return ((x >>> 0) / 4294967296);
      }

      function pickSet(diff){
        const set = CONFIG.questionSets[diff] || CONFIG.questionSets.easy;
        return set.map(q => ({
          question: q.question,
          options: [...q.options],
          answerIndex: q.answerIndex,
          hint: q.hint || "",
          explanation: q.explanation || "",
        }));
      }

      function applyDifficulty(diff){
        GAME.difficulty = diff;
        GAME.questions = pickSet(diff);
        GAME.qIndex = 0;
        GAME.answered = 0;
        updateProgress();
        updateTeacherMeta();
      }

      function applyMinutes(minutes){
        const m = clamp(Number(minutes || 5), 1, 60);
        GAME.timeTotal = m * 60;
        GAME.timeLeft = m * 60;
        timerText.textContent = fmtTime(GAME.timeLeft);
      }

      function updateProgress(){
        const total = GAME.questions.length || 0;
        progressText.textContent = `${Math.min(GAME.answered, total)}/${total}`;
      }

      function updateHUD(){
        scoreText.textContent = String(GAME.score);
        livesText.textContent = String(GAME.livesPlus);
        timerText.textContent = fmtTime(GAME.timeLeft);
        updateProgress();
      }

      function updateTeacherMeta(){
        const total = GAME.questions.length || 0;
        teacherQMeta.textContent = `Set: ${labelDifficulty(GAME.difficulty)} ‚Ä¢ Con tr·ªè: ${GAME.qIndex}/${total}`;
      }

      function setState(next){
        GAME.state = next;
        if (next === "idle") setStatus("", "Idle");
        else if (next === "running") setStatus("live", "Running");
        else if (next === "paused") setStatus("pause", "Paused");
        else if (next === "question") setStatus("pause", "Question");
        else if (next === "over") setStatus("over", "Game Over");
        else if (next === "finished") setStatus("over", "Time Up");
      }

      /** =========================
       *  Canvas scale
       *  ========================= */
      function resizeCanvas(){
        const rect = canvas.getBoundingClientRect();
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        canvas.width = Math.round(rect.width * dpr);
        canvas.height = Math.round(rect.height * dpr);
        const sx = canvas.width / CONFIG.game.width;
        const sy = canvas.height / CONFIG.game.height;
        GAME.scale = Math.min(sx, sy);
      }

      /** =========================
       *  Reset / Start
       *  ========================= */
      function hardReset(){
        const w = CONFIG.game.width;
        const h = CONFIG.game.height;

        GAME.pipes = [];
        GAME.pipeId = 0;
        GAME.score = 0;
        GAME.livesPlus = 0;
        GAME.pendingDeath = false;
        GAME.revealRequested = false;

        GAME.bird.x = w * CONFIG.game.birdX;
        GAME.bird.y = h * CONFIG.game.birdStartY;
        GAME.bird.vy = 0;
        GAME.bird.rot = 0;

        GAME.accSpawn = 0;
        GAME.accParallax = 0;
        GAME.rngSeed = (Date.now() & 0xffffffff) ^ 0xA5A5A5A5;

        updateHUD();
        drawFrame(0);
      }

      function startFromUI(){
        // Always apply UI first
        const diff = selDifficulty.value;
        const mins = inpMinutes.value;
        applyDifficulty(diff);
        applyMinutes(mins);
        if (GAME.teacherUnlocked){
          selDifficultyTeacher.value = diff;
          inpMinutesTeacher.value = String(Math.round(GAME.timeTotal/60));
          updateTeacherMeta();
        }
        hardReset();
        startGame();
      }

      function startGame(){
        if (GAME.state === "running") return;
        startOverlay.hidden = true;
        setState("running");
        GAME.lastTick = now();
        showToast("B·∫Øt ƒë·∫ßu! Space/ch·∫°m ƒë·ªÉ bay.", "GO", "ok");
        requestAnimationFrame(loop);
      }

      function pauseToggle(){
        if (GAME.state === "running"){
          setState("paused");
          showToast("ƒê√£ t·∫°m d·ª´ng. Nh·∫•n P ƒë·ªÉ ti·∫øp t·ª•c.", "PAUSE", "info");
        } else if (GAME.state === "paused"){
          setState("running");
          GAME.lastTick = now();
          showToast("Ti·∫øp t·ª•c!", "PLAY", "ok");
          requestAnimationFrame(loop);
        }
      }

      function endGame(kind){
        if (GAME.state === "over" || GAME.state === "finished") return;
        if (kind === "timeup"){
          setState("finished");
          showToast("H·∫øt gi·ªù! C√≥ th·ªÉ xu·∫•t k·∫øt qu·∫£.", "TIME", "info");
        } else {
          setState("over");
          showToast("Game Over. Reset ƒë·ªÉ ch∆°i l·∫°i ho·∫∑c xu·∫•t k·∫øt qu·∫£.", "OVER", "bad");
        }
        startOverlay.hidden = false;
      }

      function resetAll(){
        setState("idle");
        closeModal(questionModal);
        closeModal(exportModal);
        startOverlay.hidden = false;
        // apply current UI values, but do not auto-start
        applyDifficulty(selDifficulty.value);
        applyMinutes(inpMinutes.value);
        hardReset();
        showToast("ƒê√£ reset. B·∫•m Start ƒë·ªÉ ch∆°i.", "RESET", "info");
      }

      /** =========================
       *  Gameplay
       *  ========================= */
      function flap(){
        if (GAME.state === "idle") return startFromUI();
        if (GAME.state !== "running") return;
        GAME.bird.vy = CONFIG.game.flapVelocity;
      }

      function spawnPipe(){
        const g = CONFIG.game;
        const h = g.height;
        const gap = g.pipeGap;
        const minTop = g.pipeMinTop;
        const minBottom = g.pipeMinBottom;
        const available = h - minTop - minBottom - gap;
        const topH = minTop + Math.floor(rand01() * Math.max(1, available));

        GAME.pipes.push({
          id: ++GAME.pipeId,
          x: g.width + 40,
          topH,
          gapH: gap,
          passed: false,
        });
      }

      function rectCircleCollide(rx, ry, rw, rh, cx, cy, cr){
        const closestX = clamp(cx, rx, rx + rw);
        const closestY = clamp(cy, ry, ry + rh);
        const dx = cx - closestX;
        const dy = cy - closestY;
        return (dx*dx + dy*dy) <= cr*cr;
      }

      function checkCollisions(){
        const g = CONFIG.game;
        const h = g.height;
        const b = GAME.bird;
        const r = g.birdRadius;

        if (b.y - r < 0) return "ceiling";
        if (b.y + r > h) return "ground";

        for (const p of GAME.pipes){
          const px = p.x;
          const pw = g.pipeWidth;
          const topH = p.topH;
          const gapH = p.gapH;

          if (rectCircleCollide(px, 0, pw, topH, b.x, b.y, r)) return "pipe";
          const by = topH + gapH;
          const bh = h - by;
          if (rectCircleCollide(px, by, pw, bh, b.x, b.y, r)) return "pipe";

          if (!p.passed && (b.x > px + pw)){
            p.passed = true;
            GAME.score += g.scorePerGate;
          }
        }
        return "";
      }

      function getNextQuestion(){
        if (GAME.qIndex >= GAME.questions.length) return null;
        return GAME.questions[GAME.qIndex];
      }

      function consumeQuestion(){
        GAME.qIndex += 1;
        GAME.answered += 1;
        updateHUD();
        updateTeacherMeta();
      }

      function reviveAfterCorrect(){
        const w = CONFIG.game.width;
        const h = CONFIG.game.height;

        GAME.bird.x = w * CONFIG.game.birdX;
        GAME.bird.y = h * CONFIG.game.birdStartY;
        GAME.bird.vy = 0;
        GAME.bird.rot = 0;

        GAME.pipes = [];
        GAME.accSpawn = 0;
        GAME.pendingDeath = false;

        GAME.livesPlus += 1;
        GAME.score += CONFIG.game.bonusCorrect;
        updateHUD();
      }

      function handleDeath(){
        if (GAME.state !== "running") return;
        GAME.pendingDeath = true;
        setState("question");

        const q = getNextQuestion();
        if (!q){
          endGame("over");
          return;
        }
        openQuestionModal(q, { isWarmup:false });
      }

      /** =========================
       *  Question UI
       *  ========================= */
      function clearFeedback(){
        qFeedback.hidden = true;
        qHint.textContent = "";
        qExplain.textContent = "";
        btnContinue.hidden = true;
        btnGameOver.hidden = true;
        qChoices.querySelectorAll(".choice").forEach(el => {
          el.classList.remove("correct","wrong","reveal");
          el.disabled = false;
        });
        GAME.revealRequested = false;
      }

      function buildChoices(q){
        qChoices.innerHTML = "";
        const letters = ["A","B","C","D","E","F"];
        q.options.forEach((opt, idx) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "choice";
          btn.setAttribute("data-idx", String(idx));
          btn.setAttribute("aria-label", `Ch·ªçn ƒë√°p √°n ${letters[idx]}`);

          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = letters[idx];

          const text = document.createElement("span");
          text.textContent = opt;

          btn.append(badge, text);
          qChoices.appendChild(btn);
        });
      }

      function setFeedback({ kind="info", title="", hint="", explain="" }){
        qFeedback.hidden = false;
        qBadge.className = "badge2 " + (kind === "ok" ? "ok" : kind === "bad" ? "bad" : "info");
        qBadge.textContent = kind === "ok" ? "ƒê√öNG" : kind === "bad" ? "SAI" : "G·ª¢I √ù";
        qShort.textContent = title;
        qHint.textContent = hint ? `Hint: ${hint}` : "";
        qExplain.textContent = explain ? `Explanation: ${explain}` : "";
      }

      function highlightCorrect(q){
        qChoices.querySelectorAll(".choice").forEach(el => {
          const idx = Number(el.getAttribute("data-idx"));
          if (idx === q.answerIndex) el.classList.add("reveal");
        });
      }

      function openQuestionModal(q, { isWarmup=false } = {}){
        GAME.lastQuestionWasWarmup = !!isWarmup;
        qTitle.textContent = isWarmup ? "Demo c√¢u h·ªèi" : "C√¢u h·ªèi c·ª©u m·∫°ng";
        qMeta.textContent = `Set: ${labelDifficulty(GAME.difficulty)} ‚Ä¢ C√¢u ${Math.min(GAME.qIndex+1, GAME.questions.length)}/${GAME.questions.length}`;
        qText.textContent = q.question;

        clearFeedback();
        buildChoices(q);
        openModal(questionModal);

        const first = qChoices.querySelector(".choice");
        if (first) first.focus({ preventScroll:true });

        if (GAME.revealRequested){
          highlightCorrect(q);
          setFeedback({ kind:"info", title:"Teacher Reveal", hint:q.hint, explain:q.explanation });
        }
      }

      function closeQuestionModal(){
        closeModal(questionModal);
      }

      function onAnswerSelected(idx){
        const q = getNextQuestion();
        if (!q) return;

        qChoices.querySelectorAll(".choice").forEach(el => el.disabled = true);

        const correct = (idx === q.answerIndex);

        qChoices.querySelectorAll(".choice").forEach(el => {
          const i = Number(el.getAttribute("data-idx"));
          if (i === q.answerIndex) el.classList.add("correct");
          if (i === idx && !correct) el.classList.add("wrong");
        });

        consumeQuestion();

        if (correct){
          setFeedback({ kind:"ok", title:"Chu·∫©n! H·ªìi sinh + th∆∞·ªüng ƒëi·ªÉm.", hint:q.hint, explain:q.explanation });
          btnContinue.hidden = false;
          btnGameOver.hidden = true;
          showToast("Tr·∫£ l·ªùi ƒë√∫ng! H·ªìi sinh +5 ƒëi·ªÉm.", "OK", "ok");
        } else {
          setFeedback({ kind:"bad", title:"Sai r·ªìi ‚Äî k·∫øt th√∫c l∆∞·ª£t ch∆°i.", hint:q.hint, explain:q.explanation });
          btnContinue.hidden = true;
          btnGameOver.hidden = false;
          showToast("Tr·∫£ l·ªùi sai. Game Over.", "NO", "bad");
        }
      }

      /** =========================
       *  Render
       *  ========================= */
      function roundRect(x, y, w, h, r, fill, stroke){
        const rr = Math.min(r, w/2, h/2);
        ctx.beginPath();
        ctx.moveTo(x+rr, y);
        ctx.arcTo(x+w, y, x+w, y+h, rr);
        ctx.arcTo(x+w, y+h, x, y+h, rr);
        ctx.arcTo(x, y+h, x, y, rr);
        ctx.arcTo(x, y, x+w, y, rr);
        ctx.closePath();
        if (fill) ctx.fill();
        if (stroke) ctx.stroke();
      }

      function drawBackground(t){
        const w = CONFIG.game.width;
        const h = CONFIG.game.height;
        const g = ctx.createLinearGradient(0, 0, 0, h);
        g.addColorStop(0, "rgba(74,163,255,.20)");
        g.addColorStop(0.55, "rgba(43,109,255,.10)");
        g.addColorStop(1, "rgba(6,11,26,.25)");
        ctx.fillStyle = g;
        ctx.fillRect(0,0,w,h);

        const sp = CONFIG.game.parallaxSpeed;
        GAME.accParallax += (t * 0.00002 * sp);
        const off = (GAME.accParallax % 1);

        ctx.globalAlpha = 0.6;
        for (let i=0;i<90;i++){
          const x = (i*137.2 + off*w*0.6) % w;
          const y = (i*61.8 + off*h*0.35) % h;
          const r = (i%5===0? 2.2 : 1.4);
          ctx.fillStyle = "rgba(234,240,255,.18)";
          ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        ctx.fillStyle = "rgba(255,255,255,.05)";
        ctx.fillRect(0, h-90, w, 2);
      }

      function drawPipes(){
        const g = CONFIG.game;
        const h = g.height;

        for (const p of GAME.pipes){
          const x = p.x;
          const pw = g.pipeWidth;
          const topH = p.topH;
          const gapH = p.gapH;
          const bottomY = topH + gapH;

          const grad = ctx.createLinearGradient(x, 0, x+pw, 0);
          grad.addColorStop(0, "rgba(74,163,255,.18)");
          grad.addColorStop(0.5, "rgba(49,211,154,.10)");
          grad.addColorStop(1, "rgba(74,163,255,.14)");

          ctx.fillStyle = grad;
          ctx.strokeStyle = "rgba(255,255,255,.10)";
          ctx.lineWidth = 2;

          roundRect(x, 0, pw, topH, 18, true, true);
          roundRect(x, bottomY, pw, h-bottomY, 18, true, true);

          ctx.fillStyle = "rgba(255,255,255,.06)";
          ctx.fillRect(x-6, topH-22, pw+12, 20);
          ctx.fillRect(x-6, bottomY, pw+12, 20);
        }
      }

      function drawBird(){
        const b = GAME.bird;
        const r = CONFIG.game.birdRadius;

        const vy = clamp(b.vy, -900, 1200);
        const rot = clamp(vy / 1200, -1, 1) * CONFIG.game.tiltMax;
        b.rot = rot;

        ctx.save();
        ctx.translate(b.x, b.y);
        ctx.rotate(rot);

        const bodyGrad = ctx.createLinearGradient(-r, -r, r, r);
        bodyGrad.addColorStop(0, "rgba(74,163,255,.92)");
        bodyGrad.addColorStop(1, "rgba(43,109,255,.65)");
        ctx.fillStyle = bodyGrad;
        ctx.strokeStyle = "rgba(255,255,255,.14)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(0,0,r,0,Math.PI*2);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = "rgba(234,240,255,.14)";
        ctx.beginPath();
        ctx.ellipse(-6, 6, r*0.55, r*0.35, -0.3, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = "rgba(234,240,255,.92)";
        ctx.beginPath();
        ctx.arc(8,-6,6,0,Math.PI*2);
        ctx.fill();
        ctx.fillStyle = "rgba(6,11,26,.85)";
        ctx.beginPath();
        ctx.arc(9,-6,2.4,0,Math.PI*2);
        ctx.fill();

        ctx.fillStyle = "rgba(255,204,102,.95)";
        ctx.strokeStyle = "rgba(255,255,255,.10)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(r-2, 0);
        ctx.lineTo(r+14, 5);
        ctx.lineTo(r+14, -5);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();

        ctx.restore();
      }

      function drawHUDOverlay(){
        const w = CONFIG.game.width;
        const h = CONFIG.game.height;
        const vg = ctx.createRadialGradient(w*0.5,h*0.45, 200, w*0.5,h*0.45, 900);
        vg.addColorStop(0, "rgba(0,0,0,0)");
        vg.addColorStop(1, "rgba(0,0,0,.35)");
        ctx.fillStyle = vg;
        ctx.fillRect(0,0,w,h);
      }

      function drawFrame(t){
        ctx.setTransform(GAME.scale, 0, 0, GAME.scale, 0, 0);
        ctx.clearRect(0,0, CONFIG.game.width, CONFIG.game.height);
        drawBackground(t);
        drawPipes();
        drawBird();
        drawHUDOverlay();
      }

      /** =========================
       *  Loop
       *  ========================= */
      function loop(t){
        if (GAME.state !== "running") return;

        const dt = clamp((t - GAME.lastTick) / 1000, 0, 0.033);
        GAME.lastTick = t;

        GAME.timeLeft -= dt;
        if (GAME.timeLeft <= 0){
          GAME.timeLeft = 0;
          updateHUD();
          drawFrame(t);
          endGame("timeup");
          return;
        }

        GAME.accSpawn += dt * 1000;
        if (GAME.accSpawn >= CONFIG.game.pipeSpawnEveryMs){
          GAME.accSpawn = 0;
          spawnPipe();
        }

        for (const p of GAME.pipes){
          p.x -= CONFIG.game.pipeSpeed * dt;
        }
        GAME.pipes = GAME.pipes.filter(p => p.x > -CONFIG.game.pipeWidth - 80);

        const b = GAME.bird;
        b.vy += CONFIG.game.gravity * dt;
        b.vy = clamp(b.vy, -1200, CONFIG.game.maxFallVelocity);
        b.y += b.vy * dt;

        const hit = checkCollisions();
        if (hit){
          updateHUD();
          drawFrame(t);
          handleDeath();
          return;
        }

        timerText.textContent = fmtTime(GAME.timeLeft);
        scoreText.textContent = String(GAME.score);

        drawFrame(t);
        requestAnimationFrame(loop);
      }

      /** =========================
       *  Export
       *  ========================= */
      function roundRect2(c, x, y, w, h, r, fillStyle, strokeStyle){
        const rr = Math.min(r, w/2, h/2);
        c.beginPath();
        c.moveTo(x+rr, y);
        c.arcTo(x+w, y, x+w, y+h, rr);
        c.arcTo(x+w, y+h, x, y+h, rr);
        c.arcTo(x, y+h, x, y, rr);
        c.arcTo(x, y, x+w, y, rr);
        c.closePath();
        c.fillStyle = fillStyle;
        c.fill();
        c.strokeStyle = strokeStyle;
        c.lineWidth = 2;
        c.stroke();
      }

      function glowCircle(c, x,y,r,color){
        const gr = c.createRadialGradient(x,y, 0, x,y, r);
        gr.addColorStop(0, color);
        gr.addColorStop(1, "rgba(0,0,0,0)");
        c.fillStyle = gr;
        c.beginPath();
        c.arc(x,y,r,0,Math.PI*2);
        c.fill();
      }

      function makeExportImage(){
        const w = exportCanvas.width;
        const h = exportCanvas.height;
        const c = exportCtx;

        const g = c.createLinearGradient(0, 0, w, h);
        g.addColorStop(0, "#060b1a");
        g.addColorStop(0.55, "#0b1533");
        g.addColorStop(1, "#0a1433");
        c.fillStyle = g;
        c.fillRect(0,0,w,h);

        c.globalAlpha = 0.9;
        glowCircle(c, w*0.18, h*0.18, 260, "rgba(74,163,255,.22)");
        glowCircle(c, w*0.86, h*0.22, 280, "rgba(49,211,154,.16)");
        glowCircle(c, w*0.60, h*0.95, 340, "rgba(43,109,255,.14)");
        c.globalAlpha = 1;

        try{
          c.save();
          c.globalAlpha = 0.55;
          c.drawImage(canvas, w*0.54, h*0.16, w*0.42, h*0.68);
          c.restore();
        } catch(e){ /* ignore */ }

        const cardX = 48, cardY = 48, cardW = Math.floor(w*0.60), cardH = h - 96;
        roundRect2(c, cardX, cardY, cardW, cardH, 26, "rgba(255,255,255,.05)", "rgba(255,255,255,.12)");

        c.fillStyle = "rgba(234,240,255,.96)";
        c.font = "900 44px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
        c.fillText(CONFIG.text.brand, cardX + 26, cardY + 74);

        c.fillStyle = "rgba(169,183,229,.95)";
        c.font = "600 16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
        c.fillText(CONFIG.text.tagline, cardX + 26, cardY + 104);

        const items = [
          ["Set", labelDifficulty(GAME.difficulty)],
          ["Score", String(GAME.score)],
          ["Lives+", String(GAME.livesPlus)],
          ["Progress", `${GAME.answered}/${GAME.questions.length}`],
          ["Time Left", fmtTime(GAME.timeLeft)],
          ["Status", GAME.state.toUpperCase()],
        ];

        let y = cardY + 150;
        for (const [k,v] of items){
          roundRect2(c, cardX + 26, y, 520, 44, 14, "rgba(255,255,255,.04)", "rgba(255,255,255,.10)");
          c.fillStyle = "rgba(169,183,229,.95)";
          c.font = "700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
          c.fillText(k, cardX + 26 + 16, y + 28);

          c.fillStyle = "rgba(234,240,255,.96)";
          c.font = "900 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
          c.fillText(v, cardX + 26 + 240, y + 30);
          y += 58;
        }

        c.fillStyle = "rgba(234,240,255,.78)";
        c.font = "600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
        c.fillText(`Generated: ${new Date().toLocaleString()}`, cardX + 26, cardY + cardH - 28);

        return exportCanvas.toDataURL("image/png");
      }

      async function copyPngToClipboard(dataUrl){
        try{
          if (!navigator.clipboard || !window.ClipboardItem) throw new Error("Clipboard not supported");
          const res = await fetch(dataUrl);
          const blob = await res.blob();
          await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
          showToast("ƒê√£ copy ·∫£nh v√†o clipboard!", "COPY", "ok");
        } catch(e){
          showToast("Kh√¥ng copy ƒë∆∞·ª£c (tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£). H√£y t·∫£i PNG.", "INFO", "info");
        }
      }

      /** =========================
       *  Events
       *  ========================= */
      function bindEvents(){
        btnStart.addEventListener("click", startFromUI);
        btnStartTop.addEventListener("click", () => {
          if (GAME.state === "running") return;
          if (GAME.state === "paused") return pauseToggle();
          startFromUI();
        });

        btnReset.addEventListener("click", resetAll);

        btnWarmup.addEventListener("click", () => {
          applyDifficulty(selDifficulty.value);
          applyMinutes(inpMinutes.value);
          const q = getNextQuestion();
          if (!q){
            showToast("H·∫øt c√¢u h·ªèi trong set. Reset ƒë·ªÉ n·∫°p l·∫°i.", "INFO", "info");
            return;
          }
          questionModal.dataset.prevState = GAME.state;
          setState("question");
          openQuestionModal(q, { isWarmup:true });
        });

        btnExport.addEventListener("click", () => {
          const url = makeExportImage();
          exportPreview.src = url;
          btnDownloadImage.href = url;
          openModal(exportModal);
          btnDownloadImage.focus({ preventScroll:true });
        });

        btnCloseExport.addEventListener("click", () => closeModal(exportModal));
        exportModal.addEventListener("click", (e) => { if (e.target === exportModal) closeModal(exportModal); });
        btnCopyImage.addEventListener("click", async () => {
          const url = exportPreview.src;
          if (!url) return;
          await copyPngToClipboard(url);
        });

        btnTeacher.addEventListener("click", () => {
          openDrawer();
          if (!GAME.teacherUnlocked) inpTeacherPass.focus({ preventScroll:true });
        });
        btnCloseTeacher.addEventListener("click", closeDrawer);
        drawerBackdrop.addEventListener("click", closeDrawer);

        btnUnlockTeacher.addEventListener("click", () => {
          const pass = String(inpTeacherPass.value || "");
          if (pass === CONFIG.teacher.password){
            GAME.teacherUnlocked = true;
            teacherLockCard.hidden = true;
            teacherPanel.hidden = false;
            selDifficultyTeacher.value = selDifficulty.value;
            inpMinutesTeacher.value = String(Math.round(GAME.timeTotal/60));
            updateTeacherMeta();
            showToast("Teacher Mode unlocked.", "OK", "ok");
          } else {
            showToast("Sai m·∫≠t kh·∫©u.", "NO", "bad");
            inpTeacherPass.focus({ preventScroll:true });
          }
        });
        inpTeacherPass.addEventListener("keydown", (e) => { if (e.key === "Enter") btnUnlockTeacher.click(); });

        selDifficultyTeacher.addEventListener("change", () => {
          selDifficulty.value = selDifficultyTeacher.value;
          applyDifficulty(selDifficulty.value);
          showToast(`ƒê√£ ch·ªçn set: ${labelDifficulty(GAME.difficulty)}`, "SET", "info");
        });
        inpMinutesTeacher.addEventListener("change", () => {
          inpMinutes.value = inpMinutesTeacher.value;
          applyMinutes(inpMinutes.value);
          showToast(`Timer: ${Math.round(GAME.timeTotal/60)} ph√∫t`, "TIME", "info");
        });

        btnTeacherStart.addEventListener("click", () => {
          selDifficulty.value = selDifficultyTeacher.value;
          inpMinutes.value = inpMinutesTeacher.value;
          startFromUI();
        });
        btnTeacherPause.addEventListener("click", pauseToggle);
        btnTeacherReset.addEventListener("click", resetAll);

        btnTeacherOpenQ.addEventListener("click", () => {
          const q = getNextQuestion();
          if (!q){
            showToast("H·∫øt c√¢u h·ªèi. Reset ƒë·ªÉ n·∫°p l·∫°i.", "INFO", "info");
            return;
          }
          questionModal.dataset.prevState = GAME.state;
          setState("question");
          openQuestionModal(q, { isWarmup:true });
        });

        btnTeacherNextQ.addEventListener("click", () => {
          if (GAME.qIndex >= GAME.questions.length){
            showToast("ƒê√£ t·ªõi cu·ªëi set.", "END", "info");
            return;
          }
          GAME.qIndex += 1;
          updateTeacherMeta();
          showToast(`Next ‚Üí ${GAME.qIndex}/${GAME.questions.length}`, "NEXT", "info");
        });

        btnTeacherRevealQ.addEventListener("click", () => {
          const q = getNextQuestion();
          if (!q){
            showToast("H·∫øt c√¢u h·ªèi.", "INFO", "info");
            return;
          }
          GAME.revealRequested = true;
          if (questionModal.classList.contains("open")){
            highlightCorrect(q);
            setFeedback({ kind:"info", title:"Teacher Reveal", hint:q.hint, explain:q.explanation });
          } else {
            questionModal.dataset.prevState = GAME.state;
            setState("question");
            openQuestionModal(q, { isWarmup:true });
          }
        });

        qChoices.addEventListener("click", (e) => {
          const btn = e.target.closest(".choice");
          if (!btn) return;
          const idx = Number(btn.getAttribute("data-idx"));
          onAnswerSelected(idx);
        });

        btnReveal.addEventListener("click", () => {
          const q = getNextQuestion();
          if (!q) return;
          highlightCorrect(q);
          setFeedback({ kind:"info", title:"Reveal ƒë√°p √°n", hint:q.hint, explain:q.explanation });
          showToast("ƒê√£ reveal ƒë√°p √°n.", "REVEAL", "info");
        });

        btnContinue.addEventListener("click", () => {
          reviveAfterCorrect();
          closeQuestionModal();
          setState("running");
          GAME.lastTick = now();
          showToast("H·ªìi sinh! Bay ti·∫øp n√†o.", "LIFE", "ok");
          requestAnimationFrame(loop);
        });

        btnGameOver.addEventListener("click", () => {
          closeQuestionModal();
          endGame("over");
        });

        btnCloseQuestion.addEventListener("click", () => {
          if (GAME.pendingDeath && !GAME.lastQuestionWasWarmup){
            showToast("Ph·∫£i tr·∫£ l·ªùi ƒë·ªÉ ti·∫øp t·ª•c!", "LOCK", "bad");
            return;
          }
          closeQuestionModal();
          const prev = questionModal.dataset.prevState || "idle";
          if (prev === "running"){
            setState("running");
            GAME.lastTick = now();
            requestAnimationFrame(loop);
          } else {
            setState(prev);
          }
        });

        questionModal.addEventListener("click", (e) => { if (e.target === questionModal) btnCloseQuestion.click(); });

        // keyboard
        window.addEventListener("keydown", (e) => {
          if (e.repeat) return;

          const tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
          const typing = tag === "input" || tag === "select" || tag === "textarea";

          if (e.key === "Escape"){
            if (exportModal.classList.contains("open")) closeModal(exportModal);
            if (questionModal.classList.contains("open")) btnCloseQuestion.click();
            if (teacherDrawer.classList.contains("open")) closeDrawer();
            return;
          }

          if (!typing && e.key.toLowerCase() === "t"){
            e.preventDefault();
            if (teacherDrawer.classList.contains("open")) closeDrawer();
            else openDrawer();
            return;
          }

          if (typing) return;

          if (e.code === "Space"){
            e.preventDefault();
            flap();
          }
          if (e.key.toLowerCase() === "p") pauseToggle();
          if (e.key.toLowerCase() === "r") resetAll();
        }, { passive:false });

        canvas.addEventListener("pointerdown", () => {
          if (!startOverlay.hidden) return;
          if (questionModal.classList.contains("open")) return;
          flap();
        }, { passive:true });

        window.addEventListener("resize", () => {
          resizeCanvas();
          drawFrame(performance.now());
        }, { passive:true });
      }

      /** =========================
       *  Boot
       *  ========================= */
      function boot(){
        // brand
        brandTitle.textContent = CONFIG.text.brand;
        brandTagline.textContent = CONFIG.text.tagline;
        brandLogo.innerHTML = CONFIG.assets.logoSvg; // constant svg

        selDifficulty.value = "easy";
        inpMinutes.value = String(CONFIG.session.defaultMinutes);

        applyDifficulty("easy");
        applyMinutes(CONFIG.session.defaultMinutes);

        resizeCanvas();
        hardReset();
        setState("idle");
        startOverlay.hidden = false;

        bindEvents();
        drawFrame(performance.now());

        showToast("S·∫µn s√†ng. B·∫•m Start ƒë·ªÉ ch∆°i. Teacher Mode: n√∫t Teacher / ph√≠m T (pass: n8n).", "READY", "info");
      }

      boot();
    </script>
  </div>
</body>
</html>
