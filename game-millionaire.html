<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Who Wants to Be a Millionaire ‚Äì n8n Basic</title>
  <style>
    :root{
      --bg0:#070b16;
      --bg1:#0a1633;
      --card:#0b1b3b;
      --card2:#0a1530;
      --line:rgba(255,255,255,.10);
      --fg:#eaf1ff;
      --muted:rgba(234,241,255,.72);
      --muted2:rgba(234,241,255,.52);
      --blue:#4aa3ff;
      --blue2:#2f7dff;
      --good:#3be28f;
      --bad:#ff4d6d;
      --warn:#ffd166;

      --space-1:6px;
      --space-2:10px;
      --space-3:14px;
      --space-4:18px;
      --space-5:24px;
      --radius:16px;
      --radius2:22px;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --shadow2: 0 10px 28px rgba(0,0,0,.45);
      --ring: 0 0 0 3px rgba(74,163,255,.28);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--fg);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(74,163,255,.20), transparent 55%),
                  radial-gradient(900px 700px at 80% 15%, rgba(47,125,255,.18), transparent 55%),
                  radial-gradient(800px 600px at 60% 95%, rgba(59,226,143,.12), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden; /* desktop no scroll */
    }

    /* subtle animated tech lines */
    .bgfx{
      position:fixed; inset:-40px;
      pointer-events:none;
      opacity:.55;
      filter: blur(.2px);
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 1px, transparent 1px 42px),
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0 1px, transparent 1px 56px);
      transform: translate3d(0,0,0);
      animation: drift 14s linear infinite;
      mask-image: radial-gradient(closest-side at 50% 25%, rgba(0,0,0,.9), rgba(0,0,0,.25) 60%, rgba(0,0,0,0) 100%);
    }
    @keyframes drift{
      from{ transform: translate3d(0,0,0) }
      to{ transform: translate3d(-60px, 35px, 0) }
    }
    @media (prefers-reduced-motion: reduce){
      .bgfx{animation:none}
      .fade,.slide{transition:none!important}
      .pulse{animation:none!important}
    }

    /* Layout 16:9 shell */
    .app{
      position:relative;
      height:100%;
      display:flex;
      flex-direction:column;
    }

    header{
      position:sticky; top:0; z-index:30;
      display:flex; align-items:center; justify-content:space-between;
      gap:var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: linear-gradient(180deg, rgba(7,11,22,.92), rgba(7,11,22,.70));
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex; align-items:center; gap:12px; min-width: 260px;
    }
    .logo{
      width:42px; height:42px;
      border-radius:14px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.25), rgba(255,255,255,.04) 55%),
                  linear-gradient(180deg, rgba(74,163,255,.25), rgba(47,125,255,.10));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logo svg{opacity:.95}
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:12px;
    }

    .hud{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      user-select:none;
      white-space:nowrap;
      font-size:13px;
    }
    .pill .k{color:var(--muted2); font-size:12px}
    .pill strong{font-weight:700}
    .dot{
      width:8px;height:8px;border-radius:99px;background:var(--blue);
      box-shadow: 0 0 0 3px rgba(74,163,255,.18);
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--fg);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:650;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.09)}
    .btn:active{transform: translateY(1px)}
    .btn:focus-visible{outline:none; box-shadow: var(--ring)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(74,163,255,.24), rgba(47,125,255,.16));
      border-color: rgba(74,163,255,.28);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,77,109,.22), rgba(255,77,109,.10));
      border-color: rgba(255,77,109,.26);
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.12);
    }
    .btn:disabled{
      opacity:.48; cursor:not-allowed; transform:none;
    }

    main{
      flex:1;
      min-height:0;
      padding: var(--space-4);
      display:grid;
      grid-template-columns: 1.45fr .85fr;
      gap: var(--space-4);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }
    .cardHd{
      padding: var(--space-4);
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,0));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--space-3);
    }
    .cardHd .title{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .badge{
      display:inline-flex; align-items:center; gap:7px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(74,163,255,.12);
      border: 1px solid rgba(74,163,255,.22);
      color: rgba(234,241,255,.92);
      font-size:12px;
      white-space:nowrap;
    }
    .badge .miniDot{width:7px;height:7px;border-radius:99px;background:var(--blue)}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}

    /* Question */
    .qWrap{
      padding: var(--space-4);
      display:flex;
      flex-direction:column;
      gap: var(--space-4);
      min-height:0;
    }
    .qText{
      font-size: 20px;
      line-height:1.25;
      margin:0;
    }
    .qMeta{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .hintBox{
      background: rgba(255,255,255,.05);
      border:1px dashed rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 12px 14px;
      color: var(--muted);
      font-size: 13px;
      display:none;
    }
    .hintBox.show{display:block}
    .explainBox{
      background: linear-gradient(180deg, rgba(59,226,143,.12), rgba(59,226,143,.06));
      border:1px solid rgba(59,226,143,.18);
      border-radius: 16px;
      padding: 12px 14px;
      color: rgba(234,241,255,.92);
      font-size: 13px;
      display:none;
    }
    .explainBox.bad{
      background: linear-gradient(180deg, rgba(255,77,109,.14), rgba(255,77,109,.06));
      border-color: rgba(255,77,109,.20);
    }

    .answers{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top:auto;
    }
    .ans{
      text-align:left;
      border-radius: 18px;
      padding: 14px 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      min-height: 58px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .ans:hover{background: rgba(255,255,255,.09)}
    .ans:active{transform: translateY(1px)}
    .ans:focus-visible{outline:none; box-shadow: var(--ring)}
    .ans[aria-disabled="true"]{opacity:.42; cursor:not-allowed}
    .ans .key{
      width:28px;height:28px;border-radius:10px;
      display:grid; place-items:center;
      background: rgba(74,163,255,.14);
      border:1px solid rgba(74,163,255,.22);
      font-weight:800;
      flex:0 0 auto;
    }
    .ans .txt{
      font-size: 14px;
      line-height:1.25;
      color: rgba(234,241,255,.92);
    }
    .ans.selected{
      border-color: rgba(74,163,255,.35);
      background: linear-gradient(180deg, rgba(74,163,255,.18), rgba(255,255,255,.06));
    }
    .ans.locked{
      border-color: rgba(255,209,102,.32);
      background: linear-gradient(180deg, rgba(255,209,102,.16), rgba(255,255,255,.06));
    }
    .ans.correct{
      border-color: rgba(59,226,143,.32);
      background: linear-gradient(180deg, rgba(59,226,143,.18), rgba(255,255,255,.06));
    }
    .ans.wrong{
      border-color: rgba(255,77,109,.32);
      background: linear-gradient(180deg, rgba(255,77,109,.18), rgba(255,255,255,.06));
    }

    .qActions{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      margin-top: 4px;
    }
    .statusLine{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:-6px;
      color: var(--muted);
      font-size: 13px;
      min-height: 18px;
    }
    .statusLine .ok{color: rgba(59,226,143,.95); font-weight:700}
    .statusLine .no{color: rgba(255,77,109,.95); font-weight:700}
    .statusLine .warn{color: rgba(255,209,102,.95); font-weight:700}

    /* Right rail: ladder + lifelines */
    .rail{
      display:flex;
      flex-direction:column;
      gap: var(--space-4);
      min-height:0;
    }

    .ladder{
      padding: var(--space-3);
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ladderList{
      list-style:none; margin:0; padding:0;
      display:flex;
      flex-direction:column-reverse; /* show top prize at top visually? reverse then style */
      gap:8px;
      overflow:auto;
      padding-right: 6px;
      scrollbar-width: thin;
    }
    .step{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.09);
      font-size: 13px;
      color: var(--muted);
    }
    .step .n{
      font-variant-numeric: tabular-nums;
      color: rgba(234,241,255,.82);
      font-weight:750;
      min-width: 32px;
    }
    .step .p{
      font-variant-numeric: tabular-nums;
      color: rgba(234,241,255,.90);
      font-weight:750;
    }
    .step.current{
      color: rgba(234,241,255,.92);
      background: linear-gradient(180deg, rgba(74,163,255,.18), rgba(255,255,255,.06));
      border-color: rgba(74,163,255,.28);
    }
    .step.safe{
      border-color: rgba(255,209,102,.18);
      background: linear-gradient(180deg, rgba(255,209,102,.12), rgba(255,255,255,.05));
    }
    .step.done{
      opacity:.62;
    }

    .life{
      padding: var(--space-3);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .lifeRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .lifeBtn{
      padding: 12px 10px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      font-weight:800;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
      text-align:center;
      min-height: 54px;
    }
    .lifeBtn:hover{background: rgba(255,255,255,.09)}
    .lifeBtn:active{transform: translateY(1px)}
    .lifeBtn:focus-visible{outline:none; box-shadow: var(--ring)}
    .lifeBtn.used{opacity:.46; cursor:not-allowed}
    .lifeBtn svg{opacity:.95}
    .lifeBtn .t{font-size:12px; line-height:1.1; color: rgba(234,241,255,.92)}
    .lifeBtn .s{font-size:11px; color: var(--muted2); font-weight:650}

    /* Overlays / modal */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      padding: 18px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .overlay.show{display:flex}
    .modal{
      width:min(920px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHd{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,0));
    }
    .modalHd h2{margin:0; font-size:14px; letter-spacing:.2px}
    .modalBd{
      padding: 16px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    .modalBd.single{grid-template-columns: 1fr}
    .modalFt{
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    }
    .field{
      display:flex; flex-direction:column; gap:7px;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
    }
    label{font-size:12px; color: var(--muted)}
    input, select{
      background: rgba(0,0,0,.22);
      color: var(--fg);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px 11px;
      font-size: 13px;
      outline:none;
    }
    input:focus, select:focus{box-shadow: var(--ring); border-color: rgba(74,163,255,.25)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .teacherPanel{
      position:fixed; right: 14px; bottom: 14px;
      width: min(420px, calc(100vw - 28px));
      z-index: 50;
      display:none;
    }
    .teacherPanel.show{display:block}
    .teacherPanel .card{box-shadow: var(--shadow2)}
    .teacherPanel .cardHd{padding: 12px 12px}
    .teacherPanel .qWrap{padding: 12px 12px; gap: 10px}
    .teacherPanel .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .toggle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      user-select:none;
    }
    .toggle span{font-size:12px; color: var(--muted)}
    .switch{
      width: 44px; height: 26px;
      border-radius: 99px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      position:relative;
      flex:0 0 auto;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease;
    }
    .switch::after{
      content:"";
      position:absolute; top:50%; left: 3px;
      width: 20px; height: 20px;
      border-radius: 99px;
      background: rgba(234,241,255,.92);
      transform: translateY(-50%);
      transition: left .14s ease;
    }
    .switch.on{
      background: rgba(74,163,255,.22);
      border-color: rgba(74,163,255,.26);
    }
    .switch.on::after{left: 21px}

    /* Audience poll */
    .poll{
      display:flex; flex-direction:column; gap:10px;
    }
    .barRow{
      display:grid; grid-template-columns: 22px 1fr 46px;
      gap:10px;
      align-items:center;
    }
    .barKey{
      width:22px;height:22px;border-radius:9px;
      display:grid;place-items:center;
      background: rgba(74,163,255,.14);
      border: 1px solid rgba(74,163,255,.22);
      font-weight:900;
      font-size:12px;
    }
    .bar{
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(74,163,255,.40), rgba(47,125,255,.18));
      transition: width .55s ease;
    }
    .pct{
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      font-size: 12px;
      text-align:right;
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom: 18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.58);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(234,241,255,.92);
      font-size: 13px;
      box-shadow: 0 12px 35px rgba(0,0,0,.45);
      display:none;
      z-index:70;
      max-width: calc(100vw - 24px);
    }
    .toast.show{display:block}
    .fade{transition: opacity .18s ease, transform .18s ease}
    .slide{transition: transform .18s ease, opacity .18s ease}

    /* Responsive: allow scroll on small screens */
    @media (max-width: 980px){
      body{overflow:auto}
      main{
        grid-template-columns: 1fr;
      }
      .teacherPanel{right: 10px; left: 10px; width:auto}
    }

    /* Helper */
    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
  </style>
</head>
<body>
  <div class="bgfx" aria-hidden="true"></div>

  <div class="app" id="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true" id="logoBox"></div>
        <div>
          <h1 id="gameTitle">Who Wants to Be a Millionaire</h1>
          <p id="gameTagline">·ª®ng d·ª•ng n8n c∆° b·∫£n ‚Ä¢ Ch·∫ø ƒë·ªô H·ªçc vi√™n</p>
        </div>
      </div>

      <div class="hud" aria-label="B·∫£ng ƒëi·ªÅu khi·ªÉn">
        <div class="pill" title="Th·ªùi gian c√≤n l·∫°i cho c√¢u hi·ªán t·∫°i">
          <span class="dot" aria-hidden="true"></span>
          <span class="k">Timer</span>
          <strong id="timerText">00:30</strong>
        </div>
        <div class="pill" title="ƒêi·ªÉm hi·ªán t·∫°i">
          <span class="k">Score</span>
          <strong id="scoreText">0</strong>
        </div>
        <div class="pill" title="Ti·∫øn ƒë·ªô c√¢u h·ªèi">
          <span class="k">Progress</span>
          <strong id="progressText">0/12</strong>
        </div>

        <button class="btn ghost" id="btnTeacher" type="button" title="M·ªü Teacher Mode">
          <span aria-hidden="true">üõ†Ô∏è</span>
          Teacher
        </button>
        <button class="btn danger" id="btnReset" type="button" title="Reset v√°n ch∆°i">
          <span aria-hidden="true">‚Üª</span>
          Reset
        </button>
      </div>
    </header>

    <main>
      <!-- Left: Question -->
      <section class="card" aria-label="C√¢u h·ªèi">
        <div class="cardHd">
          <div class="title">
            <span class="badge" id="modeBadge"><span class="miniDot"></span><span>Student Mode</span></span>
            <span class="muted2" id="roundText">Ch∆∞a b·∫Øt ƒë·∫ßu</span>
          </div>
          <div class="row">
            <span class="muted2" id="streakText" title="Chu·ªói tr·∫£ l·ªùi ƒë√∫ng li√™n ti·∫øp">Streak: 0</span>
            <button class="btn primary" id="btnStart" type="button">
              <span aria-hidden="true">‚ñ∂</span> Start
            </button>
          </div>
        </div>

        <div class="qWrap">
          <div class="qMeta" aria-label="Th√¥ng tin c√¢u h·ªèi">
            <span class="badge" id="setBadge"><span class="miniDot"></span><span id="setName">B·ªô ƒë·ªÅ: C∆° b·∫£n</span></span>
            <span class="muted2" id="safeText" title="M·ªëc an to√†n">M·ªëc an to√†n: 5, 10</span>
          </div>

          <p class="qText" id="qText">Nh·∫•n <strong>Start</strong> ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i.</p>

          <div class="statusLine" id="statusLine" aria-live="polite"></div>

          <div class="hintBox" id="hintBox">
            <strong>Hint:</strong> <span id="hintText"></span>
          </div>

          <div class="explainBox" id="explainBox">
            <strong>Gi·∫£i th√≠ch:</strong> <span id="explainText"></span>
          </div>

          <div class="answers" role="group" aria-label="C√°c l·ª±a ch·ªçn">
            <button class="ans" type="button" data-idx="0">
              <span class="key" aria-hidden="true">A</span>
              <span class="txt" id="a0">‚Äî</span>
            </button>
            <button class="ans" type="button" data-idx="1">
              <span class="key" aria-hidden="true">B</span>
              <span class="txt" id="a1">‚Äî</span>
            </button>
            <button class="ans" type="button" data-idx="2">
              <span class="key" aria-hidden="true">C</span>
              <span class="txt" id="a2">‚Äî</span>
            </button>
            <button class="ans" type="button" data-idx="3">
              <span class="key" aria-hidden="true">D</span>
              <span class="txt" id="a3">‚Äî</span>
            </button>
          </div>

          <div class="qActions" aria-label="H√†nh ƒë·ªông c√¢u h·ªèi">
            <button class="btn" id="btnHint" type="button" title="Xem g·ª£i √Ω (n·∫øu c√≥)">
              <span aria-hidden="true">üí°</span> Hint
            </button>
            <button class="btn" id="btnLock" type="button" title="Ch·ªët ƒë√°p √°n">
              <span aria-hidden="true">üîí</span> Final Answer
            </button>
            <button class="btn" id="btnRevealStudent" type="button" title="Hi·ªán ƒë√°p √°n ƒë√∫ng (Student Mode)">
              <span aria-hidden="true">üëÅÔ∏è</span> Reveal
            </button>
            <button class="btn primary" id="btnNextStudent" type="button" title="Sang c√¢u ti·∫øp theo (Student Mode)">
              <span aria-hidden="true">‚è≠</span> Next
            </button>
          </div>
        </div>
      </section>

      <!-- Right: Ladder + Lifelines -->
      <aside class="rail" aria-label="B·∫£ng th∆∞·ªüng v√† quy·ªÅn tr·ª£ gi√∫p">
        <section class="card" aria-label="B·∫£ng th∆∞·ªüng">
          <div class="cardHd">
            <div class="title">
              <span class="badge"><span class="miniDot"></span><span>Prize Ladder</span></span>
              <span class="muted2" id="prizeNow">‚Äî</span>
            </div>
            <button class="btn" id="btnExport" type="button" title="Xu·∫•t ·∫£nh k·∫øt qu·∫£">
              <span aria-hidden="true">üñºÔ∏è</span> Export
            </button>
          </div>
          <div class="ladder">
            <ul class="ladderList" id="ladderList" aria-label="Danh s√°ch m·ª©c th∆∞·ªüng"></ul>
          </div>
        </section>

        <section class="card" aria-label="Tr·ª£ gi√∫p">
          <div class="cardHd">
            <div class="title">
              <span class="badge"><span class="miniDot"></span><span>Lifelines</span></span>
              <span class="muted2">M·ªói quy·ªÅn d√πng 1 l·∫ßn</span>
            </div>
          </div>

          <div class="life">
            <div class="lifeRow">
              <button class="lifeBtn" id="life5050" type="button" title="Lo·∫°i b·ªè 2 ƒë√°p √°n sai">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M5 7h14M5 12h8M5 17h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <div>
                  <div class="t">50:50</div>
                  <div class="s">Lo·∫°i 2 sai</div>
                </div>
              </button>
              <button class="lifeBtn" id="lifeAsk" type="button" title="H·ªèi l·ªõp (kh·∫£o s√°t nhanh)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M4 20V9M10 20V4M16 20v-7M22 20V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <div>
                  <div class="t">H·ªèi l·ªõp</div>
                  <div class="s">Poll nhanh</div>
                </div>
              </button>
              <button class="lifeBtn" id="lifeSwap" type="button" title="ƒê·ªïi c√¢u h·ªèi kh√°c c√πng ƒë·ªô kh√≥">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M7 7h10l-2-2M17 17H7l2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div>
                  <div class="t">ƒê·ªïi c√¢u</div>
                  <div class="s">Switch</div>
                </div>
              </button>
            </div>

            <div class="muted" style="font-size:12px; line-height:1.35">
              G·ª£i √Ω t·ªï ch·ª©c: chi·∫øu l√™n m√†n h√¨nh, c·∫£ l·ªõp ch·ªçn ƒë√°p √°n ‚Üí b·∫•m <strong>Final Answer</strong> ‚Üí (Teacher Mode: gi√°o vi√™n b·∫•m <strong>Reveal</strong>).
            </div>
          </div>
        </section>
      </aside>
    </main>

    <!-- Teacher Panel (floating) -->
    <div class="teacherPanel" id="teacherPanel" aria-label="Teacher Mode panel">
      <section class="card">
        <div class="cardHd">
          <div class="title">
            <span class="badge"><span class="miniDot"></span><span>Teacher Mode</span></span>
            <span class="muted2" id="teacherState">Ready</span>
          </div>
          <button class="btn ghost" id="btnTeacherClose" type="button" title="ƒê√≥ng Teacher Mode">
            <span aria-hidden="true">‚úï</span> Close
          </button>
        </div>
        <div class="qWrap">
          <div class="miniGrid">
            <div class="field">
              <label for="selSet">B·ªô c√¢u h·ªèi</label>
              <select id="selSet" aria-label="Ch·ªçn b·ªô c√¢u h·ªèi"></select>
            </div>
            <div class="field">
              <label for="inpTime">Timer m·ªói c√¢u (gi√¢y)</label>
              <input id="inpTime" type="number" min="10" max="300" step="5" />
            </div>
          </div>

          <div class="toggle" title="B·∫≠t ƒë·ªÉ gi√°o vi√™n ch·ªß ƒë·ªông b·∫•m Reveal; t·∫Øt th√¨ t·ª± Reveal sau khi ch·ªët ƒë√°p √°n">
            <span>Manual Reveal</span>
            <div class="switch on" id="swManual" role="switch" aria-checked="true" tabindex="0"></div>
          </div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn primary" id="tBtnStart" type="button"><span aria-hidden="true">‚ñ∂</span> Start/Resume</button>
            <button class="btn" id="tBtnPause" type="button"><span aria-hidden="true">‚è∏</span> Pause</button>
            <button class="btn" id="tBtnReveal" type="button"><span aria-hidden="true">üëÅÔ∏è</span> Reveal</button>
            <button class="btn" id="tBtnNext" type="button"><span aria-hidden="true">‚è≠</span> Next</button>
            <button class="btn danger" id="tBtnReset" type="button"><span aria-hidden="true">‚Üª</span> Reset</button>
          </div>

          <div class="muted2" style="font-size:12px; line-height:1.35">
            M·∫≠t kh·∫©u: <strong>n8n</strong>. G·ª£i √Ω: ƒë·ªÉ <strong>Manual Reveal</strong> b·∫≠t khi ch∆°i theo l·ªõp (gi√°o vi√™n ki·ªÉm so√°t nh·ªãp).
          </div>
        </div>
      </section>
    </div>

    <!-- Overlay: Teacher login -->
    <div class="overlay" id="ovTeacher" role="dialog" aria-modal="true" aria-labelledby="teacherTitle">
      <div class="modal">
        <div class="modalHd">
          <h2 id="teacherTitle">Teacher Mode</h2>
          <button class="btn ghost" id="btnTeacherCancel" type="button"><span aria-hidden="true">‚úï</span> ƒê√≥ng</button>
        </div>
        <div class="modalBd">
          <div class="field">
            <label for="inpPass">Nh·∫≠p m·∫≠t kh·∫©u</label>
            <input id="inpPass" type="password" placeholder="Password" autocomplete="off" />
            <div class="muted2" style="font-size:12px; line-height:1.35">
              D√πng ƒë·ªÉ b·∫≠t b·∫£ng ƒëi·ªÅu khi·ªÉn gi√°o vi√™n (Start/Next/Reveal, ch·ªçn b·ªô ƒë·ªÅ, ch·ªânh timer).
            </div>
          </div>
          <div class="field">
            <label>Tr·∫°ng th√°i</label>
            <div class="muted" id="passStatus">Ch∆∞a x√°c th·ª±c</div>
            <div class="muted2" style="font-size:12px; line-height:1.35">
              Tip: b·∫≠t Teacher Mode khi c·∫ßn ‚Äúnh·ªãp l·ªõp h·ªçc‚Äù v√† gi·∫£m tranh lu·∫≠n k√©o d√†i.
            </div>
          </div>
        </div>
        <div class="modalFt">
          <button class="btn primary" id="btnTeacherOk" type="button"><span aria-hidden="true">üîì</span> M·ªü</button>
        </div>
      </div>
    </div>

    <!-- Overlay: Audience poll -->
    <div class="overlay" id="ovPoll" role="dialog" aria-modal="true" aria-labelledby="pollTitle">
      <div class="modal">
        <div class="modalHd">
          <h2 id="pollTitle">H·ªèi l·ªõp ‚Äì K·∫øt qu·∫£ b√¨nh ch·ªçn</h2>
          <button class="btn ghost" id="btnPollClose" type="button"><span aria-hidden="true">‚úï</span> ƒê√≥ng</button>
        </div>
        <div class="modalBd single">
          <div class="field">
            <div class="poll" id="pollBody" aria-label="Bi·ªÉu ƒë·ªì b√¨nh ch·ªçn"></div>
            <div class="muted2" style="font-size:12px; line-height:1.35">
              L∆∞u √Ω: ƒë√¢y l√† m√¥ ph·ªèng (bias theo ƒë·ªô kh√≥). H√£y d√πng nh∆∞ ‚Äúƒëi·ªÉm tham kh·∫£o‚Äù ƒë·ªÉ k√≠ch ho·∫°t th·∫£o lu·∫≠n nhanh.
            </div>
          </div>
        </div>
        <div class="modalFt">
          <button class="btn primary" id="btnPollOk" type="button"><span aria-hidden="true">‚úÖ</span> OK</button>
        </div>
      </div>
    </div>

    <!-- Overlay: Final answer confirm -->
    <div class="overlay" id="ovFinal" role="dialog" aria-modal="true" aria-labelledby="finalTitle">
      <div class="modal">
        <div class="modalHd">
          <h2 id="finalTitle">Ch·ªët ƒë√°p √°n?</h2>
          <button class="btn ghost" id="btnFinalClose" type="button"><span aria-hidden="true">‚úï</span> ƒê√≥ng</button>
        </div>
        <div class="modalBd single">
          <div class="field">
            <div class="muted2" style="font-size:12px">B·∫°n ch·ªçn</div>
            <div style="font-weight:850; font-size:16px; line-height:1.25" id="finalChoiceText">‚Äî</div>
            <div class="muted" style="font-size:12px; line-height:1.35; margin-top:8px">
              Khi ch·ªët, b·∫°n kh√¥ng th·ªÉ ƒë·ªïi ƒë√°p √°n. (Teacher Mode c√≥ th·ªÉ b·∫≠t Manual Reveal)
            </div>
          </div>
        </div>
        <div class="modalFt">
          <button class="btn" id="btnFinalNo" type="button"><span aria-hidden="true">‚Ü©</span> Ch∆∞a</button>
          <button class="btn primary" id="btnFinalYes" type="button"><span aria-hidden="true">üîí</span> Final Answer</button>
        </div>
      </div>
    </div>

    <!-- Overlay: Result -->
    <div class="overlay" id="ovResult" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
      <div class="modal">
        <div class="modalHd">
          <h2 id="resultTitle">K·∫øt qu·∫£ tr√≤ ch∆°i</h2>
          <button class="btn ghost" id="btnResultClose" type="button"><span aria-hidden="true">‚úï</span> ƒê√≥ng</button>
        </div>
        <div class="modalBd">
          <div class="field">
            <div class="muted2" style="font-size:12px">T·ªïng quan</div>
            <div style="display:grid; gap:8px; margin-top:8px">
              <div class="row" style="justify-content:space-between">
                <span class="muted">Score</span><strong id="rScore">0</strong>
              </div>
              <div class="row" style="justify-content:space-between">
                <span class="muted">ƒê√∫ng</span><strong id="rCorrect">0</strong>
              </div>
              <div class="row" style="justify-content:space-between">
                <span class="muted">Sai</span><strong id="rWrong">0</strong>
              </div>
              <div class="row" style="justify-content:space-between">
                <span class="muted">Th·ªùi gian</span><strong id="rTime">00:00</strong>
              </div>
              <div class="row" style="justify-content:space-between">
                <span class="muted">B·ªô ƒë·ªÅ</span><strong id="rSet">‚Äî</strong>
              </div>
            </div>
            <div class="muted2" style="font-size:12px; line-height:1.35; margin-top:10px">
              Tip: ch·ª•p/Export ƒë·ªÉ l∆∞u k·∫øt qu·∫£ l·ªõp, d√πng l√†m ‚Äúmini KPI‚Äù cho bu·ªïi h·ªçc.
            </div>
          </div>

          <div class="field">
            <div class="muted2" style="font-size:12px">Xu·∫•t ·∫£nh ngay trong tr√¨nh duy·ªát</div>
            <canvas id="resultCanvas" width="1200" height="675" style="width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.20)"></canvas>
            <div class="row" style="justify-content:flex-end; margin-top:10px">
              <button class="btn" id="btnRender" type="button"><span aria-hidden="true">üßæ</span> Render</button>
              <a class="btn primary" id="btnDownload" href="#" download="millionaire_result.png" role="button"><span aria-hidden="true">‚¨á</span> Download PNG</a>
            </div>
          </div>
        </div>
        <div class="modalFt">
          <button class="btn danger" id="btnPlayAgain" type="button"><span aria-hidden="true">‚Üª</span> Ch∆°i l·∫°i</button>
        </div>
      </div>
    </div>

    <div class="toast fade" id="toast" role="status" aria-live="polite"></div>

    <!-- Quick Guide (end of file requirement) -->
    <section class="card" style="margin: 0 var(--space-4) var(--space-4); display:none" aria-hidden="true"></section>
    <details style="position:fixed; left:14px; bottom:14px; width:min(520px, calc(100vw - 28px)); z-index:40">
      <summary class="btn" style="list-style:none">
        <span aria-hidden="true">üìå</span> H∆∞·ªõng d·∫´n nhanh (·ªü cu·ªëi file)
      </summary>
      <div class="card" style="margin-top:10px">
        <div class="cardHd">
          <div class="title">
            <span class="badge"><span class="miniDot"></span><span>Quick Guide</span></span>
            <span class="muted2">C√°ch ƒë·ªïi d·ªØ li·ªáu & c√°ch ch∆°i</span>
          </div>
        </div>
        <div class="qWrap" style="padding: 14px 14px 16px; gap: 10px">
          <div class="muted" style="font-size:13px; line-height:1.45">
            <strong>1) ƒê·ªïi d·ªØ li·ªáu c√¢u h·ªèi:</strong> m·ªü file, t√¨m bi·∫øn <code>CONFIG</code> ‚Üí <code>questionSets</code> ‚Üí s·ª≠a <code>questions</code> / <code>backup</code> (m·ªói c√¢u c√≥ <code>q/options/answerIndex/hint/explanation</code>).<br/>
            <strong>2) Ch∆°i tr√™n l·ªõp:</strong> chi·∫øu m√†n h√¨nh ‚Üí b·∫•m <strong>Start</strong> ‚Üí c·∫£ l·ªõp ch·ªçn ƒë√°p √°n ‚Üí b·∫•m <strong>Final Answer</strong> ‚Üí (Teacher Mode) b·∫•m <strong>Reveal</strong> ƒë·ªÉ ch·ªët ‚Üí <strong>Next</strong> sang c√¢u ti·∫øp.<br/>
            <strong>3) Lifelines:</strong> <em>50:50</em> lo·∫°i 2 sai; <em>H·ªèi l·ªõp</em> hi·ªán poll nhanh; <em>ƒê·ªïi c√¢u</em> thay b·∫±ng c√¢u d·ª± ph√≤ng c√πng ƒë·ªô kh√≥.<br/>
            <strong>4) Teacher Mode:</strong> b·∫•m <strong>Teacher</strong> (m·∫≠t kh·∫©u: <strong>n8n</strong>) ‚Üí ch·ªçn b·ªô ƒë·ªÅ + ch·ªânh timer + ƒëi·ªÅu khi·ªÉn Start/Pause/Reveal/Next.<br/>
            <strong>5) Xu·∫•t ·∫£nh k·∫øt qu·∫£:</strong> b·∫•m <strong>Export</strong> ‚Üí <strong>Render</strong> ‚Üí <strong>Download PNG</strong>.
          </div>
        </div>
      </div>
    </details>
  </div>

  <script>
    'use strict';

    // =========================
    // CONFIG (Teacher edit here)
    // =========================
    const CONFIG = {
      links: { facebook: "", linkedin: "", youtube: "" },
      assets: {
        logoSvg: `
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l8.5 5v10L12 22 3.5 17V7L12 2Z" stroke="rgba(234,241,255,.95)" stroke-width="2" />
            <path d="M8 12h8" stroke="rgba(74,163,255,.95)" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 8v8" stroke="rgba(59,226,143,.95)" stroke-width="2" stroke-linecap="round"/>
          </svg>`
      },
      text: {
        brand: "KPIM / COMPA Class",
        gameTitle: "Who Wants to Be a Millionaire",
        tagline: "·ª®ng d·ª•ng n8n c∆° b·∫£n",
        teacherPass: "n8n"
      },
      settings: {
        totalQuestions: 12,            // 10‚Äì15
        timePerQuestionSec: 30,
        safeLevels: [5, 10],           // milestone like Millionaire
        pointsLadder: [100,200,300,500,800,1200,1800,2500,3500,5000,7000,10000],
        streakBonusEvery: 3,           // bonus each N streak
        streakBonusPoints: 250
      },
      questionSets: [
        {
          id: "basic",
          name: "C∆° b·∫£n (n8n Fundamentals)",
          questions: [
            { q:"n8n ch·ªß y·∫øu d√πng ƒë·ªÉ l√†m g√¨?", options:["Thi·∫øt k·∫ø UI web","T·ª± ƒë·ªông ho√° workflow","L∆∞u tr·ªØ file nh∆∞ Google Drive","Qu·∫£n l√Ω m·∫≠t kh·∫©u"], answerIndex:1, hint:"Nghƒ© v·ªÅ vi·ªác n·ªëi c√°c b∆∞·ªõc l·∫°i th√†nh chu·ªói.", explanation:"n8n l√† c√¥ng c·ª• automation/workflow ƒë·ªÉ k·∫øt n·ªëi c√°c d·ªãch v·ª• v√† t·ª± ƒë·ªông ho√° quy tr√¨nh." },
            { q:"Trong n8n, ‚ÄúNode‚Äù th∆∞·ªùng ƒë·∫°i di·ªán cho g√¨?", options:["M·ªôt b∆∞·ªõc x·ª≠ l√Ω/k·∫øt n·ªëi","M·ªôt ng∆∞·ªùi d√πng trong h·ªá th·ªëng","M·ªôt file c·∫•u h√¨nh","M·ªôt server v·∫≠t l√Ω"], answerIndex:0, hint:"Workflow ƒë∆∞·ª£c gh√©p t·ª´ nhi·ªÅu kh·ªëi.", explanation:"Node l√† ƒë∆°n v·ªã ch·ª©c nƒÉng ‚Äì 1 b∆∞·ªõc trong workflow (trigger, action, transform...)." },
            { q:"Trigger node d√πng ƒë·ªÉ l√†m g√¨?", options:["K·∫øt th√∫c workflow","B·∫Øt ƒë·∫ßu workflow khi c√≥ s·ª± ki·ªán","Ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã log","TƒÉng t·ªëc ƒë·ªô ch·∫°y"], answerIndex:1, hint:"N·∫øu kh√¥ng c√≥ trigger, workflow ‚Äúch·ªù‚Äù ƒëi·ªÅu g√¨?", explanation:"Trigger l√† ƒëi·ªÉm kh·ªüi ƒë·ªông workflow (Webhook, Schedule, IMAP, ‚Ä¶)." },
            { q:"Webhook trong n8n th∆∞·ªùng h·ªØu √≠ch nh·∫•t khi n√†o?", options:["Mu·ªën ch·∫°y theo gi·ªù c·ªë ƒë·ªãnh","Mu·ªën nh·∫≠n d·ªØ li·ªáu t·ª´ h·ªá th·ªëng kh√°c g·ªçi v√†o","Mu·ªën l∆∞u d·ªØ li·ªáu v√†o Excel offline","Mu·ªën t·∫°o bi·ªÉu ƒë·ªì"], answerIndex:1, hint:"H·ªá th·ªëng kh√°c ‚Äúb·∫Øn‚Äù request t·ªõi b·∫°n.", explanation:"Webhook nh·∫≠n HTTP request ƒë·ªÉ k√≠ch ho·∫°t workflow v√† nh·∫≠n payload." },
            { q:"Khi c·∫ßn ‚Äúl·∫∑p‚Äù qua danh s√°ch items trong n8n, b·∫°n th∆∞·ªùng d√πng g√¨?", options:["Split in Batches","Stop and Error","NoOp","Merge (Pass-through)"], answerIndex:0, hint:"T√™n node g·ª£i √Ω chia nh·ªè theo t·ª´ng batch.", explanation:"Split in Batches gi√∫p x·ª≠ l√Ω tu·∫ßn t·ª±/nh√≥m c√°c items." },
            { q:"Node n√†o th∆∞·ªùng d√πng ƒë·ªÉ bi·∫øn ƒë·ªïi d·ªØ li·ªáu d·∫°ng JSON nhanh trong n8n?", options:["Code","Set","HTTP Request","Webhook"], answerIndex:1, hint:"Kh√¥ng c·∫ßn code v·∫´n map ƒë∆∞·ª£c fields.", explanation:"Set node gi√∫p t·∫°o/ƒë·ªïi fields, map d·ªØ li·ªáu, g√°n gi√° tr·ªã nhanh." },
            { q:"Trong n8n, ‚ÄúExpression‚Äù d√πng ƒë·ªÉ l√†m g√¨?", options:["V·∫Ω bi·ªÉu ƒë·ªì","T√≠nh to√°n/gh√©p chu·ªói ƒë·ªông t·ª´ d·ªØ li·ªáu","T·∫£i file l√™n cloud","Ch·∫°y cron system"], answerIndex:1, hint:"Gi·ªëng c√¥ng th·ª©c ƒë·ªÉ t·∫°o gi√° tr·ªã ƒë·ªông.", explanation:"Expression cho ph√©p tham chi·∫øu d·ªØ li·ªáu node tr∆∞·ªõc v√† x·ª≠ l√Ω ƒë·ªông." },
            { q:"M·ªôt best practice khi g·ªçi API b·∫±ng HTTP Request node l√† g√¨?", options:["Hardcode token v√†o text","Kh√¥ng c·∫ßn x·ª≠ l√Ω l·ªói","D√πng credential/bi·∫øn m√¥i tr∆∞·ªùng cho secrets","G·ª≠i d·ªØ li·ªáu t√πy √Ω kh√¥ng validate"], answerIndex:2, hint:"B·∫£o m·∫≠t lu√¥n l√† ∆∞u ti√™n.", explanation:"N√™n d√πng Credentials/Env vars ƒë·ªÉ qu·∫£n l√Ω secrets, tr√°nh hardcode." },
            { q:"N·∫øu m·ªôt node ph√≠a sau kh√¥ng ch·∫°y, nguy√™n nh√¢n ph·ªï bi·∫øn l√† g√¨?", options:["Node tr∆∞·ªõc kh√¥ng output items","Thi·∫øu icon","M√†u theme b·ªã l·ªói","n8n kh√¥ng h·ªó tr·ª£ JSON"], answerIndex:0, hint:"D√≤ng ch·∫£y d·ªØ li·ªáu b·ªã ‚Äúƒë·ª©t‚Äù.", explanation:"Nhi·ªÅu node y√™u c·∫ßu input items; node tr∆∞·ªõc kh√¥ng tr·∫£ d·ªØ li·ªáu th√¨ node sau kh√¥ng ch·∫°y." },
            { q:"B·∫°n mu·ªën ch·∫°y workflow m·ªói 5 ph√∫t. Trigger ph√π h·ª£p nh·∫•t?", options:["Schedule Trigger","Webhook Trigger","Manual Trigger (ch·∫°y tay)","NoOp"], answerIndex:0, hint:"Ch·∫°y theo th·ªùi gian ƒë·ªãnh k·ª≥.", explanation:"Schedule Trigger h·ªó tr·ª£ cron/interval (v√≠ d·ª• m·ªói 5 ph√∫t)." },
            { q:"Khi workflow g·∫∑p l·ªói, c√°ch ‚Äúan to√†n‚Äù ƒë·ªÉ v·∫´n ti·∫øp t·ª•c x·ª≠ l√Ω c√°c item c√≤n l·∫°i l√† g√¨ (t∆∞ duy c∆° b·∫£n)?", options:["B·ªè qua logging","D√πng Error Trigger/try-catch logic v√† x·ª≠ l√Ω l·ªói t·ª´ng item","T·∫Øt workflow","X√≥a node b·ªã l·ªói"], answerIndex:1, hint:"X·ª≠ l√Ω l·ªói nh∆∞ 1 nh√°nh ri√™ng.", explanation:"Thi·∫øt k·∫ø nh√°nh x·ª≠ l√Ω l·ªói gi√∫p h·ªá th·ªëng b·ªÅn: log, retry, ho·∫∑c skip theo ƒëi·ªÅu ki·ªán." },
            { q:"T·∫°i sao n√™n ƒë·∫∑t t√™n node r√µ r√†ng (best practice) trong workflow d√†i?", options:["ƒê·ªÉ workflow ch·∫°y nhanh h∆°n","ƒê·ªÉ debug, b·∫£o tr√¨ v√† handover d·ªÖ","ƒê·ªÉ tƒÉng s·ªë node t·ªëi ƒëa","V√¨ n8n b·∫Øt bu·ªôc"], answerIndex:1, hint:"T·ªëi ∆∞u cho ng∆∞·ªùi ƒë·ªçc, kh√¥ng ph·∫£i cho m√°y.", explanation:"T√™n node r√µ r√†ng gi√∫p debug, theo d√µi data lineage v√† b√†n giao nhanh." }
          ],
          backup: [
            { q:"Node ‚ÄúMerge‚Äù th∆∞·ªùng d√πng khi n√†o (c∆° b·∫£n)?", options:["T·∫°o webhook","K·∫øt h·ª£p d·ªØ li·ªáu t·ª´ 2 nh√°nh","G·ª≠i email","TƒÉng t·ªëc CPU"], answerIndex:1, hint:"Gom 2 lu·ªìng v√†o 1.", explanation:"Merge gi√∫p k·∫øt h·ª£p d·ªØ li·ªáu t·ª´ nhi·ªÅu nh√°nh theo ch·∫ø ƒë·ªô merge." },
            { q:"Manual Trigger ph√π h·ª£p nh·∫•t v·ªõi t√¨nh hu·ªëng n√†o?", options:["Test/POC ch·∫°y tay","Nh·∫≠n request t·ª´ h·ªá th·ªëng kh√°c","Ch·∫°y theo l·ªãch","Ch·∫°y khi c√≥ email m·ªõi"], answerIndex:0, hint:"D√πng khi b·∫°n mu·ªën ch·ªß ƒë·ªông b·∫•m ch·∫°y.", explanation:"Manual Trigger gi√∫p ch·∫°y th·ª≠ nhanh trong qu√° tr√¨nh build/debug." }
          ]
        },
        {
          id: "practice",
          name: "Th·ª±c h√†nh (Workflow th·ª±c t·∫ø)",
          questions: [
            { q:"Mu·ªën nh·∫≠n d·ªØ li·ªáu form website v√† ƒë·∫©y v√†o Google Sheets, b·∫°n s·∫Ω c·∫ßn √≠t nh·∫•t nh·ªØng nh√≥m node n√†o?", options:["Trigger + Transform + Destination","Ch·ªâ c·∫ßn 1 node b·∫•t k·ª≥","Ch·ªâ c·∫ßn Merge","Ch·ªâ c·∫ßn NoOp"], answerIndex:0, hint:"B·∫Øt ƒë·∫ßu ‚Üí x·ª≠ l√Ω ‚Üí ghi d·ªØ li·ªáu.", explanation:"T·ªëi thi·ªÉu: Trigger (Webhook/Form), Transform (Set/Code), Destination (Sheets)." },
            { q:"Trong HTTP Request node, ‚ÄúMethod‚Äù GET vs POST kh√°c nhau c∆° b·∫£n ·ªü ƒë√¢u?", options:["GET g·ª≠i body l·ªõn h∆°n POST","POST th∆∞·ªùng g·ª≠i d·ªØ li·ªáu trong body; GET th∆∞·ªùng l·∫•y d·ªØ li·ªáu b·∫±ng query","GET b·∫£o m·∫≠t h∆°n POST m·∫∑c ƒë·ªãnh","POST lu√¥n nhanh h∆°n"], answerIndex:1, hint:"C√°ch truy·ªÅn d·ªØ li·ªáu l√† ƒëi·ªÉm kh√°c ch√≠nh.", explanation:"GET ch·ªß y·∫øu l·∫•y d·ªØ li·ªáu; POST th∆∞·ªùng t·∫°o/ghi v√† g·ª≠i payload trong body." },
            { q:"Khi map d·ªØ li·ªáu t·ª´ node tr∆∞·ªõc sang node sau, b·∫°n n√™n ∆∞u ti√™n g√¨ ƒë·ªÉ gi·∫£m l·ªói?", options:["Copy/paste t√πy √Ω","D√πng Expression tham chi·∫øu ƒë√∫ng field + ki·ªÉm tra null","Lu√¥n hardcode gi√° tr·ªã","T·∫Øt validation"], answerIndex:1, hint:"Nghƒ© v·ªÅ d·ªØ li·ªáu thi·∫øu/kh√°c schema.", explanation:"Tham chi·∫øu ƒë√∫ng field v√† x·ª≠ l√Ω null gi√∫p workflow b·ªÅn h∆°n." },
            { q:"N·∫øu m·ªôt API gi·ªõi h·∫°n 60 requests/ph√∫t, c√°ch x·ª≠ l√Ω ‚Äúƒë√∫ng b√†i‚Äù trong n8n l√† g√¨?", options:["G·ªçi d·ªìn 200 requests c√πng l√∫c","Th√™m delay/rate limit theo batch","T·∫Øt log ƒë·ªÉ nhanh","Ch·∫°y l·∫°i nhi·ªÅu l·∫ßn"], answerIndex:1, hint:"Ki·ªÉm so√°t t·ªëc ƒë·ªô g·ªçi.", explanation:"D√πng batch + delay/rate limit ƒë·ªÉ tu√¢n th·ªß rate limit, tr√°nh b·ªã block." },
            { q:"B·∫°n mu·ªën l∆∞u log m·ªói l·∫ßn workflow ch·∫°y (payload + status). Best practice ƒë∆°n gi·∫£n?", options:["Kh√¥ng l∆∞u g√¨","Ghi v√†o DB/Sheet/Storage ri√™ng theo timestamp","Ch·ªâ ch·ª•p m√†n h√¨nh","ƒê·ªïi m√†u node"], answerIndex:1, hint:"Log gi√∫p audit & debug.", explanation:"Ghi log ra n∆°i l∆∞u tr·ªØ gi√∫p truy v·∫øt v·∫•n ƒë·ªÅ, ƒëo t·∫ßn su·∫•t l·ªói." },
            { q:"Trong x·ª≠ l√Ω danh s√°ch items, v√¨ sao ‚ÄúSplit in Batches‚Äù h·ªØu √≠ch h∆°n ch·∫°y m·ªôt l·∫ßn t·∫•t c·∫£?", options:["V√¨ n√≥ t·∫°o UI ƒë·∫πp h∆°n","Gi√∫p ki·ªÉm so√°t memory, retry, rate limit","V√¨ n8n b·∫Øt bu·ªôc","V√¨ n√≥ t·ª± t·∫°o bi·ªÉu ƒë·ªì"], answerIndex:1, hint:"Quy m√¥ l·ªõn s·∫Ω g·∫∑p bottleneck.", explanation:"Batch gi√∫p ·ªïn ƒë·ªãnh khi d·ªØ li·ªáu l·ªõn: tr√°nh qu√° t·∫£i v√† d·ªÖ ki·ªÉm so√°t." },
            { q:"Tr∆∞·ªùng h·ª£p n√†o n√™n d√πng ‚ÄúCode‚Äù node thay v√¨ ‚ÄúSet‚Äù node?", options:["Khi ch·ªâ rename 1 field","Khi c·∫ßn logic ph·ª©c t·∫°p, loop, ƒëi·ªÅu ki·ªán nhi·ªÅu","Khi mu·ªën ƒë·ªïi theme","Khi mu·ªën ch·∫°y cron"], answerIndex:1, hint:"Set m·∫°nh nh∆∞ng c√≥ gi·ªõi h·∫°n.", explanation:"Code node ph√π h·ª£p khi c·∫ßn x·ª≠ l√Ω ph·ª©c t·∫°p v∆∞·ª£t kh·∫£ nƒÉng mapping ƒë∆°n gi·∫£n." },
            { q:"M·ªôt c√°ch ƒë∆°n gi·∫£n ƒë·ªÉ tƒÉng ƒë·ªô tin c·∫≠y workflow khi g·ªçi API d·ªÖ l·ªói l√† g√¨?", options:["Kh√¥ng d√πng API","B·∫≠t retry/backoff v√† b·∫Øt l·ªói","T·∫Øt internet","Ch·∫°y tay"], answerIndex:1, hint:"Th·∫•t b·∫°i l√† chuy·ªán b√¨nh th∆∞·ªùng.", explanation:"Retry/backoff + b·∫Øt l·ªói gi√∫p workflow ch·ªëng ch·∫≠p ch·ªùn m·∫°ng/d·ªãch v·ª•." },
            { q:"B·∫°n mu·ªën g·ª≠i email khi ƒëi·ªÅu ki·ªán ƒë√∫ng (v√≠ d·ª• status=FAILED). C√°ch ti·∫øp c·∫≠n c∆° b·∫£n?", options:["Lu√¥n g·ª≠i m·ªçi l√∫c","D√πng IF node t·∫°o nh√°nh, r·ªìi Email node ·ªü nh√°nh ƒë√∫ng","Ch·ªâ d√πng Merge","Ch·ªâ d√πng Webhook"], answerIndex:1, hint:"ƒêi·ªÅu ki·ªán ‚Üí r·∫Ω nh√°nh.", explanation:"IF node gi√∫p t√°ch lu·ªìng theo ƒëi·ªÅu ki·ªán, ch·ªâ g·ª≠i khi th·ªèa." },
            { q:"T·∫°i sao n√™n t√°ch workflow th√†nh c√°c ‚Äúmodule‚Äù (sub-workflow) khi ph·ª©c t·∫°p?", options:["ƒê·ªÉ tƒÉng s·ªë node","ƒê·ªÉ t√°i s·ª≠ d·ª•ng v√† b·∫£o tr√¨ d·ªÖ","ƒê·ªÉ tƒÉng chi ph√≠","V√¨ UI ƒë·∫πp"], answerIndex:1, hint:"Gi·ªëng code: t√°ch h√†m.", explanation:"Modular h√≥a gi√∫p reuse, test t·ª´ng ph·∫ßn v√† gi·∫£m r·ªßi ro khi thay ƒë·ªïi." },
            { q:"Khi t√≠ch h·ª£p nhi·ªÅu h·ªá th·ªëng, ƒëi·ªÅu quan tr·ªçng nh·∫•t ƒë·ªÉ gi·∫£m l·ªói mapping l√† g√¨?", options:["ƒê·ªïi t√™n node ng·∫´u nhi√™n","Chu·∫©n h√≥a schema d·ªØ li·ªáu trung gian","Kh√¥ng c·∫ßn schema","T·∫Øt debug"], answerIndex:1, hint:"C√≥ ‚Äúng√¥n ng·ªØ chung‚Äù gi·ªØa c√°c h·ªá.", explanation:"Schema trung gian gi√∫p data contract r√µ r√†ng, gi·∫£m sai l·ªách." },
            { q:"B·∫°n mu·ªën v·ª´a ghi d·ªØ li·ªáu v√†o Sheet v·ª´a g·ª≠i th√¥ng b√°o Slack. C√°ch workflow h·ª£p l√Ω?", options:["Ch·ªâ ch·ªçn 1 vi·ªác","T·∫°o 2 nh√°nh song song ho·∫∑c tu·∫ßn t·ª± t√πy y√™u c·∫ßu, ƒë·∫£m b·∫£o log l·ªói","X√≥a Merge","ƒê·ªïi m√†u background"], answerIndex:1, hint:"M·ªôt input, nhi·ªÅu output.", explanation:"C√≥ th·ªÉ tu·∫ßn t·ª± ho·∫∑c t√°ch nh√°nh; quan tr·ªçng l√† x·ª≠ l√Ω l·ªói v√† log." }
          ],
          backup: [
            { q:"Khi ch·∫°y theo l·ªãch, b·∫°n n√™n c√¢n nh·∫Øc g√¨ ƒë·∫ßu ti√™n?", options:["M√†u n·ªÅn","Khung gi·ªù √≠t t·∫£i v√† SLA","S·ªë icon","T√™n game"], answerIndex:1, hint:"Ch·∫°y gi·ªù cao ƒëi·ªÉm d·ªÖ qu√° t·∫£i.", explanation:"Ch·ªçn l·ªãch ph√π h·ª£p gi√∫p h·ªá th·ªëng ·ªïn ƒë·ªãnh, tr√°nh tr√πng gi·ªù job kh√°c." },
            { q:"N·∫øu d·ªØ li·ªáu ƒë·∫ßu v√†o c√≥ th·ªÉ thi·∫øu field, c√°ch thi·∫øt k·∫ø an to√†n?", options:["Assume lu√¥n ƒë·ªß","Validate + default value + nh√°nh x·ª≠ l√Ω l·ªói","X√≥a node","T·∫Øt workflow"], answerIndex:1, hint:"Ph√≤ng th·ªß thay v√¨ c·∫ßu may.", explanation:"Validate & default gi√∫p tr√°nh crash; nh√°nh l·ªói gi√∫p audit." }
          ]
        },
        {
          id: "hard",
          name: "N√¢ng cao (T∆∞ duy tri·ªÉn khai & v·∫≠n h√†nh)",
          questions: [
            { q:"Trong automation, r·ªßi ro l·ªõn nh·∫•t khi ‚Äúhardcode token‚Äù trong workflow l√† g√¨?", options:["Workflow ch·∫°y ch·∫≠m","R√≤ r·ªâ secrets, m·∫•t ki·ªÉm so√°t quy·ªÅn truy c·∫≠p","UI x·∫•u","Kh√¥ng th·ªÉ d√πng Expression"], answerIndex:1, hint:"Security incident th∆∞·ªùng ƒë·∫øn t·ª´ secrets.", explanation:"Hardcode token d·ªÖ b·ªã l·ªô qua export/log/chia s·∫ª file." },
            { q:"M·ªôt nguy√™n t·∫Øc t·ªët ƒë·ªÉ thi·∫øt k·∫ø workflow b·ªÅn v·ªØng l√† g√¨?", options:["Kh√¥ng log ƒë·ªÉ nh·∫π","Idempotency / tr√°nh ch·∫°y tr√πng t·∫°o d·ªØ li·ªáu l·∫∑p","TƒÉng s·ªë node","Ch·∫°y m·ªçi th·ª© realtime"], answerIndex:1, hint:"Ch·∫°y l·∫°i kh√¥ng ƒë∆∞·ª£c t·∫°o ‚Äúnh√¢n b·∫£n‚Äù.", explanation:"Idempotent gi√∫p rerun an to√†n, gi·∫£m duplicate khi retry." },
            { q:"B·∫°n c·∫ßn x·ª≠ l√Ω 10.000 b·∫£n ghi/ng√†y. ∆Øu ti√™n t·ªëi ∆∞u n√†o tr∆∞·ªõc?", options:["Th√™m icon","Batch + gi·ªõi h·∫°n concurrency + log + retry","ƒê·ªïi theme m√†u","T·∫Øt validation"], answerIndex:1, hint:"Kh·∫£ nƒÉng ch·ªãu t·∫£i ƒë·∫øn t·ª´ ‚Äúnh·ªãp x·ª≠ l√Ω‚Äù.", explanation:"Batch & concurrency h·ª£p l√Ω gi√∫p ·ªïn ƒë·ªãnh, tr√°nh timeout v√† rate limit." },
            { q:"Khi t√≠ch h·ª£p nhi·ªÅu k√™nh (Email/Chat/CRM), th·ª© c·∫ßn chu·∫©n h√≥a s·ªõm nh·∫•t l√† g√¨?", options:["M√†u header","ID/Key ƒë·ªãnh danh v√† schema d·ªØ li·ªáu trung t√¢m","T√™n l·ªõp h·ªçc","Font ch·ªØ"], answerIndex:1, hint:"N·∫øu kh√¥ng c√≥ ID chung, s·∫Ω kh√¥ng n·ªëi ƒë∆∞·ª£c data.", explanation:"ƒê·ªãnh danh & schema trung t√¢m l√† n·ªÅn t·∫£ng cho ƒë·ªìng b·ªô ƒëa k√™nh." },
            { q:"M·ªôt c√°ch ƒëo hi·ªáu qu·∫£ automation ƒë∆°n gi·∫£n cho ƒë·ªôi v·∫≠n h√†nh?", options:["ƒê·∫øm s·ªë icon","Theo d√µi: s·ªë job ch·∫°y, % l·ªói, th·ªùi gian x·ª≠ l√Ω, s·ªë gi·ªù ti·∫øt ki·ªám","Ch·ªâ nh√¨n UI","T·∫Øt logs"], answerIndex:1, hint:"KPI ph·∫£i ƒëo ƒë∆∞·ª£c.", explanation:"C√°c ch·ªâ s·ªë v·∫≠n h√†nh gi√∫p ra quy·∫øt ƒë·ªãnh t·ªëi ∆∞u & m·ªü r·ªông." },
            { q:"N·∫øu workflow ph·ª• thu·ªôc API b√™n th·ª© 3 kh√¥ng ·ªïn ƒë·ªãnh, thi·∫øt k·∫ø n√†o h·ª£p l√Ω nh·∫•t?", options:["G·ªçi li√™n t·ª•c ƒë·∫øn khi ƒë∆∞·ª£c","Circuit breaker / retry c√≥ gi·ªõi h·∫°n / fallback queue","T·∫Øt workflow","ƒê·ªïi provider ngay"], answerIndex:1, hint:"ƒê·ª´ng ƒë·ªÉ 1 service k√©o s·∫≠p to√†n h·ªá.", explanation:"Chi·∫øn l∆∞·ª£c resilience gi√∫p gi·∫£m s·∫≠p d√¢y chuy·ªÅn v√† ki·ªÉm so√°t l·ªói." },
            { q:"B·∫°n mu·ªën ‚Äúaudit‚Äù ai ƒë√£ thay ƒë·ªïi workflow. N√™n ∆∞u ti√™n g√¨?", options:["Kh√¥ng c·∫ßn audit","Versioning + quy·ªÅn truy c·∫≠p + log thay ƒë·ªïi","TƒÉng s·ªë node","Ch·ª•p m√†n h√¨nh"], answerIndex:1, hint:"V·∫≠n h√†nh c·∫ßn truy v·∫øt.", explanation:"Versioning & access control gi√∫p truy v·∫øt v√† rollback khi c·∫ßn." },
            { q:"V√¨ sao n√™n t√°ch m√¥i tr∆∞·ªùng DEV/PROD khi tri·ªÉn khai automation?", options:["ƒê·ªÉ UI ƒë·∫πp","Gi·∫£m r·ªßi ro thay ƒë·ªïi g√¢y downtime, test an to√†n tr∆∞·ªõc khi l√™n PROD","ƒê·ªÉ c√≥ nhi·ªÅu workflow","V√¨ b·∫Øt bu·ªôc"], answerIndex:1, hint:"Test tr√™n PROD l√† t·ª± s√°t.", explanation:"T√°ch m√¥i tr∆∞·ªùng gi√∫p ki·ªÉm so√°t thay ƒë·ªïi, gi·∫£m r·ªßi ro v·∫≠n h√†nh." },
            { q:"M·ªôt chi·∫øn l∆∞·ª£c l∆∞u tr·ªØ log t·ªët th∆∞·ªùng c·∫ßn thu·ªôc t√≠nh n√†o t·ªëi thi·ªÉu?", options:["M√†u s·∫Øc","Timestamp + workflow + status + correlationId","Font ch·ªØ","Icon"], answerIndex:1, hint:"Log ph·∫£i truy v·∫øt theo ‚Äúv·ª• vi·ªác‚Äù.", explanation:"Timestamp, status, correlationId gi√∫p ƒëi·ªÅu tra incident nhanh." },
            { q:"N·∫øu c·∫ßn x·ª≠ l√Ω d·ªØ li·ªáu nh·∫°y c·∫£m, ƒëi·ªÅu n√†o n√™n l√†m ngay?", options:["B·ªè qua permission","Mask/limit d·ªØ li·ªáu + qu·∫£n tr·ªã quy·ªÅn + secrets management","TƒÉng timer","ƒê·ªïi t√™n node"], answerIndex:1, hint:"Privacy by design.", explanation:"Gi·∫£m d·ªØ li·ªáu nh·∫°y c·∫£m v√† qu·∫£n tr·ªã quy·ªÅn/secret l√† b·∫Øt bu·ªôc." },
            { q:"Trong b·ªëi c·∫£nh automation, ‚Äúrealtime‚Äù kh√°c ‚Äúasync‚Äù ·ªü ƒë√¢u (t∆∞ duy n8n c∆° b·∫£n)?", options:["Realtime lu√¥n r·∫ª h∆°n","Realtime ph·∫£n h·ªìi ngay; async x·ª≠ l√Ω n·ªÅn v√† tr·∫£ k·∫øt qu·∫£ sau","Async lu√¥n sai","Kh√¥ng kh√°c"], answerIndex:1, hint:"Li√™n quan tr·∫£i nghi·ªám v√† ƒë·ªô tr·ªÖ.", explanation:"Realtime c·∫ßn ph·∫£n h·ªìi nhanh; async x·ª≠ l√Ω n·ªÅn, ph√π h·ª£p t√°c v·ª• n·∫∑ng." },
            { q:"N·∫øu l·ªõp h·ªçc mu·ªën demo nhanh gi√° tr·ªã n8n, k·ªãch b·∫£n n√†o ‚ÄúƒÉn ƒëi·ªÉm‚Äù nh·∫•t?", options:["T·∫°o theme m·ªõi","Webhook nh·∫≠n form ‚Üí enrich d·ªØ li·ªáu ‚Üí g·ª≠i th√¥ng b√°o + l∆∞u log","Ch·ªâ m·ªü UI","TƒÉng s·ªë node v√¥ nghƒ©a"], answerIndex:1, hint:"Nh√¨n th·∫•y end-to-end.", explanation:"Demo end-to-end cho th·∫•y n8n k·∫øt n·ªëi h·ªá v√† t·∫°o gi√° tr·ªã t·ª©c th√¨." }
          ],
          backup: [
            { q:"Khi export/import workflow gi·ªØa c√°c m√°y, r·ªßi ro th∆∞·ªùng g·∫∑p nh·∫•t?", options:["M√†u n·ªÅn ƒë·ªïi","Secrets/credentials kh√¥ng ƒëi k√®m ho·∫∑c sai m√¥i tr∆∞·ªùng","Icon m·∫•t","Font b·ªã l·ªói"], answerIndex:1, hint:"Credentials th∆∞·ªùng ph·ª• thu·ªôc m√¥i tr∆∞·ªùng.", explanation:"Credentials c·∫ßn c·∫•u h√¨nh l·∫°i ƒë√∫ng m√¥i tr∆∞·ªùng; tr√°nh hardcode." },
            { q:"N·∫øu b·ªã duplicate d·ªØ li·ªáu do rerun, c√°ch kh·∫Øc ph·ª•c g·ªëc l√† g√¨?", options:["X√≥a tay","Thi·∫øt k·∫ø idempotent (key duy nh·∫•t + upsert)","T·∫Øt workflow","TƒÉng timer"], answerIndex:1, hint:"ƒê·ª´ng ch·ªâ ch·ªØa tri·ªáu ch·ª©ng.", explanation:"Upsert theo key v√† idempotency gi√∫p rerun kh√¥ng t·∫°o tr√πng." }
          ]
        }
      ]
    };

    // =========================
    // DOM helpers
    // =========================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const fmtTime = (sec) => {
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    };
    const now = () => performance.now();

    function rand01(){
      // crypto-backed if available
      if (window.crypto && crypto.getRandomValues){
        const a = new Uint32Array(1);
        crypto.getRandomValues(a);
        return a[0] / 4294967295;
      }
      return Math.random();
    }
    function shuffle(arr){
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--){
        const j = Math.floor(rand01() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // =========================
    // State
    // =========================
    const state = {
      mode: 'student',               // student | teacher
      teacherAuthed: false,
      manualReveal: true,

      setId: CONFIG.questionSets[0].id,
      questions: [],
      backup: [],
      total: CONFIG.settings.totalQuestions,

      idx: -1,
      selected: null,
      locked: false,
      revealed: false,

      lifelines: { fifty:false, ask:false, swap:false },
      fiftyEliminated: new Set(),

      score: 0,
      streak: 0,

      running: false,
      paused: false,
      timePerQ: CONFIG.settings.timePerQuestionSec,
      remain: CONFIG.settings.timePerQuestionSec,
      timerId: null,

      startedAt: 0,
      totalElapsedSec: 0,
      qStartedAt: 0,

      history: [] // {q, correctIndex, chosenIndex, isCorrect, timeSpentSec, used:{...}}
    };

    // =========================
    // Elements
    // =========================
    const el = {
      gameTitle: $('#gameTitle'),
      gameTagline: $('#gameTagline'),
      logoBox: $('#logoBox'),

      modeBadge: $('#modeBadge'),
      roundText: $('#roundText'),

      timerText: $('#timerText'),
      scoreText: $('#scoreText'),
      progressText: $('#progressText'),
      streakText: $('#streakText'),

      setName: $('#setName'),
      qText: $('#qText'),
      statusLine: $('#statusLine'),
      hintBox: $('#hintBox'),
      hintText: $('#hintText'),
      explainBox: $('#explainBox'),
      explainText: $('#explainText'),

      answers: $$('.ans'),
      aTxt: [$('#a0'),$('#a1'),$('#a2'),$('#a3')],

      btnStart: $('#btnStart'),
      btnHint: $('#btnHint'),
      btnLock: $('#btnLock'),
      btnRevealStudent: $('#btnRevealStudent'),
      btnNextStudent: $('#btnNextStudent'),

      btnReset: $('#btnReset'),
      btnTeacher: $('#btnTeacher'),
      btnExport: $('#btnExport'),

      ladderList: $('#ladderList'),
      prizeNow: $('#prizeNow'),

      life5050: $('#life5050'),
      lifeAsk: $('#lifeAsk'),
      lifeSwap: $('#lifeSwap'),

      // teacher
      teacherPanel: $('#teacherPanel'),
      teacherState: $('#teacherState'),
      btnTeacherClose: $('#btnTeacherClose'),
      selSet: $('#selSet'),
      inpTime: $('#inpTime'),
      swManual: $('#swManual'),
      tBtnStart: $('#tBtnStart'),
      tBtnPause: $('#tBtnPause'),
      tBtnReveal: $('#tBtnReveal'),
      tBtnNext: $('#tBtnNext'),
      tBtnReset: $('#tBtnReset'),

      // overlays
      ovTeacher: $('#ovTeacher'),
      btnTeacherCancel: $('#btnTeacherCancel'),
      btnTeacherOk: $('#btnTeacherOk'),
      inpPass: $('#inpPass'),
      passStatus: $('#passStatus'),

      ovPoll: $('#ovPoll'),
      pollBody: $('#pollBody'),
      btnPollClose: $('#btnPollClose'),
      btnPollOk: $('#btnPollOk'),

      ovFinal: $('#ovFinal'),
      finalChoiceText: $('#finalChoiceText'),
      btnFinalClose: $('#btnFinalClose'),
      btnFinalNo: $('#btnFinalNo'),
      btnFinalYes: $('#btnFinalYes'),

      ovResult: $('#ovResult'),
      btnResultClose: $('#btnResultClose'),
      rScore: $('#rScore'),
      rCorrect: $('#rCorrect'),
      rWrong: $('#rWrong'),
      rTime: $('#rTime'),
      rSet: $('#rSet'),
      resultCanvas: $('#resultCanvas'),
      btnRender: $('#btnRender'),
      btnDownload: $('#btnDownload'),
      btnPlayAgain: $('#btnPlayAgain'),

      toast: $('#toast')
    };

    // =========================
    // UI init
    // =========================
    function initBrand(){
      el.gameTitle.textContent = CONFIG.text.gameTitle;
      el.gameTagline.textContent = `${CONFIG.text.tagline} ‚Ä¢ Ch·∫ø ƒë·ªô H·ªçc vi√™n`;
      el.logoBox.innerHTML = CONFIG.assets.logoSvg;
    }

    function buildSetOptions(){
      el.selSet.innerHTML = '';
      for (const s of CONFIG.questionSets){
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        el.selSet.appendChild(opt);
      }
    }

    function buildLadder(){
      const n = state.total;
      const pts = CONFIG.settings.pointsLadder.slice(0, n);
      el.ladderList.innerHTML = '';
      for (let i=0;i<n;i++){
        const li = document.createElement('li');
        li.className = 'step';
        const level = i + 1;
        const isSafe = CONFIG.settings.safeLevels.includes(level);
        if (isSafe) li.classList.add('safe');

        li.dataset.level = String(level);
        li.innerHTML = `
          <span class="n">#${String(level).padStart(2,'0')}</span>
          <span class="muted2">${level <= 4 ? 'Warm-up' : (level <= 8 ? 'Core' : 'Boss')}</span>
          <span class="p">${pts[i].toLocaleString('vi-VN')}</span>
        `;
        el.ladderList.appendChild(li);
      }
      updateLadder();
    }

    function toast(msg){
      el.toast.textContent = msg;
      el.toast.classList.add('show');
      el.toast.style.opacity = '1';
      el.toast.style.transform = 'translateX(-50%) translateY(0)';
      window.clearTimeout(toast._t);
      toast._t = window.setTimeout(()=>{
        el.toast.style.opacity = '0';
        el.toast.style.transform = 'translateX(-50%) translateY(6px)';
        window.setTimeout(()=> el.toast.classList.remove('show'), 160);
      }, 1600);
    }

    function setOverlay(overlayEl, show){
      overlayEl.classList.toggle('show', !!show);
      if (show){
        // focus first input/button
        const focusable = overlayEl.querySelector('input,button,select,[tabindex]');
        if (focusable) focusable.focus();
      }
    }

    // =========================
    // Data selection
    // =========================
    function getSetById(id){
      return CONFIG.questionSets.find(s => s.id === id) || CONFIG.questionSets[0];
    }

    function loadSet(id){
      const set = getSetById(id);
      state.setId = set.id;
      state.questions = set.questions.slice(0, state.total).map((q, i) => ({...q, level: i+1}));
      state.backup = set.backup.slice();
      el.setName.textContent = `B·ªô ƒë·ªÅ: ${set.name}`;
      el.selSet.value = set.id;
      el.rSet.textContent = set.name;
      return set;
    }

    // =========================
    // Game control
    // =========================
    function hardReset(keepSet=true){
      stopTimer();

      state.running = false;
      state.paused = false;

      state.idx = -1;
      state.selected = null;
      state.locked = false;
      state.revealed = false;

      state.lifelines = { fifty:false, ask:false, swap:false };
      state.fiftyEliminated = new Set();

      state.score = 0;
      state.streak = 0;

      state.startedAt = 0;
      state.totalElapsedSec = 0;
      state.qStartedAt = 0;

      state.history = [];

      state.timePerQ = clamp(Number(el.inpTime.value || CONFIG.settings.timePerQuestionSec), 10, 300);
      state.remain = state.timePerQ;

      if (!keepSet){
        loadSet(CONFIG.questionSets[0].id);
      } else {
        loadSet(state.setId);
      }

      renderAll();
      setQuestionUIIdle();
      updateTeacherState();
    }

    function startGame(){
      if (state.running) return;
      state.running = true;
      state.paused = false;
      state.startedAt = now();
      state.totalElapsedSec = 0;
      nextQuestion(true);
      updateTeacherState();
    }

    function pauseGame(){
      if (!state.running || state.paused) return;
      state.paused = true;
      stopTimer();
      // accumulate elapsed total until pause moment
      state.totalElapsedSec += (now() - state.startedAt) / 1000;
      state.startedAt = now(); // reset base for resume
      toast('ƒê√£ pause');
      updateTeacherState();
    }

    function resumeGame(){
      if (!state.running) { startGame(); return; }
      if (!state.paused) return;
      state.paused = false;
      state.startedAt = now();
      state.qStartedAt = now();
      startTimer();
      toast('Ti·∫øp t·ª•c');
      updateTeacherState();
    }

    function endGame(reason){
      state.running = false;
      state.paused = false;
      stopTimer();

      // accumulate total time
      if (state.startedAt){
        state.totalElapsedSec += (now() - state.startedAt) / 1000;
      }

      el.roundText.textContent = reason || 'K·∫øt th√∫c';
      updateTeacherState();
      openResult();
    }

    function nextQuestion(isFirst=false){
      stopTimer();

      state.selected = null;
      state.locked = false;
      state.revealed = false;
      state.fiftyEliminated = new Set();

      state.idx = isFirst ? 0 : state.idx + 1;

      if (state.idx >= state.total){
        endGame('Ho√†n th√†nh t·∫•t c·∫£ c√¢u!');
        return;
      }

      // reset per question timer
      state.remain = state.timePerQ;
      state.qStartedAt = now();

      renderQuestion();
      clearFeedback();
      startTimer();

      el.roundText.textContent = `C√¢u ${state.idx+1}/${state.total}`;
      updateTeacherState();
    }

    function setQuestionUIIdle(){
      el.roundText.textContent = 'Ch∆∞a b·∫Øt ƒë·∫ßu';
      el.qText.innerHTML = `Nh·∫•n <strong>Start</strong> ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i.`;
      el.aTxt.forEach(t => t.textContent = '‚Äî');
      el.answers.forEach(b=>{
        b.classList.remove('selected','locked','correct','wrong');
        b.setAttribute('aria-disabled','true');
      });
      el.btnLock.disabled = true;
      el.btnHint.disabled = true;
      el.btnRevealStudent.disabled = true;
      el.btnNextStudent.disabled = true;
      el.btnStart.disabled = false;

      el.hintBox.classList.remove('show');
      el.explainBox.style.display = 'none';
      el.statusLine.textContent = '';
      el.timerText.textContent = fmtTime(state.remain);
    }

    // =========================
    // Timer
    // =========================
    function stopTimer(){
      if (state.timerId){
        clearInterval(state.timerId);
        state.timerId = null;
      }
    }

    function startTimer(){
      stopTimer();
      if (!state.running || state.paused) return;

      el.timerText.textContent = fmtTime(state.remain);

      state.timerId = setInterval(()=>{
        state.remain -= 0.25;
        if (state.remain <= 0){
          state.remain = 0;
          el.timerText.textContent = fmtTime(0);
          stopTimer();
          onTimeout();
          return;
        }
        el.timerText.textContent = fmtTime(state.remain);
      }, 250);
    }

    function onTimeout(){
      if (!state.running) return;
      if (state.revealed) return;

      el.statusLine.innerHTML = `<span class="warn">H·∫øt gi·ªù!</span> Kh√¥ng k·ªãp ch·ªët ƒë√°p √°n.`;
      // time-out = wrong => end
      revealAnswer(null, { timedOut:true });
    }

    // =========================
    // Rendering
    // =========================
    function renderAll(){
      updateHud();
      updateLadder();
      updateLifelinesUI();
      updateModeUI();
      updateStudentButtons();
    }

    function updateHud(){
      el.scoreText.textContent = state.score.toLocaleString('vi-VN');
      el.progressText.textContent = `${Math.max(0, state.idx+1)}/${state.total}`;
      el.streakText.textContent = `Streak: ${state.streak}`;
      el.timerText.textContent = fmtTime(state.remain);
      el.prizeNow.textContent = (state.idx >= 0 && state.idx < state.total)
        ? `M·ª©c: #${String(state.idx+1).padStart(2,'0')} ‚Ä¢ ${CONFIG.settings.pointsLadder[state.idx].toLocaleString('vi-VN')}`
        : '‚Äî';
    }

    function updateLadder(){
      const steps = $$('.step', el.ladderList);
      steps.forEach(step=>{
        step.classList.remove('current','done');
      });
      const currentLevel = state.idx + 1;
      steps.forEach(step=>{
        const lvl = Number(step.dataset.level);
        if (lvl === currentLevel) step.classList.add('current');
        if (lvl < currentLevel) step.classList.add('done');
      });
    }

    function updateLifelinesUI(){
      el.life5050.classList.toggle('used', state.lifelines.fifty);
      el.lifeAsk.classList.toggle('used', state.lifelines.ask);
      el.lifeSwap.classList.toggle('used', state.lifelines.swap);

      el.life5050.disabled = !state.running || state.revealed || state.locked || state.lifelines.fifty;
      el.lifeAsk.disabled  = !state.running || state.revealed || state.locked || state.lifelines.ask;
      el.lifeSwap.disabled = !state.running || state.revealed || state.locked || state.lifelines.swap;
    }

    function updateModeUI(){
      const isTeacher = state.mode === 'teacher' && state.teacherAuthed;
      el.modeBadge.innerHTML = isTeacher
        ? `<span class="miniDot"></span><span>Teacher Mode</span>`
        : `<span class="miniDot"></span><span>Student Mode</span>`;

      el.gameTagline.textContent = `${CONFIG.text.tagline} ‚Ä¢ ${isTeacher ? 'Ch·∫ø ƒë·ªô Gi√°o vi√™n' : 'Ch·∫ø ƒë·ªô H·ªçc vi√™n'}`;
      el.teacherPanel.classList.toggle('show', isTeacher);

      // Student controls visible always, but enabled/disabled based on mode
      el.btnRevealStudent.style.display = isTeacher ? 'none' : 'inline-flex';
      el.btnNextStudent.style.display = isTeacher ? 'none' : 'inline-flex';
    }

    function updateStudentButtons(){
      const canInteract = state.running && !state.paused && state.idx >= 0 && !state.revealed;

      el.answers.forEach(btn=>{
        btn.setAttribute('aria-disabled', String(!canInteract || state.locked || state.fiftyEliminated.has(Number(btn.dataset.idx))));
      });

      el.btnHint.disabled = !state.running || state.idx < 0;
      el.btnLock.disabled = !canInteract || state.selected === null || state.locked;
      el.btnRevealStudent.disabled = !state.running || state.idx < 0 || state.revealed || (state.mode === 'teacher' && state.teacherAuthed) || !state.locked;
      el.btnNextStudent.disabled = !state.running || state.idx < 0 || !state.revealed;
      el.btnStart.disabled = state.running && !state.paused;
      updateHud();
      updateLadder();
      updateLifelinesUI();
    }

    function clearFeedback(){
      el.statusLine.textContent = '';
      el.explainBox.style.display = 'none';
      el.explainBox.classList.remove('bad');
    }

    function renderQuestion(){
      const q = state.questions[state.idx];
      el.qText.textContent = q.q;

      for (let i=0;i<4;i++){
        el.aTxt[i].textContent = q.options[i];
      }

      el.answers.forEach(btn=>{
        btn.classList.remove('selected','locked','correct','wrong');
      });

      // Hint availability
      const hasHint = Boolean(q.hint && String(q.hint).trim());
      el.btnHint.disabled = !hasHint;
      if (!hasHint) el.hintBox.classList.remove('show');

      // enable answers
      el.answers.forEach(btn => btn.setAttribute('aria-disabled','false'));

      // Student buttons initial
      el.btnLock.disabled = true;
      el.btnRevealStudent.disabled = true;
      el.btnNextStudent.disabled = true;

      updateStudentButtons();
      updateTeacherState();
    }

    // =========================
    // Answer selection / reveal
    // =========================
    function onSelectAnswer(i){
      if (!state.running || state.paused || state.revealed) return;
      if (state.locked) return;
      if (state.fiftyEliminated.has(i)) return;

      state.selected = i;
      el.answers.forEach(btn => btn.classList.toggle('selected', Number(btn.dataset.idx) === i));
      el.statusLine.textContent = '';
      updateStudentButtons();
    }

    function openFinalConfirm(){
      if (!state.running || state.paused || state.revealed) return;
      if (state.selected === null) return;
      if (state.locked) return;

      const q = state.questions[state.idx];
      const key = ['A','B','C','D'][state.selected];
      el.finalChoiceText.textContent = `${key}. ${q.options[state.selected]}`;
      setOverlay(el.ovFinal, true);
    }

    function lockAnswer(){
      if (!state.running || state.paused || state.revealed) return;
      if (state.selected === null || state.locked) return;

      state.locked = true;
      el.answers.forEach(btn=>{
        const idx = Number(btn.dataset.idx);
        btn.classList.toggle('locked', idx === state.selected);
      });

      el.statusLine.innerHTML = `ƒê√£ ch·ªët ƒë√°p √°n: <strong>${['A','B','C','D'][state.selected]}</strong>.`;

      // In Student mode: auto reveal unless teacher mode with Manual Reveal enabled
      if (!(state.mode === 'teacher' && state.teacherAuthed && state.manualReveal)){
        // small delay for dramatic effect
        setTimeout(()=> revealAnswer(state.selected), 450);
      } else {
        toast('Ch·ªù gi√°o vi√™n b·∫•m Reveal');
      }

      updateStudentButtons();
      updateTeacherState();
    }

    function revealAnswer(chosenIndex, opts={}){
      if (!state.running || state.paused) return;
      if (state.revealed) return;

      state.revealed = true;
      stopTimer();

      const q = state.questions[state.idx];
      const correct = q.answerIndex;
      const isCorrect = (chosenIndex === correct);

      // time spent
      const spent = clamp(state.timePerQ - state.remain, 0, state.timePerQ);

      // mark UI
      el.answers.forEach(btn=>{
        const i = Number(btn.dataset.idx);
        btn.classList.remove('locked');
        if (i === correct) btn.classList.add('correct');
        if (chosenIndex !== null && i === chosenIndex && !isCorrect) btn.classList.add('wrong');
        btn.setAttribute('aria-disabled','true');
      });

      // Explanation
      const exp = q.explanation ? String(q.explanation) : '';
      if (exp){
        el.explainText.textContent = exp;
        el.explainBox.style.display = 'block';
        el.explainBox.classList.toggle('bad', !isCorrect);
      }

      // status + scoring
      if (opts.timedOut){
        el.statusLine.innerHTML = `<span class="no">Sai</span> (H·∫øt gi·ªù) ‚Ä¢ ƒê√°p √°n ƒë√∫ng: <strong>${['A','B','C','D'][correct]}</strong>`;
      } else if (chosenIndex === null){
        el.statusLine.innerHTML = `<span class="no">Sai</span> ‚Ä¢ B·∫°n ch∆∞a ch·ªët ƒë√°p √°n ‚Ä¢ ƒê√∫ng: <strong>${['A','B','C','D'][correct]}</strong>`;
      } else if (isCorrect){
        el.statusLine.innerHTML = `<span class="ok">ƒê√∫ng!</span> ‚Ä¢ +${CONFIG.settings.pointsLadder[state.idx].toLocaleString('vi-VN')} ƒëi·ªÉm`;
      } else {
        el.statusLine.innerHTML = `<span class="no">Sai</span> ‚Ä¢ ƒê√°p √°n ƒë√∫ng: <strong>${['A','B','C','D'][correct]}</strong>`;
      }

      // record history
      state.history.push({
        q: q.q,
        options: q.options.slice(),
        correctIndex: correct,
        chosenIndex: chosenIndex,
        isCorrect: isCorrect,
        timeSpentSec: spent,
        used: {
          fifty: state.lifelines.fifty,
          ask: state.lifelines.ask,
          swap: state.lifelines.swap
        }
      });

      if (isCorrect){
        state.score += CONFIG.settings.pointsLadder[state.idx];
        state.streak += 1;

        if (state.streak > 0 && (state.streak % CONFIG.settings.streakBonusEvery === 0)){
          state.score += CONFIG.settings.streakBonusPoints;
          toast(`Streak bonus +${CONFIG.settings.streakBonusPoints}!`);
        }

        // enable next
        if (state.mode === 'teacher' && state.teacherAuthed){
          // teacher controls next
          toast('ƒê√∫ng! Gi√°o vi√™n b·∫•m Next');
        } else {
          el.btnNextStudent.disabled = false;
          toast('ƒê√∫ng! B·∫•m Next');
        }
      } else {
        // wrong: end game (Millionaire style)
        state.streak = 0;

        // compute "safe" payout (optional, keep for summary only)
        const safe = getSafeScore();
        if (safe > 0){
          toast(`Game over ‚Ä¢ M·ªëc an to√†n: ${safe.toLocaleString('vi-VN')}`);
        } else {
          toast('Game over');
        }

        // stop and show result
        endGame('Game over');
      }

      updateStudentButtons();
      updateTeacherState();
      updateHud();
      updateLadder();
    }

    function getSafeScore(){
      // Highest safe level passed (answered correctly) -> score at that level
      const safeLvls = CONFIG.settings.safeLevels.slice().sort((a,b)=>a-b);
      let best = 0;
      for (const lvl of safeLvls){
        if (state.idx + 1 >= lvl){
          // if we are past or at safe level, and all previous correct? Millionaire normally ends on wrong,
          // but for display: best safe = sum points up to that lvl
          const pts = CONFIG.settings.pointsLadder.slice(0, lvl).reduce((a,b)=>a+b, 0);
          best = pts;
        }
      }
      return best;
    }

    // =========================
    // Lifelines
    // =========================
    function use5050(){
      if (state.lifelines.fifty || !state.running || state.locked || state.revealed) return;

      const q = state.questions[state.idx];
      const correct = q.answerIndex;
      const wrongs = [0,1,2,3].filter(i => i !== correct);
      const keepWrong = wrongs[Math.floor(rand01()*wrongs.length)];
      const eliminate = wrongs.filter(i => i !== keepWrong);
      state.fiftyEliminated = new Set(eliminate);
      state.lifelines.fifty = true;

      // visually disable eliminated
      el.answers.forEach(btn=>{
        const i = Number(btn.dataset.idx);
        if (state.fiftyEliminated.has(i)){
          btn.setAttribute('aria-disabled','true');
          btn.classList.remove('selected');
        }
      });

      if (state.selected !== null && state.fiftyEliminated.has(state.selected)){
        state.selected = null;
      }

      toast('ƒê√£ d√πng 50:50');
      updateLifelinesUI();
      updateStudentButtons();
      updateTeacherState();
    }

    function useAskClass(){
      if (state.lifelines.ask || !state.running || state.locked || state.revealed) return;

      state.lifelines.ask = true;
      updateLifelinesUI();
      updateTeacherState();

      const q = state.questions[state.idx];
      const correct = q.answerIndex;
      const difficulty = (state.idx + 1) / state.total; // 0..1

      // bias: easy => strong toward correct; hard => flatter
      const baseCorrect = 0.70 - (0.35 * difficulty); // 0.70 -> 0.35
      const noise = (rand01() - 0.5) * 0.10;          // ¬±0.05
      let pCorrect = clamp(baseCorrect + noise, 0.28, 0.78);

      const remaining = 1 - pCorrect;
      const others = [0,1,2,3].filter(i => i !== correct);
      const splits = shuffle([rand01(), rand01(), rand01()]);
      const sum = splits.reduce((a,b)=>a+b, 0.00001);
      const dist = {};
      dist[correct] = pCorrect;
      for (let i=0;i<3;i++){
        dist[others[i]] = remaining * (splits[i]/sum);
      }

      // convert to 100% integers with rounding
      let perc = [0,0,0,0].map((_,i)=>Math.round(dist[i]*100));
      let diff100 = 100 - perc.reduce((a,b)=>a+b,0);
      // fix rounding diff
      while (diff100 !== 0){
        const k = Math.floor(rand01()*4);
        if (diff100 > 0){ perc[k] += 1; diff100 -= 1; }
        else if (perc[k] > 0){ perc[k] -= 1; diff100 += 1; }
      }

      renderPoll(perc);
      setOverlay(el.ovPoll, true);

      // animate bars after open
      requestAnimationFrame(()=>{
        $$('#pollBody .bar > i').forEach((bar, i)=>{
          bar.style.width = perc[i] + '%';
        });
      });
    }

    function renderPoll(perc){
      el.pollBody.innerHTML = '';
      const keys = ['A','B','C','D'];
      for (let i=0;i<4;i++){
        const row = document.createElement('div');
        row.className = 'barRow';
        row.innerHTML = `
          <div class="barKey" aria-hidden="true">${keys[i]}</div>
          <div class="bar" aria-label="T·ª∑ l·ªá ${keys[i]}"><i></i></div>
          <div class="pct">${perc[i]}%</div>
        `;
        el.pollBody.appendChild(row);
      }
    }

    function useSwap(){
      if (state.lifelines.swap || !state.running || state.locked || state.revealed) return;

      const level = state.idx + 1;
      const b = state.backup.shift();
      if (!b){
        toast('Kh√¥ng c√≤n c√¢u d·ª± ph√≤ng');
        state.lifelines.swap = true; // still consumed to avoid repeated clicks
        updateLifelinesUI();
        return;
      }

      // replace current question (keep same level)
      const replaced = {...b, level};
      state.questions[state.idx] = replaced;
      state.lifelines.swap = true;
      state.selected = null;
      state.fiftyEliminated = new Set();

      toast('ƒê√£ ƒë·ªïi c√¢u');
      renderQuestion();
      updateLifelinesUI();
      updateStudentButtons();
      updateTeacherState();
    }

    // =========================
    // Teacher mode
    // =========================
    function openTeacherLogin(){
      el.inpPass.value = '';
      el.passStatus.textContent = 'Ch∆∞a x√°c th·ª±c';
      setOverlay(el.ovTeacher, true);
    }

    function authTeacher(){
      const pass = String(el.inpPass.value || '').trim();
      if (pass === CONFIG.text.teacherPass){
        state.teacherAuthed = true;
        state.mode = 'teacher';
        el.passStatus.textContent = '‚úÖ ƒê√∫ng m·∫≠t kh·∫©u. Teacher Mode ƒë√£ b·∫≠t.';
        setOverlay(el.ovTeacher, false);
        el.teacherPanel.classList.add('show');
        updateModeUI();
        updateTeacherState();
        toast('Teacher Mode: ON');
      } else {
        el.passStatus.textContent = '‚ùå Sai m·∫≠t kh·∫©u. Th·ª≠ l·∫°i.';
        el.inpPass.focus();
      }
    }

    function closeTeacher(){
      state.mode = 'student';
      // keep authed true for convenience; just hide panel
      updateModeUI();
      updateTeacherState();
      toast('Teacher Mode: OFF');
    }

    function updateTeacherState(){
      const isTeacher = state.mode === 'teacher' && state.teacherAuthed;
      if (!isTeacher){
        el.teacherState.textContent = '‚Äî';
        return;
      }
      let s = 'Ready';
      if (!state.running) s = 'Ready ‚Ä¢ ch∆∞a ch·∫°y';
      else if (state.paused) s = 'Paused';
      else if (state.revealed) s = 'Revealed ‚Ä¢ ch·ªù Next';
      else if (state.locked) s = 'Locked ‚Ä¢ ch·ªù Reveal';
      else s = 'Running ‚Ä¢ ch·ªù ch·ªçn ƒë√°p √°n';
      el.teacherState.textContent = s;

      el.tBtnReveal.disabled = !state.running || state.paused || state.revealed || (!state.locked && state.remain > 0);
      el.tBtnNext.disabled = !state.running || state.paused || !state.revealed;
      el.tBtnPause.disabled = !state.running || state.paused;
      el.tBtnStart.disabled = (state.running && !state.paused);

      // teacher inputs
      el.inpTime.value = String(state.timePerQ);
      el.selSet.value = state.setId;
      el.swManual.classList.toggle('on', state.manualReveal);
      el.swManual.setAttribute('aria-checked', String(!!state.manualReveal));
    }

    function teacherStartResume(){
      if (!state.running) startGame();
      else resumeGame();
    }

    function teacherReveal(){
      if (!state.running || state.paused || state.revealed) return;
      // if locked, reveal with selected; else treat as no lock
      if (!state.locked){
        revealAnswer(null);
      } else {
        revealAnswer(state.selected);
      }
    }

    function teacherNext(){
      if (!state.running || state.paused || !state.revealed) return;
      nextQuestion(false);
    }

    function teacherApplySet(){
      const newId = el.selSet.value;
      if (!newId) return;

      if (state.running){
        // switching set mid game resets (no confirm to keep class flow)
        toast('ƒê·ªïi b·ªô ƒë·ªÅ ‚Üí Reset v√°n');
      }
      loadSet(newId);
      hardReset(true);
    }

    function teacherApplyTime(){
      const n = clamp(Number(el.inpTime.value || CONFIG.settings.timePerQuestionSec), 10, 300);
      state.timePerQ = n;
      if (!state.running || state.idx < 0){
        state.remain = n;
        updateHud();
      }
      toast(`Timer: ${n}s/c√¢u`);
      updateTeacherState();
    }

    function toggleManualReveal(){
      state.manualReveal = !state.manualReveal;
      el.swManual.classList.toggle('on', state.manualReveal);
      el.swManual.setAttribute('aria-checked', String(!!state.manualReveal));
      toast(`Manual Reveal: ${state.manualReveal ? 'ON' : 'OFF'}`);
      updateTeacherState();
    }

    // =========================
    // Result image export (canvas)
    // =========================
    function openResult(){
      // fill numbers
      const correct = state.history.filter(x=>x.isCorrect).length;
      const wrong = state.history.filter(x=>!x.isCorrect).length;
      el.rScore.textContent = state.score.toLocaleString('vi-VN');
      el.rCorrect.textContent = String(correct);
      el.rWrong.textContent = String(wrong);
      el.rTime.textContent = fmtTime(state.totalElapsedSec);
      el.rSet.textContent = getSetById(state.setId).name;

      // auto render once
      renderResultCanvas();
      setOverlay(el.ovResult, true);
    }

    function renderResultCanvas(){
      const c = el.resultCanvas;
      const ctx = c.getContext('2d');
      const W = c.width, H = c.height;

      // background
      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0, '#07122a');
      g.addColorStop(1, '#06101f');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,W,H);

      // glow blobs
      function blob(x,y,r, col){
        const gg = ctx.createRadialGradient(x,y,0,x,y,r);
        gg.addColorStop(0, col);
        gg.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = gg;
        ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
      }
      blob(260,160,240,'rgba(74,163,255,.24)');
      blob(980,140,260,'rgba(47,125,255,.18)');
      blob(860,560,260,'rgba(59,226,143,.12)');

      // grid lines
      ctx.globalAlpha = 0.22;
      ctx.strokeStyle = 'rgba(255,255,255,.16)';
      ctx.lineWidth = 1;
      for (let x=60;x<W;x+=80){ ctx.beginPath(); ctx.moveTo(x,40); ctx.lineTo(x,H-40); ctx.stroke(); }
      for (let y=60;y<H;y+=80){ ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(W-40,y); ctx.stroke(); }
      ctx.globalAlpha = 1;

      // title
      ctx.fillStyle = 'rgba(234,241,255,.95)';
      ctx.font = '800 44px ' + CONFIG.assets.fontFamily || 'system-ui';
      ctx.font = '800 44px ' + 'system-ui';
      ctx.fillText(CONFIG.text.gameTitle, 64, 92);

      ctx.fillStyle = 'rgba(234,241,255,.72)';
      ctx.font = '600 20px system-ui';
      ctx.fillText(`${CONFIG.text.tagline} ‚Ä¢ ${getSetById(state.setId).name}`, 64, 124);

      // stats cards
      const stats = [
        { k:'SCORE', v: state.score.toLocaleString('vi-VN') },
        { k:'CORRECT', v: String(state.history.filter(x=>x.isCorrect).length) },
        { k:'WRONG', v: String(state.history.filter(x=>!x.isCorrect).length) },
        { k:'TIME', v: fmtTime(state.totalElapsedSec) },
      ];

      const cardX = 64, cardY = 160, cardW = 260, cardH = 92, gap = 16;
      stats.forEach((s,i)=>{
        const x = cardX + i*(cardW+gap);
        const y = cardY;
        // card
        ctx.fillStyle = 'rgba(255,255,255,.06)';
        ctx.strokeStyle = 'rgba(255,255,255,.14)';
        roundRect(ctx, x, y, cardW, cardH, 18);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = 'rgba(234,241,255,.62)';
        ctx.font = '700 14px system-ui';
        ctx.fillText(s.k, x+18, y+30);

        ctx.fillStyle = 'rgba(234,241,255,.95)';
        ctx.font = '900 28px system-ui';
        ctx.fillText(s.v, x+18, y+68);
      });

      // list results (last/first)
      const listX = 64, listY = 280, listW = W-128, listH = H-340;
      ctx.fillStyle = 'rgba(255,255,255,.05)';
      ctx.strokeStyle = 'rgba(255,255,255,.14)';
      roundRect(ctx, listX, listY, listW, listH, 22);
      ctx.fill(); ctx.stroke();

      ctx.fillStyle = 'rgba(234,241,255,.75)';
      ctx.font = '800 16px system-ui';
      ctx.fillText('Chi ti·∫øt (t·ªëi ƒëa 10 d√≤ng)', listX+18, listY+34);

      const lines = state.history.slice(0, 10);
      const lineStartY = listY + 64;
      const lh = 28;

      ctx.font = '600 14px system-ui';
      lines.forEach((h, i)=>{
        const y = lineStartY + i*lh;
        const lvl = i + 1;
        const cKey = ['A','B','C','D'][h.correctIndex];
        const uKey = (h.chosenIndex === null || h.chosenIndex === undefined) ? '‚Äî' : ['A','B','C','D'][h.chosenIndex];

        // status dot
        ctx.fillStyle = h.isCorrect ? 'rgba(59,226,143,.95)' : 'rgba(255,77,109,.95)';
        ctx.beginPath(); ctx.arc(listX+22, y-6, 6, 0, Math.PI*2); ctx.fill();

        ctx.fillStyle = 'rgba(234,241,255,.88)';
        const qShort = ellipsis(h.q, 72);
        ctx.fillText(`#${String(lvl).padStart(2,'0')}  ${qShort}`, listX+38, y);

        ctx.fillStyle = 'rgba(234,241,255,.62)';
        ctx.fillText(`B·∫°n: ${uKey}  |  ƒê√∫ng: ${cKey}  |  ${Math.round(h.timeSpentSec)}s`, listX + listW - 320, y);
      });

      // footer
      ctx.fillStyle = 'rgba(234,241,255,.52)';
      ctx.font = '600 12px system-ui';
      ctx.fillText(`Generated in-browser ‚Ä¢ ${new Date().toLocaleString('vi-VN')}`, 64, H-52);
      ctx.fillText(`${CONFIG.text.brand}`, W-64-ctx.measureText(CONFIG.text.brand).width, H-52);

      // set download
      const url = c.toDataURL('image/png');
      el.btnDownload.href = url;
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function ellipsis(str, max){
      const s = String(str || '');
      if (s.length <= max) return s;
      return s.slice(0, max-1) + '‚Ä¶';
    }

    // =========================
    // Events
    // =========================
    function bindEvents(){
      // answer buttons
      el.answers.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const disabled = btn.getAttribute('aria-disabled') === 'true';
          if (disabled) return;
          onSelectAnswer(Number(btn.dataset.idx));
        });
      });

      el.btnStart.addEventListener('click', ()=>{
        if (!state.running) startGame();
        else if (state.paused) resumeGame();
      });

      el.btnHint.addEventListener('click', ()=>{
        if (!state.running || state.idx < 0) return;
        const q = state.questions[state.idx];
        if (!q.hint) { toast('Kh√¥ng c√≥ hint'); return; }
        el.hintText.textContent = q.hint;
        el.hintBox.classList.toggle('show');
      });

      el.btnLock.addEventListener('click', openFinalConfirm);

      el.btnRevealStudent.addEventListener('click', ()=>{
        if (state.mode === 'teacher' && state.teacherAuthed) return;
        if (!state.locked) { toast('H√£y ch·ªët ƒë√°p √°n tr∆∞·ªõc'); return; }
        revealAnswer(state.selected);
      });

      el.btnNextStudent.addEventListener('click', ()=>{
        if (state.mode === 'teacher' && state.teacherAuthed) return;
        if (!state.revealed) return;
        nextQuestion(false);
      });

      el.btnReset.addEventListener('click', ()=>{
        hardReset(true);
        toast('ƒê√£ reset');
      });

      el.btnTeacher.addEventListener('click', ()=>{
        if (state.teacherAuthed){
          state.mode = 'teacher';
          updateModeUI();
          updateTeacherState();
          toast('Teacher Mode: ON');
        } else {
          openTeacherLogin();
        }
      });

      el.btnTeacherClose.addEventListener('click', closeTeacher);
      el.btnTeacherCancel.addEventListener('click', ()=> setOverlay(el.ovTeacher, false));
      el.btnTeacherOk.addEventListener('click', authTeacher);
      el.inpPass.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') authTeacher();
      });

      // teacher panel controls
      el.tBtnStart.addEventListener('click', teacherStartResume);
      el.tBtnPause.addEventListener('click', pauseGame);
      el.tBtnReveal.addEventListener('click', teacherReveal);
      el.tBtnNext.addEventListener('click', teacherNext);
      el.tBtnReset.addEventListener('click', ()=>{ hardReset(true); toast('ƒê√£ reset'); });

      el.selSet.addEventListener('change', teacherApplySet);
      el.inpTime.addEventListener('change', teacherApplyTime);

      // toggle manual reveal
      el.swManual.addEventListener('click', toggleManualReveal);
      el.swManual.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleManualReveal(); }
      });

      // lifelines
      el.life5050.addEventListener('click', use5050);
      el.lifeAsk.addEventListener('click', useAskClass);
      el.lifeSwap.addEventListener('click', useSwap);

      // poll overlay
      el.btnPollClose.addEventListener('click', ()=> setOverlay(el.ovPoll, false));
      el.btnPollOk.addEventListener('click', ()=> setOverlay(el.ovPoll, false));

      // final confirm overlay
      el.btnFinalClose.addEventListener('click', ()=> setOverlay(el.ovFinal, false));
      el.btnFinalNo.addEventListener('click', ()=> setOverlay(el.ovFinal, false));
      el.btnFinalYes.addEventListener('click', ()=>{
        setOverlay(el.ovFinal, false);
        lockAnswer();
      });

      // export / result
      el.btnExport.addEventListener('click', openResult);
      el.btnResultClose.addEventListener('click', ()=> setOverlay(el.ovResult, false));
      el.btnPlayAgain.addEventListener('click', ()=>{
        setOverlay(el.ovResult, false);
        hardReset(true);
        toast('S·∫µn s√†ng ch∆°i l·∫°i');
      });
      el.btnRender.addEventListener('click', ()=>{
        renderResultCanvas();
        toast('ƒê√£ render ·∫£nh');
      });

      // keyboard shortcuts (lightweight)
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape'){
          // close overlays if open
          [el.ovTeacher, el.ovPoll, el.ovFinal, el.ovResult].forEach(ov=>{
            if (ov.classList.contains('show')) ov.classList.remove('show');
          });
        }
        // student hotkeys: A/B/C/D to select
        if (state.mode === 'student' && state.running && !state.paused && !state.locked && !state.revealed){
          const k = e.key.toLowerCase();
          const map = { a:0, b:1, c:2, d:3 };
          if (k in map){
            const idx = map[k];
            if (!state.fiftyEliminated.has(idx)) onSelectAnswer(idx);
          }
        }
      }, { passive:true });
    }

    // =========================
    // Boot
    // =========================
    function boot(){
      initBrand();
      buildSetOptions();

      loadSet(state.setId);

      state.total = clamp(CONFIG.settings.totalQuestions, 10, 15);
      state.timePerQ = clamp(CONFIG.settings.timePerQuestionSec, 10, 300);
      el.inpTime.value = String(state.timePerQ);

      buildLadder();
      hardReset(true);

      bindEvents();
      renderAll();
    }

    boot();
  </script>
</body>
</html>
