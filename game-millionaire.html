<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Ai L√† Tri·ªáu Ph√∫ (n8n) ‚Äì Offline Classroom</title>
  <style>
    :root{
      --bg0:#050814;
      --bg1:#071a35;
      --neon:#2f7dff;
      --neon2:#4aa3ff;
      --gold:#ffb84a;
      --panel:#060b18;
      --fg:#eaf1ff;
      --muted:rgba(234,241,255,.72);
      --muted2:rgba(234,241,255,.52);
      --good:#3be28f;
      --bad:#ff4d6d;

      --line:rgba(255,255,255,.12);
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --shadow2: 0 10px 28px rgba(0,0,0,.45);

      --space-1:6px; --space-2:10px; --space-3:14px; --space-4:18px; --space-5:24px;
      --radius:16px; --radius2:22px;
      --ring: 0 0 0 3px rgba(74,163,255,.28);

      --stage-bg: none;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--fg);
      background: radial-gradient(1100px 800px at 30% 10%, rgba(74,163,255,.16), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(47,125,255,.14), transparent 60%),
                  radial-gradient(900px 700px at 60% 100%, rgba(255,184,74,.08), transparent 65%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    .bgfx{
      position:fixed; inset:-60px;
      pointer-events:none;
      opacity:.38;
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 1px, transparent 1px 48px),
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0 1px, transparent 1px 62px);
      mask-image: radial-gradient(closest-side at 40% 20%, rgba(0,0,0,.85), rgba(0,0,0,.25) 62%, rgba(0,0,0,0) 100%);
      animation: drift 14s linear infinite;
      transform: translate3d(0,0,0);
    }
    @keyframes drift { from{transform:translate3d(0,0,0)} to{transform:translate3d(-70px,40px,0)} }
    @media (prefers-reduced-motion: reduce){
      .bgfx{animation:none}
      .anim{transition:none!important; animation:none!important}
    }

    .app{height:100%; display:flex; flex-direction:column;}

    header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 10px 14px;
      background: linear-gradient(180deg, rgba(0,0,0,.62), rgba(0,0,0,.18));
      border-bottom: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:260px;}
    .logo{
      width:36px; height:36px; border-radius:14px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), rgba(255,255,255,.04) 55%),
                  linear-gradient(180deg, rgba(74,163,255,.22), rgba(47,125,255,.10));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .brand h1{margin:0; font-size:14px; line-height:1.1; letter-spacing:.2px;}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted);}

    .hud{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 6px 18px rgba(0,0,0,.22);
      user-select:none;
      font-size:13px;
      white-space:nowrap;
    }
    .pill .k{color:var(--muted2); font-size:12px}
    .pill strong{font-weight:800; font-variant-numeric: tabular-nums}
    .dot{
      width:8px;height:8px;border-radius:99px;background:var(--neon2);
      box-shadow: 0 0 0 3px rgba(74,163,255,.18);
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--fg);
      padding: 9px 11px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.09)}
    .btn:active{transform: translateY(1px)}
    .btn:focus-visible{outline:none; box-shadow: var(--ring)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(74,163,255,.24), rgba(47,125,255,.14));
      border-color: rgba(74,163,255,.26);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,77,109,.22), rgba(255,77,109,.10));
      border-color: rgba(255,77,109,.22);
    }
    .btn.ghost{background: transparent}
    .btn:disabled{opacity:.5; cursor:not-allowed; transform:none}

    main{
      flex:1; min-height:0;
      display:grid;
      grid-template-columns: 1fr 280px;
      gap: 12px;
      padding: 12px 12px 14px;
    }

    .stage{
      position:relative;
      border-radius: 22px;
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.12);
      background-image:
        var(--stage-bg),
        radial-gradient(1100px 600px at 50% 50%, rgba(47,125,255,.22), transparent 65%),
        radial-gradient(800px 520px at 50% 78%, rgba(74,163,255,.12), transparent 70%),
        linear-gradient(180deg, rgba(4,8,18,.92), rgba(5,10,22,.92));
      background-size: cover, cover, cover, cover;
      background-position: center, center, center, center;
    }

    .beam{
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(closest-side at 18% 18%, rgba(74,163,255,.20), transparent 65%),
        radial-gradient(closest-side at 82% 18%, rgba(74,163,255,.18), transparent 65%),
        linear-gradient(90deg, transparent 0 20%, rgba(74,163,255,.06) 35%, transparent 48%, rgba(74,163,255,.05) 63%, transparent 80% 100%);
      mix-blend-mode: screen;
      opacity:.85;
      filter: blur(.2px);
    }

    .qBarWrap{
      position:absolute;
      top: 70px;
      left: 12px;
      right: 12px;
      display:flex;
      justify-content:center;
      z-index:10;
      pointer-events:none;
    }
    .qBar{
      width: min(980px, calc(100% - 24px));
      min-height: 86px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px 56px;
      color: rgba(234,241,255,.96);
      font-weight:900;
      font-size: 20px;
      letter-spacing:.2px;
      text-align:center;

      background: linear-gradient(180deg, rgba(6,10,18,.82), rgba(4,8,18,.62));
      border: 3px solid rgba(255,184,74,.85);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      clip-path: polygon(5% 0, 95% 0, 100% 50%, 95% 100%, 5% 100%, 0 50%);
      position:relative;
    }
    .qBar::before, .qBar::after{
      content:"";
      position:absolute;
      top:50%;
      width:12px;height:12px;
      transform: translateY(-50%) rotate(45deg);
      background: rgba(234,241,255,.95);
      opacity:.9;
    }
    .qBar::before{left: 18px}
    .qBar::after{right: 18px}
    .qBar small{
      display:block;
      font-weight:800;
      color: rgba(234,241,255,.72);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .qBarText{line-height:1.15}

    .answerArea{
      position:absolute;
      left: 18px;
      right: 18px;
      bottom: 92px;
      z-index:12;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 16px;
      padding: 0 6px;
      align-items:stretch;
    }

    .ansBtn{
      position:relative;
      height: 66px;
      padding: 12px 18px 12px 56px;
      border-radius: 18px;
      cursor:pointer;
      user-select:none;
      text-align:left;

      background: linear-gradient(180deg, rgba(4,10,26,.86), rgba(6,12,30,.72));
      border: 3px solid rgba(255,184,74,.72);
      box-shadow: 0 16px 45px rgba(0,0,0,.48);
      transition: transform .12s ease, filter .12s ease, border-color .12s ease, background .12s ease;
      outline:none;
    }
    .ansBtn:hover{filter: brightness(1.05)}
    .ansBtn:active{transform: translateY(1px)}
    .ansBtn:focus-visible{box-shadow: var(--ring), 0 16px 45px rgba(0,0,0,.48)}
    .ansBtn[aria-disabled="true"]{opacity:.44; cursor:not-allowed; transform:none}
    .ansBtn .diamond{
      position:absolute;
      left: 16px;
      top: 50%;
      width: 12px;
      height: 12px;
      transform: translateY(-50%) rotate(45deg);
      background: rgba(234,241,255,.95);
      opacity:.92;
      box-shadow: 0 0 0 3px rgba(255,184,74,.18);
    }
    .ansBtn .key{
      position:absolute;
      left: 36px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      text-align:center;
      font-weight:1000;
      color: rgba(234,241,255,.92);
      letter-spacing:.3px;
    }
    .ansBtn .txt{
      font-size: 16px;
      font-weight:850;
      color: rgba(234,241,255,.92);
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .ansBtn .tag{
      position:absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-weight:1000;
      font-size: 14px;
      opacity:0;
      transition: opacity .18s ease;
    }

    .ansBtn.selected{
      border-color: rgba(74,163,255,.85);
      background: linear-gradient(180deg, rgba(47,125,255,.30), rgba(6,12,30,.76));
    }
    .ansBtn.locked{
      border-color: rgba(255,209,102,.95);
      background: linear-gradient(180deg, rgba(255,184,74,.26), rgba(6,12,30,.74));
      animation: pulseLock 1.2s ease-in-out infinite;
    }
    @keyframes pulseLock{0%,100%{filter:brightness(1)}50%{filter:brightness(1.12)}}
    .ansBtn.correct{
      border-color: rgba(59,226,143,.95);
      background: linear-gradient(180deg, rgba(59,226,143,.22), rgba(6,12,30,.74));
    }
    .ansBtn.wrong{
      border-color: rgba(255,77,109,.95);
      background: linear-gradient(180deg, rgba(255,77,109,.22), rgba(6,12,30,.74));
      animation: shake .22s ease-in-out 2;
    }
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-4px)}
      50%{transform:translateX(4px)}
      75%{transform:translateX(-3px)}
      100%{transform:translateX(0)}
    }
    .ansBtn.correct .tag, .ansBtn.wrong .tag{opacity:1}
    .ansBtn.correct .tag{color: rgba(59,226,143,.98)}
    .ansBtn.wrong .tag{color: rgba(255,77,109,.98)}

    .lifeBar{
      position:absolute;
      left: 18px;
      right: 18px;
      bottom: 18px;
      z-index:12;
      display:flex;
      justify-content:center;
      gap: 34px;
      align-items:center;
      pointer-events:auto;
    }
    .lifeBtn{
      width: 112px;
      height: 42px;
      border-radius: 999px;
      border: 2px solid rgba(74,163,255,.55);
      background: rgba(0,0,0,.32);
      color: rgba(234,241,255,.92);
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease, border-color .12s ease;
      user-select:none;
    }
    .lifeBtn:hover{filter:brightness(1.08)}
    .lifeBtn:active{transform: translateY(1px)}
    .lifeBtn:focus-visible{outline:none; box-shadow: var(--ring), 0 14px 40px rgba(0,0,0,.45)}
    .lifeBtn.used{opacity:.45; cursor:not-allowed}
    .lifeIcon{width: 18px; height: 18px; display:inline-block; opacity:.95}
    .lifeLabel{font-size:14px}

    .statusLine{
      position:absolute;
      left: 18px;
      right: 18px;
      bottom: 236px;
      z-index:12;
      padding: 0 6px;
      display:flex;
      justify-content:flex-start;
      gap:12px;
      align-items:center;
      color: var(--muted);
      font-weight:900;
      pointer-events:none;
      min-height: 20px;
    }
    .statusLine .ok{color: rgba(59,226,143,.98)}
    .statusLine .no{color: rgba(255,77,109,.98)}
    .statusLine .warn{color: rgba(255,209,102,.98)}

    .hintPop{
      position:absolute;
      left: 18px;
      right: 18px;
      bottom: 268px;
      z-index:12;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.16);
      background: rgba(0,0,0,.32);
      color: rgba(234,241,255,.86);
      font-weight:850;
      display:none;
      pointer-events:none;
      box-shadow: 0 14px 38px rgba(0,0,0,.45);
    }
    .hintPop.show{display:block}
    .explainPop{
      position:absolute;
      left: 18px;
      right: 18px;
      bottom: 316px;
      z-index:12;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(59,226,143,.18);
      background: rgba(59,226,143,.10);
      color: rgba(234,241,255,.90);
      font-weight:850;
      display:none;
      pointer-events:none;
      box-shadow: 0 14px 38px rgba(0,0,0,.45);
    }
    .explainPop.bad{
      border-color: rgba(255,77,109,.18);
      background: rgba(255,77,109,.10);
    }

    .propArch{
      position:absolute;
      left: 50%;
      top: 150px;
      transform: translateX(-50%);
      width: 56%;
      height: 42%;
      border-radius: 60px;
      border-left: 18px solid rgba(255,184,74,.55);
      border-right: 18px solid rgba(255,184,74,.55);
      opacity:.75;
      filter: drop-shadow(0 20px 55px rgba(0,0,0,.55));
      pointer-events:none;
      mask-image: radial-gradient(closest-side at 50% 50%, rgba(0,0,0,.95), rgba(0,0,0,.35) 70%, rgba(0,0,0,0) 100%);
    }
    .propGlow{
      position:absolute;
      left:50%;
      top: 52%;
      transform: translate(-50%,-50%);
      width: 220px; height: 220px;
      background: radial-gradient(circle at 50% 50%, rgba(74,163,255,.40), rgba(74,163,255,.08) 45%, rgba(0,0,0,0) 70%);
      opacity:.85;
      pointer-events:none;
    }
    .moon{
      position:absolute;
      right: 12px;
      bottom: 12px;
      width: 120px;
      height: 120px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.24), transparent 48%),
        radial-gradient(circle at 60% 55%, rgba(255,255,255,.14), transparent 58%),
        radial-gradient(circle at 50% 50%, rgba(74,163,255,.35), rgba(47,125,255,.12) 55%, rgba(0,0,0,.10) 100%);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 20px 55px rgba(0,0,0,.55);
      pointer-events:none;
      opacity:.9;
    }

    /* Ladder + controls */
    .ladder{
      position:relative;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      background: linear-gradient(180deg, rgba(0,0,0,.42), rgba(0,0,0,.18));
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .ladderHd{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex: 0 0 auto;
    }
    .ladderHd .title{
      font-weight:1000; font-size:12px; letter-spacing:.8px;
      color: rgba(234,241,255,.78);
      text-transform: uppercase;
    }
    .ladderHd .mini{
      font-size:12px;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }
    .ladderList{
      list-style:none;
      margin:0;
      padding: 10px 10px 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      overflow:auto;
      scrollbar-width: thin;
      flex: 1 1 auto;
      min-height: 0;
    }
    .step{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.28);
      border: 2px solid rgba(255,184,74,.70);
      box-shadow: 0 10px 28px rgba(0,0,0,.38);
      font-weight:1000;
      font-variant-numeric: tabular-nums;
    }
    .step .lvl{width: 34px; text-align:left; color: rgba(234,241,255,.92); opacity:.85;}
    .step .money{flex:1; text-align:right; color: rgba(255,230,170,.95); letter-spacing:.2px;}
    .step.dim{opacity:.66; border-color: rgba(255,184,74,.40);}
    .step.current{
      background: linear-gradient(180deg, rgba(255,184,74,.22), rgba(0,0,0,.24));
      border-color: rgba(255,209,102,.98);
      box-shadow: 0 0 0 3px rgba(255,184,74,.18), 0 10px 28px rgba(0,0,0,.40);
    }
    .step.safe{border-color: rgba(74,163,255,.55);}

    .ladderControls{
      padding: 10px 10px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:grid;
      gap: 10px;
      flex: 0 0 auto;
    }
    .ctlRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .ctlBtn{
      width:100%;
      justify-content:flex-start;
      padding: 11px 12px;
      border-radius: 16px;
      box-shadow: 0 12px 36px rgba(0,0,0,.35);
    }
    .ctlBtn span[aria-hidden="true"]{width: 22px; text-align:center}

    /* Overlays / Modals */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
      padding: 18px;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
    }
    .overlay.show{display:flex}
    .modal{
      width:min(980px, 100%);
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
    }
    .modalHd{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      gap:10px;
    }
    .modalHd h2{margin:0; font-size:14px; letter-spacing:.2px; font-weight:1000}
    .modalBd{
      padding: 16px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    .modalBd.single{grid-template-columns: 1fr}
    .modalFt{
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }
    label{font-size:12px; color: var(--muted); font-weight:900}
    input, select{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      color: var(--fg);
      padding: 10px 11px;
      font-weight:850;
      font-size: 13px;
      outline:none;
    }
    input:focus, select:focus{box-shadow: var(--ring); border-color: rgba(74,163,255,.25)}

    /* Teacher floating panel */
    .teacherPanel{
      position:fixed;
      left: 12px;
      bottom: 12px;
      width: min(420px, calc(100vw - 24px));
      z-index:70;
      display:none;
    }
    .teacherPanel.show{display:block}
    .tCard{
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(0,0,0,.42), rgba(0,0,0,.22));
      box-shadow: var(--shadow2);
    }
    .tHd{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,184,74,.28);
      background: rgba(255,184,74,.10);
      font-weight:1000;
      font-size:12px;
      color: rgba(234,241,255,.92);
      white-space:nowrap;
    }
    .badge i{
      width:8px;height:8px;border-radius:99px;background: rgba(255,184,74,.92);
      display:inline-block;
      box-shadow: 0 0 0 3px rgba(255,184,74,.14);
    }
    .tBd{padding: 12px 12px; display:grid; gap:10px}
    .miniGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .toggle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      user-select:none;
    }
    .toggle span{font-size:12px; color: var(--muted); font-weight:900}
    .switch{
      width: 44px; height: 26px;
      border-radius: 99px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      position:relative;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease;
      flex:0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      top:50%;
      left: 3px;
      width: 20px;
      height: 20px;
      border-radius: 99px;
      transform: translateY(-50%);
      background: rgba(234,241,255,.92);
      transition: left .14s ease;
    }
    .switch.on{
      background: rgba(74,163,255,.22);
      border-color: rgba(74,163,255,.26);
    }
    .switch.on::after{left: 21px}

    /* Poll bars */
    .poll{display:grid; gap:10px}
    .barRow{display:grid; grid-template-columns: 28px 1fr 54px; gap:10px; align-items:center}
    .barKey{
      width:28px;height:28px;border-radius:12px;
      display:grid;place-items:center;
      border: 2px solid rgba(255,184,74,.55);
      background: rgba(0,0,0,.22);
      font-weight:1000;
    }
    .bar{
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, rgba(74,163,255,.42), rgba(255,184,74,.18));
      transition: width .55s ease;
    }
    .pct{font-variant-numeric: tabular-nums; color: var(--muted); font-weight:1000; text-align:right}

    .toast{
      position:fixed;
      left:50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.65);
      box-shadow: 0 12px 35px rgba(0,0,0,.45);
      color: rgba(234,241,255,.92);
      font-weight:900;
      font-size: 13px;
      display:none;
      z-index:90;
      max-width: calc(100vw - 24px);
      opacity:1;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{display:block}

    details.quick{
      position:fixed;
      right: 12px;
      bottom: 12px;
      z-index:60;
      width: min(520px, calc(100vw - 24px));
    }
    details.quick summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    details.quick .qCard{
      margin-top: 10px;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      box-shadow: var(--shadow2);
    }
    details.quick .qHd{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    details.quick .qBd{padding: 12px 12px 14px; color: rgba(234,241,255,.86); font-weight:850; line-height:1.45; font-size:13px}
    code{color: rgba(255,230,170,.95)}

    @media (max-width: 980px){
      body{overflow:auto}
      main{grid-template-columns: 1fr; padding-bottom: 90px}
      .ladder{height: auto}
      .moon{display:none}
    }

    @media (max-width: 560px){
      .answerArea{grid-template-columns: 1fr; bottom: 140px}
      .lifeBar{bottom: 86px; gap: 14px}
      .lifeBtn{width: 104px}
      .qBar{font-size: 17px; padding: 12px 44px}
      .ctlRow{grid-template-columns: 1fr}
    }

    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
  </style>
</head>

<body>
  <div class="bgfx" aria-hidden="true"></div>

  <div class="app" id="app">
    <header>
      <div class="brand">
        <div class="logo" id="logoBox" aria-hidden="true"></div>
        <div>
          <h1 id="gameTitle">Ai L√† Tri·ªáu Ph√∫ ‚Äì n8n</h1>
          <p id="gameTagline">Student Mode ‚Ä¢ Offline</p>
        </div>
      </div>

      <div class="hud" aria-label="HUD">
        <div class="pill" title="Th·ªùi gian c√≤n l·∫°i">
          <span class="dot" aria-hidden="true"></span>
          <span class="k">Timer</span><strong id="timerText">00:30</strong>
        </div>
        <div class="pill" title="ƒêi·ªÉm">
          <span class="k">Score</span><strong id="scoreText">0</strong>
        </div>
        <div class="pill" title="Ti·∫øn ƒë·ªô">
          <span class="k">Progress</span><strong id="progressText">0/12</strong>
        </div>

        <button class="btn ghost" id="btnTeacher" type="button" title="Teacher Mode">
          <span aria-hidden="true">üõ†Ô∏è</span> Teacher
        </button>
        <button class="btn danger" id="btnReset" type="button" title="Reset">
          <span aria-hidden="true">‚Üª</span> Reset
        </button>
      </div>
    </header>

    <main>
      <section class="stage" aria-label="S√¢n kh·∫•u Ai L√† Tri·ªáu Ph√∫">
        <div class="beam" aria-hidden="true"></div>
        <div class="propArch" aria-hidden="true"></div>
        <div class="propGlow" aria-hidden="true"></div>
        <div class="moon" aria-hidden="true"></div>

        <div class="qBarWrap">
          <div class="qBar anim" role="status" aria-live="polite">
            <div class="qBarText">
              <small id="qMetaText">C√¢u h·ªèi 1</small>
              <span id="qText">ƒêang chu·∫©n b·ªã‚Ä¶</span>
            </div>
          </div>
        </div>

        <div class="hintPop" id="hintPop"><strong>Hint:</strong> <span id="hintText"></span></div>
        <div class="explainPop" id="explainPop"><strong>Gi·∫£i th√≠ch:</strong> <span id="explainText"></span></div>
        <div class="statusLine" id="statusLine" aria-live="polite"></div>

        <div class="answerArea" role="group" aria-label="C√°c ƒë√°p √°n">
          <button class="ansBtn anim" type="button" data-idx="0" aria-disabled="true">
            <span class="diamond" aria-hidden="true"></span>
            <span class="key" aria-hidden="true">A</span>
            <span class="txt" id="a0">‚Äî</span>
            <span class="tag" aria-hidden="true">ƒê√öNG</span>
          </button>

          <button class="ansBtn anim" type="button" data-idx="1" aria-disabled="true">
            <span class="diamond" aria-hidden="true"></span>
            <span class="key" aria-hidden="true">B</span>
            <span class="txt" id="a1">‚Äî</span>
            <span class="tag" aria-hidden="true">ƒê√öNG</span>
          </button>

          <button class="ansBtn anim" type="button" data-idx="2" aria-disabled="true">
            <span class="diamond" aria-hidden="true"></span>
            <span class="key" aria-hidden="true">C</span>
            <span class="txt" id="a2">‚Äî</span>
            <span class="tag" aria-hidden="true">ƒê√öNG</span>
          </button>

          <button class="ansBtn anim" type="button" data-idx="3" aria-disabled="true">
            <span class="diamond" aria-hidden="true"></span>
            <span class="key" aria-hidden="true">D</span>
            <span class="txt" id="a3">‚Äî</span>
            <span class="tag" aria-hidden="true">ƒê√öNG</span>
          </button>
        </div>

        <div class="lifeBar" aria-label="Tr·ª£ gi√∫p">
          <button class="lifeBtn anim" id="life5050" type="button" title="50:50">
            <span class="lifeIcon" aria-hidden="true">‚ûó</span>
            <span class="lifeLabel">50/50</span>
          </button>
          <button class="lifeBtn anim" id="lifeAsk" type="button" title="H·ªèi l·ªõp">
            <span class="lifeIcon" aria-hidden="true">üë•</span>
            <span class="lifeLabel">H·ªèi l·ªõp</span>
          </button>
          <button class="lifeBtn anim" id="lifeSwap" type="button" title="ƒê·ªïi c√¢u">
            <span class="lifeIcon" aria-hidden="true">üîÑ</span>
            <span class="lifeLabel">ƒê·ªïi c√¢u</span>
          </button>
        </div>
      </section>

      <aside class="ladder" aria-label="Thang th∆∞·ªüng">
        <div class="ladderHd">
          <div class="title">Prize Ladder</div>
          <div class="mini" id="ladderMini">‚Äî</div>
        </div>
        <ol class="ladderList" id="ladderList" aria-label="Danh s√°ch th∆∞·ªüng"></ol>

        <!-- Student Controls moved here (NOT overlapping answers) -->
        <div class="ladderControls" aria-label="ƒêi·ªÅu khi·ªÉn tr√≤ ch∆°i">
          <div class="ctlRow">
            <button class="btn primary ctlBtn" id="btnStart" type="button" title="B·∫Øt ƒë·∫ßu/ti·∫øp t·ª•c">
              <span aria-hidden="true">‚ñ∂</span> Start
            </button>
            <button class="btn ctlBtn" id="btnHint" type="button" title="Hi·ªán/·∫©n hint">
              <span aria-hidden="true">üí°</span> Hint
            </button>
          </div>

          <button class="btn ctlBtn" id="btnLock" type="button" title="Ch·ªët ƒë√°p √°n">
            <span aria-hidden="true">üîí</span> Final Answer
          </button>

          <div class="ctlRow">
            <button class="btn ctlBtn" id="btnRevealStudent" type="button" title="Reveal (Student)">
              <span aria-hidden="true">üëÅÔ∏è</span> Reveal
            </button>
            <button class="btn primary ctlBtn" id="btnNextStudent" type="button" title="Next (Student)">
              <span aria-hidden="true">‚è≠</span> Next
            </button>
          </div>

          <button class="btn primary ctlBtn" id="btnExport" type="button" title="Xu·∫•t ·∫£nh k·∫øt qu·∫£">
            <span aria-hidden="true">üñºÔ∏è</span> Export Result
          </button>
        </div>
      </aside>
    </main>

    <div class="teacherPanel" id="teacherPanel" aria-label="Teacher Panel">
      <div class="tCard">
        <div class="tHd">
          <span class="badge"><i></i> Teacher Mode</span>
          <button class="btn ghost" id="btnTeacherClose" type="button"><span aria-hidden="true">‚úï</span> Close</button>
        </div>
        <div class="tBd">
          <div class="miniGrid">
            <div class="field">
              <label for="selSet">B·ªô c√¢u h·ªèi</label>
              <select id="selSet"></select>
            </div>
            <div class="field">
              <label for="inpTime">Timer m·ªói c√¢u (gi√¢y)</label>
              <input id="inpTime" type="number" min="10" max="300" step="5" />
            </div>
          </div>

          <div class="toggle" title="B·∫≠t ƒë·ªÉ gi√°o vi√™n ch·ªß ƒë·ªông Reveal">
            <span>Manual Reveal</span>
            <div class="switch on" id="swManual" role="switch" tabindex="0" aria-checked="true"></div>
          </div>

          <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="tBtnStart" type="button"><span aria-hidden="true">‚ñ∂</span> Start/Resume</button>
            <button class="btn" id="tBtnPause" type="button"><span aria-hidden="true">‚è∏</span> Pause</button>
            <button class="btn" id="tBtnReveal" type="button"><span aria-hidden="true">üëÅÔ∏è</span> Reveal</button>
            <button class="btn primary" id="tBtnNext" type="button"><span aria-hidden="true">‚è≠</span> Next</button>
            <button class="btn danger" id="tBtnReset" type="button"><span aria-hidden="true">‚Üª</span> Reset</button>
          </div>

          <div style="color:var(--muted2); font-weight:900; font-size:12px; line-height:1.35">
            M·∫≠t kh·∫©u: <strong>n8n</strong>. G·ª£i √Ω: b·∫≠t <strong>Manual Reveal</strong> ƒë·ªÉ ki·ªÉm so√°t nh·ªãp l·ªõp.
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="ovTeacher" role="dialog" aria-modal="true" aria-labelledby="teacherTitle">
      <div class="modal">
        <div class="modalHd">
          <h2 id="teacherTitle">Teacher Mode</h2>
          <button class="btn ghost" id="btnTeacherCancel" type="button"><span aria-hidden="true">‚úï</span> ƒê√≥ng</button>
        </div>
        <div class="modalBd">
          <div class="field">
            <label for="inpPass">Nh·∫≠p m·∫≠t kh·∫©u</label>
            <input id="inpPass" type="password" placeholder="Password" autocomplete="off" />
            <div style="color:var(--muted2); font-weight:900; font-size:12px; line-height:1.35">
              Teacher Mode: ch·ªçn b·ªô ƒë·ªÅ, ch·ªânh timer, Start/Pause/Reveal/Next.
            </div>
          </div>
          <div class="field">
            <label>Tr·∫°ng th√°i</label>
            <div id="passStatus" style="font-weight:1000; color:var(--muted)">Ch∆∞a x√°c th·ª±c</div>
            <div style="color:var(--muted2); font-weight:900; font-size:12px; line-height:1.35">
              Tip: Teacher Mode gi√∫p ‚Äúch·ªët‚Äù tranh lu·∫≠n v√† tƒÉng tempo bu·ªïi h·ªçc.
            </div>
          </div>
        </div>
        <div class="modalFt">
          <button class="btn primary" id="btnTeacherOk" type="button"><span aria-hidden="true">üîì</span> M·ªü</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="ovPoll" role="dialog" aria-modal="true" aria-labelledby="pollTitle">
      <div class="modal">
        <div class="modalHd">
          <h2 id="pollTitle">H·ªèi l·ªõp ‚Äì K·∫øt qu·∫£ b√¨nh ch·ªçn</h2>
          <button class="btn ghost" id="btnPollClose" type="button"><span aria-hidden="true">‚úï</span> ƒê√≥ng</button>
        </div>
        <div class="modalBd single">
          <div class="field">
            <div class="poll" id="pollBody"></div>
            <div style="color:var(--muted2); font-weight:900; font-size:12px; line-height:1.35">
              ƒê√¢y l√† m√¥ ph·ªèng ƒë·ªÉ demo. Tr√™n l·ªõp: cho m·ªçi ng∆∞·ªùi gi∆° tay, r·ªìi so v·ªõi ‚Äúpoll‚Äù.
            </div>
          </div>
        </div>
        <div class="modalFt">
          <button class="btn primary" id="btnPollOk" type="button"><span aria-hidden="true">‚úÖ</span> OK</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="ovFinal" role="dialog" aria-modal="true" aria-labelledby="finalTitle">
      <div class="modal">
        <div class="modalHd">
          <h2 id="finalTitle">Ch·ªët ƒë√°p √°n?</h2>
          <button class="btn ghost" id="btnFinalClose" type="button"><span aria-hidden="true">‚úï</span> ƒê√≥ng</button>
        </div>
        <div class="modalBd single">
          <div class="field">
            <div style="color:var(--muted2); font-weight:900; font-size:12px">B·∫°n ch·ªçn</div>
            <div id="finalChoiceText" style="font-weight:1000; font-size:16px; line-height:1.25">‚Äî</div>
            <div style="color:var(--muted); font-weight:900; font-size:12px; line-height:1.35; margin-top:8px">
              Khi ch·ªët, kh√¥ng th·ªÉ ƒë·ªïi ƒë√°p √°n. (Teacher Mode c√≥ th·ªÉ Manual Reveal)
            </div>
          </div>
        </div>
        <div class="modalFt">
          <button class="btn" id="btnFinalNo" type="button"><span aria-hidden="true">‚Ü©</span> Ch∆∞a</button>
          <button class="btn primary" id="btnFinalYes" type="button"><span aria-hidden="true">üîí</span> Final Answer</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="ovResult" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
      <div class="modal">
        <div class="modalHd">
          <h2 id="resultTitle">K·∫øt qu·∫£ tr√≤ ch∆°i</h2>
          <button class="btn ghost" id="btnResultClose" type="button"><span aria-hidden="true">‚úï</span> ƒê√≥ng</button>
        </div>
        <div class="modalBd">
          <div class="field">
            <div style="color:var(--muted2); font-weight:1000; font-size:12px">T·ªïng quan</div>
            <div style="display:grid; gap:8px; margin-top:8px">
              <div style="display:flex; justify-content:space-between; gap:10px"><span style="color:var(--muted); font-weight:900">Score</span><strong id="rScore" style="font-weight:1000">0</strong></div>
              <div style="display:flex; justify-content:space-between; gap:10px"><span style="color:var(--muted); font-weight:900">ƒê√∫ng</span><strong id="rCorrect" style="font-weight:1000">0</strong></div>
              <div style="display:flex; justify-content:space-between; gap:10px"><span style="color:var(--muted); font-weight:900">Sai</span><strong id="rWrong" style="font-weight:1000">0</strong></div>
              <div style="display:flex; justify-content:space-between; gap:10px"><span style="color:var(--muted); font-weight:900">Th·ªùi gian</span><strong id="rTime" style="font-weight:1000">00:00</strong></div>
              <div style="display:flex; justify-content:space-between; gap:10px"><span style="color:var(--muted); font-weight:900">B·ªô ƒë·ªÅ</span><strong id="rSet" style="font-weight:1000">‚Äî</strong></div>
            </div>
            <div style="color:var(--muted2); font-weight:900; font-size:12px; line-height:1.35; margin-top:10px">
              Tip: Export PNG ƒë·ªÉ l∆∞u ‚Äúk·∫øt qu·∫£ l·ªõp‚Äù ngay t·∫°i ch·ªó.
            </div>
          </div>

          <div class="field">
            <div style="color:var(--muted2); font-weight:1000; font-size:12px">·∫¢nh k·∫øt qu·∫£ (16:9)</div>
            <canvas id="resultCanvas" width="1200" height="675" style="width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.20)"></canvas>
            <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; margin-top:10px">
              <button class="btn" id="btnRender" type="button"><span aria-hidden="true">üßæ</span> Render</button>
              <a class="btn primary" id="btnDownload" href="#" download="millionaire_result.png" role="button"><span aria-hidden="true">‚¨á</span> Download PNG</a>
            </div>
          </div>
        </div>
        <div class="modalFt">
          <button class="btn danger" id="btnPlayAgain" type="button"><span aria-hidden="true">‚Üª</span> Ch∆°i l·∫°i</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <details class="quick">
      <summary class="btn">
        <span aria-hidden="true">üìå</span> H∆∞·ªõng d·∫´n nhanh
      </summary>
      <div class="qCard">
        <div class="qHd">
          <div style="font-weight:1000">Quick Guide</div>
          <div style="color:var(--muted); font-weight:900; font-size:12px">ƒë·ªïi d·ªØ li·ªáu & c√°ch ch∆°i</div>
        </div>
        <div class="qBd">
          <strong>1) ƒê·ªïi c√¢u h·ªèi:</strong> s·ª≠a bi·∫øn <code>CONFIG.questionSets</code> (m·ªói c√¢u: <code>q/options/answerIndex/hint/explanation</code>), v√† <code>CONFIG.settings.totalQuestions</code> (10‚Äì15).<br/>
          <strong>2) ƒê·ªïi n·ªÅn s√¢n kh·∫•u:</strong> g√°n <code>CONFIG.assets.stageBg</code> = ƒë∆∞·ªùng d·∫´n ·∫£nh (vd: <code>"stage.png"</code>).<br/>
          <strong>3) Ch∆°i tr√™n l·ªõp:</strong> (Auto-start) c·∫£ l·ªõp ch·ªçn A/B/C/D ‚Üí <strong>Final Answer</strong> ‚Üí <strong>Reveal</strong> ‚Üí <strong>Next</strong>.<br/>
          <strong>4) Lifelines:</strong> <em>50/50</em> lo·∫°i 2 ƒë√°p √°n sai; <em>H·ªèi l·ªõp</em> hi·ªán poll; <em>ƒê·ªïi c√¢u</em> d√πng c√¢u d·ª± ph√≤ng.<br/>
          <strong>5) Export:</strong> b·∫•m <strong>Export Result</strong> ‚Üí <strong>Render</strong> ‚Üí <strong>Download PNG</strong>.
        </div>
      </div>
    </details>
  </div>

  <script>
    'use strict';

    // =========================
    // CONFIG (Teacher edit here)
    // =========================
    const CONFIG = {
      links: { facebook:"", linkedin:"", youtube:"" },
      assets: {
        // Optional: set to local file path (offline), e.g. "assets/stage.png"
        stageBg: "",
        logoSvg: `
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 2l8.5 5v10L12 22 3.5 17V7L12 2Z" stroke="rgba(234,241,255,.95)" stroke-width="2" />
            <path d="M8 12h8" stroke="rgba(255,184,74,.95)" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 8v8" stroke="rgba(74,163,255,.95)" stroke-width="2" stroke-linecap="round"/>
          </svg>`
      },
      text: {
        gameTitle: "Ai L√† Tri·ªáu Ph√∫ ‚Äì n8n",
        tagline: "·ª®ng d·ª•ng n8n c∆° b·∫£n",
        brand: "KPIM / COMPA Class",
        teacherPass: "n8n"
      },
      settings: {
        autoStartStudent: true,            // ‚úÖ m·ªü ra t·ª± ch·∫°y ngay ·ªü Student mode
        totalQuestions: 12,                // 10‚Äì15
        timePerQuestionSec: 30,
        safeLevels: [5, 10],
        moneyLadder: [100,200,300,500,1000,2000,4000,8000,16000,25000,50000,100000],
        streakBonusEvery: 3,
        streakBonusPoints: 250
      },
      questionSets: [
        {
          id: "basic",
          name: "C∆° b·∫£n (n8n Fundamentals)",
          questions: [
            { q:"n8n ch·ªß y·∫øu d√πng ƒë·ªÉ l√†m g√¨?", options:["Thi·∫øt k·∫ø UI web","T·ª± ƒë·ªông ho√° workflow","L∆∞u tr·ªØ file nh∆∞ Google Drive","Qu·∫£n l√Ω m·∫≠t kh·∫©u"], answerIndex:1, hint:"Nghƒ© v·ªÅ vi·ªác n·ªëi c√°c b∆∞·ªõc l·∫°i th√†nh chu·ªói.", explanation:"n8n l√† c√¥ng c·ª• automation/workflow ƒë·ªÉ k·∫øt n·ªëi c√°c d·ªãch v·ª• v√† t·ª± ƒë·ªông ho√° quy tr√¨nh." },
            { q:"Trong n8n, ‚ÄúNode‚Äù th∆∞·ªùng ƒë·∫°i di·ªán cho g√¨?", options:["M·ªôt b∆∞·ªõc x·ª≠ l√Ω/k·∫øt n·ªëi","M·ªôt ng∆∞·ªùi d√πng trong h·ªá th·ªëng","M·ªôt file c·∫•u h√¨nh","M·ªôt server v·∫≠t l√Ω"], answerIndex:0, hint:"Workflow ƒë∆∞·ª£c gh√©p t·ª´ nhi·ªÅu kh·ªëi.", explanation:"Node l√† ƒë∆°n v·ªã ch·ª©c nƒÉng ‚Äì 1 b∆∞·ªõc trong workflow (trigger, action, transform...)." },
            { q:"Trigger node d√πng ƒë·ªÉ l√†m g√¨?", options:["K·∫øt th√∫c workflow","B·∫Øt ƒë·∫ßu workflow khi c√≥ s·ª± ki·ªán","Ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã log","TƒÉng t·ªëc ƒë·ªô ch·∫°y"], answerIndex:1, hint:"N·∫øu kh√¥ng c√≥ trigger, workflow ‚Äúch·ªù‚Äù ƒëi·ªÅu g√¨?", explanation:"Trigger l√† ƒëi·ªÉm kh·ªüi ƒë·ªông workflow (Webhook, Schedule, IMAP, ‚Ä¶)." },
            { q:"Webhook trong n8n h·ªØu √≠ch nh·∫•t khi n√†o?", options:["Mu·ªën ch·∫°y theo gi·ªù c·ªë ƒë·ªãnh","Mu·ªën h·ªá th·ªëng kh√°c g·ªçi v√†o ƒë·ªÉ k√≠ch ho·∫°t","Mu·ªën l∆∞u d·ªØ li·ªáu v√†o Excel offline","Mu·ªën t·∫°o bi·ªÉu ƒë·ªì"], answerIndex:1, hint:"H·ªá th·ªëng kh√°c ‚Äúb·∫Øn‚Äù request t·ªõi b·∫°n.", explanation:"Webhook nh·∫≠n HTTP request ƒë·ªÉ k√≠ch ho·∫°t workflow v√† nh·∫≠n payload." },
            { q:"Khi c·∫ßn l·∫∑p qua danh s√°ch items trong n8n, b·∫°n th∆∞·ªùng d√πng g√¨?", options:["Split in Batches","Stop and Error","NoOp","Merge (Pass-through)"], answerIndex:0, hint:"T√™n node g·ª£i √Ω chia nh·ªè theo t·ª´ng batch.", explanation:"Split in Batches gi√∫p x·ª≠ l√Ω tu·∫ßn t·ª±/nh√≥m c√°c items." },
            { q:"Node n√†o hay d√πng ƒë·ªÉ bi·∫øn ƒë·ªïi JSON nhanh (kh√¥ng c·∫ßn code)?", options:["Code","Set","HTTP Request","Webhook"], answerIndex:1, hint:"Map/rename field c·ª±c nhanh.", explanation:"Set node gi√∫p t·∫°o/ƒë·ªïi fields, map d·ªØ li·ªáu, g√°n gi√° tr·ªã nhanh." },
            { q:"‚ÄúExpression‚Äù trong n8n d√πng ƒë·ªÉ l√†m g√¨?", options:["V·∫Ω bi·ªÉu ƒë·ªì","T√≠nh/gh√©p gi√° tr·ªã ƒë·ªông t·ª´ d·ªØ li·ªáu","T·∫£i file l√™n cloud","Ch·∫°y cron h·ªá th·ªëng"], answerIndex:1, hint:"Gi·ªëng c√¥ng th·ª©c tham chi·∫øu node tr∆∞·ªõc.", explanation:"Expression cho ph√©p tham chi·∫øu d·ªØ li·ªáu node tr∆∞·ªõc v√† x·ª≠ l√Ω ƒë·ªông." },
            { q:"Best practice khi g·ªçi API trong n8n l√† g√¨?", options:["Hardcode token v√†o text","Kh√¥ng x·ª≠ l√Ω l·ªói","D√πng credentials/bi·∫øn m√¥i tr∆∞·ªùng cho secrets","G·ª≠i d·ªØ li·ªáu t√πy √Ω kh√¥ng validate"], answerIndex:2, hint:"B·∫£o m·∫≠t lu√¥n l√† ∆∞u ti√™n.", explanation:"N√™n d√πng Credentials/Env vars ƒë·ªÉ qu·∫£n l√Ω secrets, tr√°nh hardcode." },
            { q:"Node sau kh√¥ng ch·∫°y, nguy√™n nh√¢n ph·ªï bi·∫øn nh·∫•t?", options:["Node tr∆∞·ªõc kh√¥ng output items","Thi·∫øu icon","M√†u theme b·ªã l·ªói","n8n kh√¥ng h·ªó tr·ª£ JSON"], answerIndex:0, hint:"D√≤ng ch·∫£y d·ªØ li·ªáu b·ªã ‚Äúƒë·ª©t‚Äù.", explanation:"Nhi·ªÅu node y√™u c·∫ßu input items; node tr∆∞·ªõc kh√¥ng tr·∫£ d·ªØ li·ªáu th√¨ node sau kh√¥ng ch·∫°y." },
            { q:"Ch·∫°y workflow m·ªói 5 ph√∫t, trigger ph√π h·ª£p nh·∫•t?", options:["Schedule Trigger","Webhook Trigger","Manual Trigger","NoOp"], answerIndex:0, hint:"Ch·∫°y theo th·ªùi gian ƒë·ªãnh k·ª≥.", explanation:"Schedule Trigger h·ªó tr·ª£ cron/interval (v√≠ d·ª• m·ªói 5 ph√∫t)." },
            { q:"Workflow l·ªói, mu·ªën b·ªÅn v·ªØng: n√™n l√†m g√¨ (t∆∞ duy c∆° b·∫£n)?", options:["B·ªè log","D√πng nh√°nh b·∫Øt l·ªói (Error/try-catch) theo item","T·∫Øt workflow","X√≥a node l·ªói"], answerIndex:1, hint:"X·ª≠ l√Ω l·ªói nh∆∞ 1 nh√°nh ri√™ng.", explanation:"Thi·∫øt k·∫ø nh√°nh x·ª≠ l√Ω l·ªói gi√∫p h·ªá th·ªëng b·ªÅn: log, retry, ho·∫∑c skip theo ƒëi·ªÅu ki·ªán." },
            { q:"V√¨ sao n√™n ƒë·∫∑t t√™n node r√µ r√†ng?", options:["Ch·∫°y nhanh h∆°n","Debug/b·∫£o tr√¨/handover d·ªÖ","TƒÉng s·ªë node t·ªëi ƒëa","V√¨ b·∫Øt bu·ªôc"], answerIndex:1, hint:"T·ªëi ∆∞u cho ng∆∞·ªùi ƒë·ªçc.", explanation:"T√™n node r√µ r√†ng gi√∫p debug, theo d√µi data lineage v√† b√†n giao nhanh." }
          ],
          backup: [
            { q:"Node ‚ÄúMerge‚Äù th∆∞·ªùng d√πng khi n√†o?", options:["T·∫°o webhook","K·∫øt h·ª£p d·ªØ li·ªáu t·ª´ 2 nh√°nh","G·ª≠i email","TƒÉng t·ªëc CPU"], answerIndex:1, hint:"Gom 2 lu·ªìng v√†o 1.", explanation:"Merge gi√∫p k·∫øt h·ª£p d·ªØ li·ªáu t·ª´ nhi·ªÅu nh√°nh theo ch·∫ø ƒë·ªô merge." },
            { q:"Manual Trigger ph√π h·ª£p nh·∫•t khi n√†o?", options:["Test/POC ch·∫°y tay","Nh·∫≠n request t·ª´ h·ªá th·ªëng kh√°c","Ch·∫°y theo l·ªãch","Ch·∫°y khi c√≥ email m·ªõi"], answerIndex:0, hint:"D√πng khi b·∫°n mu·ªën ch·ªß ƒë·ªông b·∫•m ch·∫°y.", explanation:"Manual Trigger gi√∫p ch·∫°y th·ª≠ nhanh trong qu√° tr√¨nh build/debug." }
          ]
        },
        {
          id: "practice",
          name: "Th·ª±c h√†nh (Workflow th·ª±c t·∫ø)",
          questions: [
            { q:"Nh·∫≠n form website ‚Üí ƒë·∫©y Google Sheets: c·∫ßn t·ªëi thi·ªÉu nh√≥m node n√†o?", options:["Trigger + Transform + Destination","Ch·ªâ 1 node b·∫•t k·ª≥","Ch·ªâ Merge","Ch·ªâ NoOp"], answerIndex:0, hint:"B·∫Øt ƒë·∫ßu ‚Üí x·ª≠ l√Ω ‚Üí ghi d·ªØ li·ªáu.", explanation:"T·ªëi thi·ªÉu: Trigger (Webhook/Form), Transform (Set/Code), Destination (Sheets)." },
            { q:"GET vs POST kh√°c nhau c∆° b·∫£n ·ªü ƒë√¢u?", options:["GET g·ª≠i body l·ªõn h∆°n","POST th∆∞·ªùng g·ª≠i d·ªØ li·ªáu trong body; GET l·∫•y d·ªØ li·ªáu b·∫±ng query","GET b·∫£o m·∫≠t h∆°n m·∫∑c ƒë·ªãnh","POST lu√¥n nhanh h∆°n"], answerIndex:1, hint:"C√°ch truy·ªÅn d·ªØ li·ªáu l√† ƒëi·ªÉm kh√°c ch√≠nh.", explanation:"GET ch·ªß y·∫øu l·∫•y d·ªØ li·ªáu; POST th∆∞·ªùng t·∫°o/ghi v√† g·ª≠i payload trong body." },
            { q:"Mu·ªën gi·∫£m l·ªói mapping d·ªØ li·ªáu gi·ªØa node: ∆∞u ti√™n g√¨?", options:["Copy/paste t√πy √Ω","Expression ƒë√∫ng field + x·ª≠ l√Ω null","Hardcode gi√° tr·ªã","T·∫Øt validation"], answerIndex:1, hint:"D·ªØ li·ªáu c√≥ th·ªÉ thi·∫øu/kh√°c schema.", explanation:"Tham chi·∫øu ƒë√∫ng field v√† x·ª≠ l√Ω null gi√∫p workflow b·ªÅn h∆°n." },
            { q:"API gi·ªõi h·∫°n 60 req/ph√∫t, x·ª≠ l√Ω ƒë√∫ng trong n8n?", options:["G·ªçi d·ªìn 200 request","Batch + delay/rate limit","T·∫Øt log ƒë·ªÉ nhanh","Ch·∫°y l·∫°i li√™n t·ª•c"], answerIndex:1, hint:"Ki·ªÉm so√°t t·ªëc ƒë·ªô g·ªçi.", explanation:"D√πng batch + delay ƒë·ªÉ tu√¢n th·ªß rate limit, tr√°nh b·ªã block." },
            { q:"L∆∞u log m·ªói l·∫ßn ch·∫°y, c√°ch ƒë∆°n gi·∫£n?", options:["Kh√¥ng l∆∞u g√¨","Ghi DB/Sheet theo timestamp + status","Ch·ª•p m√†n h√¨nh","ƒê·ªïi m√†u node"], answerIndex:1, hint:"Log gi√∫p audit & debug.", explanation:"Ghi log ra n∆°i l∆∞u tr·ªØ gi√∫p truy v·∫øt v·∫•n ƒë·ªÅ v√† ƒëo t·∫ßn su·∫•t l·ªói." },
            { q:"Khi n√†o n√™n d√πng Code node thay v√¨ Set node?", options:["Rename 1 field","Logic ph·ª©c t·∫°p/loop/ƒëi·ªÅu ki·ªán nhi·ªÅu","ƒê·ªïi theme","Ch·∫°y cron"], answerIndex:1, hint:"Set m·∫°nh nh∆∞ng c√≥ gi·ªõi h·∫°n.", explanation:"Code node ph√π h·ª£p khi c·∫ßn x·ª≠ l√Ω ph·ª©c t·∫°p." },
            { q:"TƒÉng ƒë·ªô tin c·∫≠y khi g·ªçi API hay l·ªói: n√™n l√†m g√¨?", options:["Kh√¥ng d√πng API","Retry/backoff + b·∫Øt l·ªói","T·∫Øt internet","Ch·∫°y tay"], answerIndex:1, hint:"Th·∫•t b·∫°i l√† chuy·ªán b√¨nh th∆∞·ªùng.", explanation:"Retry/backoff + b·∫Øt l·ªói gi√∫p workflow ch·ªëng ch·∫≠p ch·ªùn m·∫°ng/d·ªãch v·ª•." },
            { q:"G·ª≠i email khi status=FAILED, c√°ch ti·∫øp c·∫≠n c∆° b·∫£n?", options:["Lu√¥n g·ª≠i","IF node r·∫Ω nh√°nh ‚Üí Email node","Ch·ªâ Merge","Ch·ªâ Webhook"], answerIndex:1, hint:"ƒêi·ªÅu ki·ªán ‚Üí r·∫Ω nh√°nh.", explanation:"IF node gi√∫p t√°ch lu·ªìng theo ƒëi·ªÅu ki·ªán, ch·ªâ g·ª≠i khi th·ªèa." },
            { q:"Workflow ph·ª©c t·∫°p: v√¨ sao n√™n t√°ch module/sub-workflow?", options:["TƒÉng s·ªë node","T√°i s·ª≠ d·ª•ng & b·∫£o tr√¨ d·ªÖ","TƒÉng chi ph√≠","UI ƒë·∫πp"], answerIndex:1, hint:"Gi·ªëng code: t√°ch h√†m.", explanation:"Modular h√≥a gi√∫p reuse, test t·ª´ng ph·∫ßn v√† gi·∫£m r·ªßi ro khi thay ƒë·ªïi." },
            { q:"T√≠ch h·ª£p nhi·ªÅu h·ªá th·ªëng: th·ª© c·∫ßn chu·∫©n h√≥a s·ªõm nh·∫•t?", options:["M√†u header","Schema d·ªØ li·ªáu trung gian","Kh√¥ng c·∫ßn schema","T·∫Øt debug"], answerIndex:1, hint:"C√≥ ‚Äúng√¥n ng·ªØ chung‚Äù gi·ªØa c√°c h·ªá.", explanation:"Schema trung gian gi√∫p data contract r√µ r√†ng, gi·∫£m sai l·ªách." },
            { q:"Ghi Sheet v√† g·ª≠i Slack: workflow h·ª£p l√Ω?", options:["Ch·ªâ 1 vi·ªác","2 nh√°nh/tu·∫ßn t·ª± + log l·ªói","X√≥a Merge","ƒê·ªïi background"], answerIndex:1, hint:"M·ªôt input, nhi·ªÅu output.", explanation:"C√≥ th·ªÉ tu·∫ßn t·ª± ho·∫∑c t√°ch nh√°nh; quan tr·ªçng l√† x·ª≠ l√Ω l·ªói v√† log." },
            { q:"Ch·∫°y theo l·ªãch: ƒëi·ªÅu n√™n c√¢n nh·∫Øc ƒë·∫ßu ti√™n?", options:["M√†u n·ªÅn","Khung gi·ªù √≠t t·∫£i & SLA","S·ªë icon","T√™n game"], answerIndex:1, hint:"Gi·ªù cao ƒëi·ªÉm d·ªÖ qu√° t·∫£i.", explanation:"Ch·ªçn l·ªãch ph√π h·ª£p gi√∫p h·ªá th·ªëng ·ªïn ƒë·ªãnh, tr√°nh tr√πng gi·ªù job kh√°c." }
          ],
          backup: [
            { q:"D·ªØ li·ªáu ƒë·∫ßu v√†o c√≥ th·ªÉ thi·∫øu field, thi·∫øt k·∫ø an to√†n?", options:["Assume ƒë·ªß","Validate + default + nh√°nh l·ªói","X√≥a node","T·∫Øt workflow"], answerIndex:1, hint:"Ph√≤ng th·ªß thay v√¨ c·∫ßu may.", explanation:"Validate & default gi√∫p tr√°nh crash; nh√°nh l·ªói gi√∫p audit." }
          ]
        }
      ]
    };

    // =========================
    // Helpers
    // =========================
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
    const fmtTime = (sec)=>{
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60), s = sec%60;
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    };
    const now = ()=>performance.now();
    function rand01(){
      if (window.crypto && crypto.getRandomValues){
        const a = new Uint32Array(1);
        crypto.getRandomValues(a);
        return a[0]/4294967295;
      }
      return Math.random();
    }
    function shuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(rand01()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // =========================
    // State
    // =========================
    const state = {
      mode: 'student',
      teacherAuthed: false,
      manualReveal: true,

      setId: CONFIG.questionSets[0].id,
      questions: [],
      backup: [],
      total: clamp(CONFIG.settings.totalQuestions, 10, 15),

      idx: -1,
      selected: null,
      locked: false,
      revealed: false,

      lifelines: { fifty:false, ask:false, swap:false },
      fiftyEliminated: new Set(),

      score: 0,
      streak: 0,

      running: false,
      paused: false,

      timePerQ: clamp(CONFIG.settings.timePerQuestionSec, 10, 300),
      remain: clamp(CONFIG.settings.timePerQuestionSec, 10, 300),
      timerId: null,

      startedAt: 0,
      totalElapsedSec: 0,
      qStartedAt: 0,

      history: []
    };

    // =========================
    // Elements
    // =========================
    const el = {
      logoBox: $('#logoBox'),
      gameTitle: $('#gameTitle'),
      gameTagline: $('#gameTagline'),

      timerText: $('#timerText'),
      scoreText: $('#scoreText'),
      progressText: $('#progressText'),

      qMetaText: $('#qMetaText'),
      qText: $('#qText'),

      hintPop: $('#hintPop'),
      hintText: $('#hintText'),
      explainPop: $('#explainPop'),
      explainText: $('#explainText'),

      statusLine: $('#statusLine'),

      ansBtns: $$('.ansBtn'),
      aTxt: [$('#a0'),$('#a1'),$('#a2'),$('#a3')],

      btnStart: $('#btnStart'),
      btnHint: $('#btnHint'),
      btnLock: $('#btnLock'),
      btnRevealStudent: $('#btnRevealStudent'),
      btnNextStudent: $('#btnNextStudent'),
      btnExport: $('#btnExport'),

      btnReset: $('#btnReset'),
      btnTeacher: $('#btnTeacher'),

      life5050: $('#life5050'),
      lifeAsk: $('#lifeAsk'),
      lifeSwap: $('#lifeSwap'),

      ladderList: $('#ladderList'),
      ladderMini: $('#ladderMini'),

      teacherPanel: $('#teacherPanel'),
      btnTeacherClose: $('#btnTeacherClose'),
      selSet: $('#selSet'),
      inpTime: $('#inpTime'),
      swManual: $('#swManual'),
      tBtnStart: $('#tBtnStart'),
      tBtnPause: $('#tBtnPause'),
      tBtnReveal: $('#tBtnReveal'),
      tBtnNext: $('#tBtnNext'),
      tBtnReset: $('#tBtnReset'),

      ovTeacher: $('#ovTeacher'),
      btnTeacherCancel: $('#btnTeacherCancel'),
      btnTeacherOk: $('#btnTeacherOk'),
      inpPass: $('#inpPass'),
      passStatus: $('#passStatus'),

      ovPoll: $('#ovPoll'),
      pollBody: $('#pollBody'),
      btnPollClose: $('#btnPollClose'),
      btnPollOk: $('#btnPollOk'),

      ovFinal: $('#ovFinal'),
      finalChoiceText: $('#finalChoiceText'),
      btnFinalClose: $('#btnFinalClose'),
      btnFinalNo: $('#btnFinalNo'),
      btnFinalYes: $('#btnFinalYes'),

      ovResult: $('#ovResult'),
      btnResultClose: $('#btnResultClose'),
      rScore: $('#rScore'),
      rCorrect: $('#rCorrect'),
      rWrong: $('#rWrong'),
      rTime: $('#rTime'),
      rSet: $('#rSet'),
      resultCanvas: $('#resultCanvas'),
      btnRender: $('#btnRender'),
      btnDownload: $('#btnDownload'),
      btnPlayAgain: $('#btnPlayAgain'),

      toast: $('#toast')
    };

    // =========================
    // UI utilities
    // =========================
    function toast(msg){
      el.toast.textContent = msg;
      el.toast.classList.add('show');
      el.toast.style.opacity = '1';
      el.toast.style.transform = 'translateX(-50%) translateY(0)';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{
        el.toast.style.opacity = '0';
        el.toast.style.transform = 'translateX(-50%) translateY(6px)';
        setTimeout(()=>el.toast.classList.remove('show'), 160);
      }, 1500);
    }
    function setOverlay(ov, show){
      ov.classList.toggle('show', !!show);
      if (show){
        const f = ov.querySelector('input,button,select,[tabindex]');
        if (f) f.focus();
      }
    }

    function moneyFmt(n){
      try{ return '$' + Number(n).toLocaleString('en-US'); }
      catch{ return '$' + String(n); }
    }

    // =========================
    // Data
    // =========================
    function getSetById(id){
      return CONFIG.questionSets.find(s=>s.id===id) || CONFIG.questionSets[0];
    }

    function loadSet(id){
      const set = getSetById(id);
      state.setId = set.id;
      state.questions = set.questions.slice(0, state.total).map((q,i)=>({ ...q, level:i+1 }));
      state.backup = (set.backup || []).slice();
      el.rSet.textContent = set.name;
      el.selSet.value = set.id;
      return set;
    }

    // =========================
    // Ladder
    // =========================
    function buildLadder(){
      const n = state.total;
      const ladder = CONFIG.settings.moneyLadder.slice(0, n);
      el.ladderList.innerHTML = '';
      for (let i=n-1;i>=0;i--){
        const level = i+1;
        const li = document.createElement('li');
        li.className = 'step';
        li.dataset.level = String(level);
        if (CONFIG.settings.safeLevels.includes(level)) li.classList.add('safe');
        li.innerHTML = `
          <span class="lvl">${String(level).padStart(2,'0')}</span>
          <span class="money">${moneyFmt(ladder[i])}</span>
        `;
        el.ladderList.appendChild(li);
      }
      updateLadder();
    }

    function updateLadder(){
      const steps = $$('.step', el.ladderList);
      const current = state.idx + 1;

      steps.forEach(s=>{
        s.classList.remove('current');
        const lvl = Number(s.dataset.level);
        s.classList.toggle('dim', lvl < current);
      });

      const curEl = steps.find(s=>Number(s.dataset.level) === current);
      if (curEl) curEl.classList.add('current');

      if (state.idx >= 0 && state.idx < state.total){
        const money = CONFIG.settings.moneyLadder[state.idx];
        el.ladderMini.textContent = `Q${current}/${state.total} ‚Ä¢ ${moneyFmt(money)}`;
      } else {
        el.ladderMini.textContent = '‚Äî';
      }
    }

    // =========================
    // Timer
    // =========================
    function stopTimer(){
      if (state.timerId){
        clearInterval(state.timerId);
        state.timerId = null;
      }
    }

    function startTimer(){
      stopTimer();
      if (!state.running || state.paused) return;

      el.timerText.textContent = fmtTime(state.remain);

      state.timerId = setInterval(()=>{
        state.remain -= 0.25;
        if (state.remain <= 0){
          state.remain = 0;
          el.timerText.textContent = fmtTime(0);
          stopTimer();
          onTimeout();
          return;
        }
        el.timerText.textContent = fmtTime(state.remain);
      }, 250);
    }

    function onTimeout(){
      if (!state.running || state.revealed) return;
      el.statusLine.innerHTML = `<span class="warn">H·∫øt gi·ªù!</span> Kh√¥ng k·ªãp ch·ªët ƒë√°p √°n.`;
      revealAnswer(null, { timedOut:true });
    }

    // =========================
    // Render
    // =========================
    function updateHud(){
      el.scoreText.textContent = state.score.toLocaleString('vi-VN');
      el.progressText.textContent = `${Math.max(0, state.idx+1)}/${state.total}`;
      el.timerText.textContent = fmtTime(state.remain);

      const tag = (state.mode==='teacher' && state.teacherAuthed) ? 'Teacher Mode' : 'Student Mode';
      el.gameTitle.textContent = CONFIG.text.gameTitle;
      el.gameTagline.textContent = `${tag} ‚Ä¢ ${CONFIG.text.tagline}`;
    }

    function clearFeedback(){
      el.statusLine.textContent = '';
      el.explainPop.style.display = 'none';
      el.explainPop.classList.remove('bad');
    }

    function setIdleUI(){
      el.qMetaText.textContent = 'Ai L√† Tri·ªáu Ph√∫';
      el.qText.textContent = 'ƒêang chu·∫©n b·ªã‚Ä¶';

      el.aTxt.forEach(t=>t.textContent='‚Äî');
      el.ansBtns.forEach(b=>{
        b.classList.remove('selected','locked','correct','wrong');
        b.setAttribute('aria-disabled','true');
        const tag = b.querySelector('.tag');
        if (tag) tag.textContent = 'ƒê√öNG';
      });

      el.btnHint.disabled = true;
      el.btnLock.disabled = true;
      el.btnRevealStudent.disabled = true;
      el.btnNextStudent.disabled = true;

      el.hintPop.classList.remove('show');
      el.explainPop.style.display = 'none';
      clearFeedback();
    }

    function renderQuestion(){
      const q = state.questions[state.idx];
      el.qMetaText.textContent = `C√¢u h·ªèi ${q.level}`;
      el.qText.textContent = q.q;

      for (let i=0;i<4;i++){
        el.aTxt[i].textContent = q.options[i];
      }

      el.ansBtns.forEach(b=>{
        b.classList.remove('selected','locked','correct','wrong');
        const tag = b.querySelector('.tag');
        if (tag) tag.textContent = 'ƒê√öNG';
      });

      const hasHint = Boolean(q.hint && String(q.hint).trim());
      el.btnHint.disabled = !hasHint;

      el.hintPop.classList.remove('show');
      el.explainPop.style.display = 'none';
      clearFeedback();

      updateAnswerEnabled();
      updateButtons();
      updateHud();
      updateLadder();
      updateTeacherPanelState();
    }

    function updateAnswerEnabled(){
      const can = state.running && !state.paused && state.idx >= 0 && !state.revealed && !state.locked;
      el.ansBtns.forEach(btn=>{
        const i = Number(btn.dataset.idx);
        const disabled = !can || state.fiftyEliminated.has(i);
        btn.setAttribute('aria-disabled', String(disabled));
      });
    }

    function updateButtons(){
      const inTeacher = state.mode==='teacher' && state.teacherAuthed;
      const canInteract = state.running && !state.paused && state.idx >= 0 && !state.revealed;

      el.btnStart.disabled = state.running && !state.paused;
      el.btnLock.disabled = !(canInteract && state.selected !== null && !state.locked);
      el.btnRevealStudent.disabled = inTeacher ? true : !(state.running && state.locked && !state.revealed);
      el.btnNextStudent.disabled = inTeacher ? true : !(state.running && state.revealed);

      // Lifelines
      el.life5050.classList.toggle('used', state.lifelines.fifty);
      el.lifeAsk.classList.toggle('used', state.lifelines.ask);
      el.lifeSwap.classList.toggle('used', state.lifelines.swap);

      el.life5050.disabled = !state.running || state.paused || state.revealed || state.locked || state.lifelines.fifty;
      el.lifeAsk.disabled  = !state.running || state.paused || state.revealed || state.locked || state.lifelines.ask;
      el.lifeSwap.disabled = !state.running || state.paused || state.revealed || state.locked || state.lifelines.swap;

      updateHud();
    }

    // =========================
    // Game flow
    // =========================
    function hardReset(keepSet=true){
      stopTimer();

      state.running = false;
      state.paused = false;

      state.idx = -1;
      state.selected = null;
      state.locked = false;
      state.revealed = false;

      state.lifelines = { fifty:false, ask:false, swap:false };
      state.fiftyEliminated = new Set();

      state.score = 0;
      state.streak = 0;

      state.startedAt = 0;
      state.totalElapsedSec = 0;
      state.qStartedAt = 0;

      state.history = [];

      state.timePerQ = clamp(Number(el.inpTime.value || CONFIG.settings.timePerQuestionSec), 10, 300);
      state.remain = state.timePerQ;

      if (!keepSet) loadSet(CONFIG.questionSets[0].id);
      else loadSet(state.setId);

      buildLadder();
      updateHud();
      setIdleUI();
      updateButtons();
      updateTeacherPanelState();
    }

    function startGame(){
      if (state.running) return;
      state.running = true;
      state.paused = false;
      state.startedAt = now();
      state.totalElapsedSec = 0;
      nextQuestion(true);
    }

    function pauseGame(){
      if (!state.running || state.paused) return;
      state.paused = true;
      stopTimer();
      state.totalElapsedSec += (now() - state.startedAt)/1000;
      state.startedAt = now();
      toast('ƒê√£ pause');
      updateButtons();
      updateTeacherPanelState();
    }

    function resumeGame(){
      if (!state.running) { startGame(); return; }
      if (!state.paused) return;
      state.paused = false;
      state.startedAt = now();
      state.qStartedAt = now();
      startTimer();
      toast('Ti·∫øp t·ª•c');
      updateButtons();
      updateTeacherPanelState();
    }

    function endGame(reason){
      state.running = false;
      state.paused = false;
      stopTimer();
      if (state.startedAt) state.totalElapsedSec += (now() - state.startedAt)/1000;
      el.statusLine.innerHTML = reason ? `<span class="warn">${escapeHtml(reason)}</span>` : '';
      openResult();
      updateButtons();
      updateTeacherPanelState();
    }

    function nextQuestion(isFirst=false){
      stopTimer();

      state.selected = null;
      state.locked = false;
      state.revealed = false;
      state.fiftyEliminated = new Set();

      state.idx = isFirst ? 0 : state.idx + 1;

      if (state.idx >= state.total){
        endGame('Ho√†n th√†nh t·∫•t c·∫£ c√¢u!');
        return;
      }

      state.remain = state.timePerQ;
      state.qStartedAt = now();

      renderQuestion();
      startTimer();
    }

    // =========================
    // Answer selection / locking / reveal
    // =========================
    function onSelectAnswer(i){
      if (!state.running || state.paused || state.revealed || state.locked) return;
      if (state.fiftyEliminated.has(i)) return;

      state.selected = i;
      el.ansBtns.forEach(b=>{
        b.classList.toggle('selected', Number(b.dataset.idx) === i);
      });
      el.statusLine.textContent = '';
      updateButtons();
    }

    function openFinalConfirm(){
      if (!state.running || state.paused || state.revealed || state.locked) return;
      if (state.selected === null) return;

      const q = state.questions[state.idx];
      const key = ['A','B','C','D'][state.selected];
      el.finalChoiceText.textContent = `${key}. ${q.options[state.selected]}`;
      setOverlay(el.ovFinal, true);
    }

    function lockAnswer(){
      if (!state.running || state.paused || state.revealed) return;
      if (state.selected === null || state.locked) return;

      state.locked = true;
      el.ansBtns.forEach(b=>{
        const idx = Number(b.dataset.idx);
        b.classList.toggle('locked', idx === state.selected);
      });

      el.statusLine.innerHTML = `ƒê√£ ch·ªët: <strong>${['A','B','C','D'][state.selected]}</strong>`;

      const inTeacher = state.mode==='teacher' && state.teacherAuthed;
      if (!(inTeacher && state.manualReveal)){
        setTimeout(()=>revealAnswer(state.selected), 450);
      } else {
        toast('Ch·ªù gi√°o vi√™n b·∫•m Reveal');
      }

      updateAnswerEnabled();
      updateButtons();
      updateTeacherPanelState();
    }

    function revealAnswer(chosenIndex, opts={}){
      if (!state.running || state.paused || state.revealed) return;

      state.revealed = true;
      stopTimer();

      const q = state.questions[state.idx];
      const correct = q.answerIndex;
      const isCorrect = (chosenIndex === correct);

      const spent = clamp(state.timePerQ - state.remain, 0, state.timePerQ);

      el.ansBtns.forEach(b=>{
        const i = Number(b.dataset.idx);
        b.classList.remove('locked');
        b.setAttribute('aria-disabled', 'true');

        const tag = b.querySelector('.tag');
        if (tag) tag.textContent = (i === correct) ? 'ƒê√öNG' : 'SAI';

        if (i === correct) b.classList.add('correct');
        if (chosenIndex !== null && i === chosenIndex && !isCorrect) b.classList.add('wrong');
      });

      if (q.explanation){
        el.explainText.textContent = q.explanation;
        el.explainPop.style.display = 'block';
        el.explainPop.classList.toggle('bad', !isCorrect);
      }

      if (opts.timedOut){
        el.statusLine.innerHTML = `<span class="no">SAI</span> (H·∫øt gi·ªù) ‚Ä¢ ƒê√∫ng: <strong>${['A','B','C','D'][correct]}</strong>`;
      } else if (chosenIndex === null){
        el.statusLine.innerHTML = `<span class="no">SAI</span> ‚Ä¢ B·∫°n ch∆∞a ch·ªët ‚Ä¢ ƒê√∫ng: <strong>${['A','B','C','D'][correct]}</strong>`;
      } else if (isCorrect){
        const money = CONFIG.settings.moneyLadder[state.idx];
        el.statusLine.innerHTML = `<span class="ok">ƒê√öNG!</span> ‚Ä¢ +${moneyFmt(money)}`;
      } else {
        el.statusLine.innerHTML = `<span class="no">SAI</span> ‚Ä¢ ƒê√∫ng: <strong>${['A','B','C','D'][correct]}</strong>`;
      }

      state.history.push({
        q: q.q,
        options: q.options.slice(),
        correctIndex: correct,
        chosenIndex: chosenIndex,
        isCorrect: isCorrect,
        timeSpentSec: spent
      });

      if (isCorrect){
        const money = CONFIG.settings.moneyLadder[state.idx];
        state.score += money;
        state.streak += 1;

        if (state.streak > 0 && (state.streak % CONFIG.settings.streakBonusEvery === 0)){
          state.score += CONFIG.settings.streakBonusPoints;
          toast(`Streak bonus +${CONFIG.settings.streakBonusPoints}!`);
        }

        const inTeacher = state.mode==='teacher' && state.teacherAuthed;
        if (!inTeacher){
          el.btnNextStudent.disabled = false;
          toast('ƒê√∫ng! B·∫•m Next');
        } else {
          toast('ƒê√∫ng! Gi√°o vi√™n b·∫•m Next');
        }
      } else {
        state.streak = 0;
        toast('Game over');
        endGame('Game over');
        return;
      }

      updateButtons();
      updateHud();
      updateLadder();
      updateTeacherPanelState();
    }

    // =========================
    // Lifelines
    // =========================
    function use5050(){
      if (state.lifelines.fifty || !state.running || state.paused || state.revealed || state.locked) return;

      const q = state.questions[state.idx];
      const correct = q.answerIndex;
      const wrongs = [0,1,2,3].filter(i=>i!==correct);
      const keepWrong = wrongs[Math.floor(rand01()*wrongs.length)];
      const eliminate = wrongs.filter(i=>i!==keepWrong);
      state.fiftyEliminated = new Set(eliminate);
      state.lifelines.fifty = true;

      el.ansBtns.forEach(b=>{
        const i = Number(b.dataset.idx);
        if (state.fiftyEliminated.has(i)){
          b.setAttribute('aria-disabled','true');
          b.classList.remove('selected');
        }
      });
      if (state.selected !== null && state.fiftyEliminated.has(state.selected)) state.selected = null;

      toast('ƒê√£ d√πng 50/50');
      updateButtons();
      updateAnswerEnabled();
    }

    function useAskClass(){
      if (state.lifelines.ask || !state.running || state.paused || state.revealed || state.locked) return;

      state.lifelines.ask = true;
      updateButtons();

      const q = state.questions[state.idx];
      const correct = q.answerIndex;
      const difficulty = (state.idx + 1) / state.total;

      const baseCorrect = 0.72 - (0.36 * difficulty);
      const noise = (rand01() - 0.5) * 0.10;
      let pCorrect = clamp(baseCorrect + noise, 0.28, 0.82);

      const remaining = 1 - pCorrect;
      const others = [0,1,2,3].filter(i=>i!==correct);
      const splits = shuffle([rand01(), rand01(), rand01()]);
      const sum = splits.reduce((a,b)=>a+b, 0.00001);

      const dist = [0,0,0,0];
      dist[correct] = pCorrect;
      for (let i=0;i<3;i++){
        dist[others[i]] = remaining * (splits[i]/sum);
      }

      let perc = dist.map(x=>Math.round(x*100));
      let diff100 = 100 - perc.reduce((a,b)=>a+b,0);
      while (diff100 !== 0){
        const k = Math.floor(rand01()*4);
        if (diff100 > 0){ perc[k] += 1; diff100 -= 1; }
        else if (perc[k] > 0){ perc[k] -= 1; diff100 += 1; }
      }

      renderPoll(perc);
      setOverlay(el.ovPoll, true);
      requestAnimationFrame(()=>{
        $$('#pollBody .bar > i').forEach((bar, i)=>{ bar.style.width = perc[i] + '%'; });
      });
    }

    function renderPoll(perc){
      el.pollBody.innerHTML = '';
      const keys = ['A','B','C','D'];
      for (let i=0;i<4;i++){
        const row = document.createElement('div');
        row.className = 'barRow';
        row.innerHTML = `
          <div class="barKey" aria-hidden="true">${keys[i]}</div>
          <div class="bar" aria-label="T·ª∑ l·ªá ${keys[i]}"><i></i></div>
          <div class="pct">${perc[i]}%</div>
        `;
        el.pollBody.appendChild(row);
      }
    }

    function useSwap(){
      if (state.lifelines.swap || !state.running || state.paused || state.revealed || state.locked) return;

      const b = state.backup.shift();
      if (!b){
        state.lifelines.swap = true;
        toast('Kh√¥ng c√≤n c√¢u d·ª± ph√≤ng');
        updateButtons();
        return;
      }
      const level = state.idx + 1;
      state.questions[state.idx] = { ...b, level };
      state.lifelines.swap = true;
      state.selected = null;
      state.fiftyEliminated = new Set();

      toast('ƒê√£ ƒë·ªïi c√¢u');
      renderQuestion();
      updateButtons();
    }

    // =========================
    // Teacher mode
    // =========================
    function openTeacherLogin(){
      el.inpPass.value = '';
      el.passStatus.textContent = 'Ch∆∞a x√°c th·ª±c';
      setOverlay(el.ovTeacher, true);
    }

    function authTeacher(){
      const pass = String(el.inpPass.value || '').trim();
      if (pass === CONFIG.text.teacherPass){
        state.teacherAuthed = true;
        state.mode = 'teacher';
        setOverlay(el.ovTeacher, false);
        el.teacherPanel.classList.add('show');
        toast('Teacher Mode: ON');
        updateButtons();
        updateTeacherPanelState();
      } else {
        el.passStatus.textContent = '‚ùå Sai m·∫≠t kh·∫©u. Th·ª≠ l·∫°i.';
        el.inpPass.focus();
      }
    }

    function closeTeacher(){
      state.mode = 'student';
      el.teacherPanel.classList.remove('show');
      toast('Teacher Mode: OFF');
      updateButtons();
      updateTeacherPanelState();
    }

    function updateTeacherPanelState(){
      const isTeacher = state.mode==='teacher' && state.teacherAuthed;
      el.teacherPanel.classList.toggle('show', isTeacher);

      el.tBtnReveal.disabled = !state.running || state.paused || state.revealed || (!state.locked && state.remain > 0);
      el.tBtnNext.disabled = !state.running || state.paused || !state.revealed;
      el.tBtnPause.disabled = !state.running || state.paused;
      el.tBtnStart.disabled = (state.running && !state.paused);

      el.swManual.classList.toggle('on', !!state.manualReveal);
      el.swManual.setAttribute('aria-checked', String(!!state.manualReveal));
      el.inpTime.value = String(state.timePerQ);
      el.selSet.value = state.setId;

      // Student buttons hidden when teacher
      el.btnRevealStudent.style.display = isTeacher ? 'none' : 'inline-flex';
      el.btnNextStudent.style.display = isTeacher ? 'none' : 'inline-flex';
    }

    function teacherStartResume(){
      if (!state.running) startGame();
      else resumeGame();
    }
    function teacherReveal(){
      if (!state.running || state.paused || state.revealed) return;
      if (!state.locked) revealAnswer(null);
      else revealAnswer(state.selected);
    }
    function teacherNext(){
      if (!state.running || state.paused || !state.revealed) return;
      nextQuestion(false);
    }
    function teacherApplySet(){
      const id = el.selSet.value;
      if (!id) return;
      if (state.running) toast('ƒê·ªïi b·ªô ƒë·ªÅ ‚Üí Reset v√°n');
      state.setId = id;
      loadSet(id);
      hardReset(true);
    }
    function teacherApplyTime(){
      const n = clamp(Number(el.inpTime.value || CONFIG.settings.timePerQuestionSec), 10, 300);
      state.timePerQ = n;
      if (!state.running || state.idx < 0){
        state.remain = n;
        updateHud();
      }
      toast(`Timer: ${n}s/c√¢u`);
      updateButtons();
      updateTeacherPanelState();
    }
    function toggleManualReveal(){
      state.manualReveal = !state.manualReveal;
      toast(`Manual Reveal: ${state.manualReveal ? 'ON' : 'OFF'}`);
      updateTeacherPanelState();
    }

    // =========================
    // Result export (canvas)
    // =========================
    function openResult(){
      const correct = state.history.filter(x=>x.isCorrect).length;
      const wrong = state.history.filter(x=>!x.isCorrect).length;

      el.rScore.textContent = state.score.toLocaleString('vi-VN');
      el.rCorrect.textContent = String(correct);
      el.rWrong.textContent = String(wrong);
      el.rTime.textContent = fmtTime(state.totalElapsedSec);
      el.rSet.textContent = getSetById(state.setId).name;

      renderResultCanvas();
      setOverlay(el.ovResult, true);
    }

    function renderResultCanvas(){
      const c = el.resultCanvas;
      const ctx = c.getContext('2d');
      const W = c.width, H = c.height;

      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0, '#06122b');
      g.addColorStop(1, '#050a16');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,W,H);

      blob(ctx, 260,160,260,'rgba(74,163,255,.24)');
      blob(ctx, 980,140,300,'rgba(255,184,74,.16)');
      blob(ctx, 860,560,300,'rgba(47,125,255,.16)');

      ctx.globalAlpha = 0.18;
      ctx.strokeStyle = 'rgba(255,255,255,.18)';
      ctx.lineWidth = 1;
      for (let x=60;x<W;x+=90){ ctx.beginPath(); ctx.moveTo(x,40); ctx.lineTo(x,H-40); ctx.stroke(); }
      for (let y=60;y<H;y+=90){ ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(W-40,y); ctx.stroke(); }
      ctx.globalAlpha = 1;

      ctx.fillStyle = 'rgba(234,241,255,.96)';
      ctx.font = '900 44px system-ui';
      ctx.fillText('AI L√Ä TRI·ªÜU PH√ö', 64, 90);

      ctx.fillStyle = 'rgba(234,241,255,.72)';
      ctx.font = '900 18px system-ui';
      ctx.fillText(`${CONFIG.text.tagline} ‚Ä¢ ${getSetById(state.setId).name}`, 64, 122);

      const stats = [
        { k:'SCORE', v: state.score.toLocaleString('vi-VN') },
        { k:'CORRECT', v: String(state.history.filter(x=>x.isCorrect).length) },
        { k:'WRONG', v: String(state.history.filter(x=>!x.isCorrect).length) },
        { k:'TIME', v: fmtTime(state.totalElapsedSec) }
      ];
      const cardX = 64, cardY = 158, cardW = 260, cardH = 92, gap = 16;

      stats.forEach((s,i)=>{
        const x = cardX + i*(cardW+gap);
        const y = cardY;
        roundRect(ctx, x,y,cardW,cardH,18);
        ctx.fillStyle = 'rgba(0,0,0,.28)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,184,74,.35)';
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.fillStyle = 'rgba(234,241,255,.62)';
        ctx.font = '900 14px system-ui';
        ctx.fillText(s.k, x+18, y+30);

        ctx.fillStyle = 'rgba(255,230,170,.95)';
        ctx.font = '1000 28px system-ui';
        ctx.fillText(s.v, x+18, y+68);
      });

      const listX=64, listY=280, listW=W-128, listH=H-340;
      roundRect(ctx, listX,listY,listW,listH,22);
      ctx.fillStyle = 'rgba(0,0,0,.22)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,.14)';
      ctx.lineWidth = 1;
      ctx.stroke();

      ctx.fillStyle = 'rgba(234,241,255,.78)';
      ctx.font = '1000 16px system-ui';
      ctx.fillText('Chi ti·∫øt (t·ªëi ƒëa 10 d√≤ng)', listX+18, listY+34);

      const lines = state.history.slice(0,10);
      const startY = listY + 64;
      const lh = 28;
      ctx.font = '900 14px system-ui';

      lines.forEach((h,i)=>{
        const y = startY + i*lh;
        const lvl = i+1;
        const cKey = ['A','B','C','D'][h.correctIndex];
        const uKey = (h.chosenIndex===null || h.chosenIndex===undefined) ? '‚Äî' : ['A','B','C','D'][h.chosenIndex];

        ctx.fillStyle = h.isCorrect ? 'rgba(59,226,143,.95)' : 'rgba(255,77,109,.95)';
        ctx.beginPath(); ctx.arc(listX+22, y-6, 6, 0, Math.PI*2); ctx.fill();

        ctx.fillStyle = 'rgba(234,241,255,.90)';
        ctx.fillText(`#${String(lvl).padStart(2,'0')}  ${ellipsis(h.q, 72)}`, listX+38, y);

        ctx.fillStyle = 'rgba(234,241,255,.62)';
        ctx.fillText(`B·∫°n: ${uKey} | ƒê√∫ng: ${cKey} | ${Math.round(h.timeSpentSec)}s`, listX + listW - 355, y);
      });

      ctx.fillStyle = 'rgba(234,241,255,.52)';
      ctx.font = '900 12px system-ui';
      const stamp = `Generated in-browser ‚Ä¢ ${new Date().toLocaleString('vi-VN')}`;
      ctx.fillText(stamp, 64, H-52);

      const brand = CONFIG.text.brand || '';
      const wBrand = ctx.measureText(brand).width;
      ctx.fillText(brand, W-64-wBrand, H-52);

      el.btnDownload.href = c.toDataURL('image/png');
    }

    function blob(ctx,x,y,r,col){
      const g = ctx.createRadialGradient(x,y,0,x,y,r);
      g.addColorStop(0, col);
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    }
    function roundRect(ctx,x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,x+w,y+h,rr);
      ctx.arcTo(x+w,y+h,x,y+h,rr);
      ctx.arcTo(x,y+h,x,y,rr);
      ctx.arcTo(x,y,x+w,y,rr);
      ctx.closePath();
    }
    function ellipsis(s,max){
      s = String(s||'');
      return s.length<=max ? s : s.slice(0,max-1)+'‚Ä¶';
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // =========================
    // Events
    // =========================
    function bindEvents(){
      el.ansBtns.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if (btn.getAttribute('aria-disabled')==='true') return;
          onSelectAnswer(Number(btn.dataset.idx));
        });
      });

      el.btnStart.addEventListener('click', ()=>{
        if (!state.running) startGame();
        else if (state.paused) resumeGame();
      });

      el.btnHint.addEventListener('click', ()=>{
        if (!state.running || state.idx < 0) return;
        const q = state.questions[state.idx];
        if (!q.hint) { toast('Kh√¥ng c√≥ hint'); return; }
        el.hintText.textContent = q.hint;
        el.hintPop.classList.toggle('show');
      });

      el.btnLock.addEventListener('click', openFinalConfirm);

      el.btnRevealStudent.addEventListener('click', ()=>{
        const inTeacher = state.mode==='teacher' && state.teacherAuthed;
        if (inTeacher) return;
        if (!state.locked) { toast('H√£y ch·ªët ƒë√°p √°n tr∆∞·ªõc'); return; }
        revealAnswer(state.selected);
      });

      el.btnNextStudent.addEventListener('click', ()=>{
        const inTeacher = state.mode==='teacher' && state.teacherAuthed;
        if (inTeacher) return;
        if (!state.revealed) return;
        nextQuestion(false);
      });

      el.btnReset.addEventListener('click', ()=>{ hardReset(true); toast('ƒê√£ reset'); });

      el.btnTeacher.addEventListener('click', ()=>{
        if (state.teacherAuthed){
          state.mode = 'teacher';
          updateButtons();
          updateTeacherPanelState();
          toast('Teacher Mode: ON');
        } else {
          openTeacherLogin();
        }
      });

      el.life5050.addEventListener('click', use5050);
      el.lifeAsk.addEventListener('click', useAskClass);
      el.lifeSwap.addEventListener('click', useSwap);

      el.btnTeacherCancel.addEventListener('click', ()=>setOverlay(el.ovTeacher,false));
      el.btnTeacherOk.addEventListener('click', authTeacher);
      el.inpPass.addEventListener('keydown', (e)=>{ if (e.key==='Enter') authTeacher(); });

      el.btnTeacherClose.addEventListener('click', closeTeacher);
      el.tBtnStart.addEventListener('click', ()=>{ if (!state.running) startGame(); else resumeGame(); });
      el.tBtnPause.addEventListener('click', pauseGame);
      el.tBtnReveal.addEventListener('click', teacherReveal);
      el.tBtnNext.addEventListener('click', teacherNext);
      el.tBtnReset.addEventListener('click', ()=>{ hardReset(true); toast('ƒê√£ reset'); });

      el.selSet.addEventListener('change', teacherApplySet);
      el.inpTime.addEventListener('change', teacherApplyTime);

      el.swManual.addEventListener('click', toggleManualReveal);
      el.swManual.addEventListener('keydown', (e)=>{
        if (e.key==='Enter' || e.key===' ') { e.preventDefault(); toggleManualReveal(); }
      });

      el.btnPollClose.addEventListener('click', ()=>setOverlay(el.ovPoll,false));
      el.btnPollOk.addEventListener('click', ()=>setOverlay(el.ovPoll,false));

      el.btnFinalClose.addEventListener('click', ()=>setOverlay(el.ovFinal,false));
      el.btnFinalNo.addEventListener('click', ()=>setOverlay(el.ovFinal,false));
      el.btnFinalYes.addEventListener('click', ()=>{
        setOverlay(el.ovFinal,false);
        lockAnswer();
      });

      el.btnExport.addEventListener('click', openResult);
      el.btnResultClose.addEventListener('click', ()=>setOverlay(el.ovResult,false));
      el.btnPlayAgain.addEventListener('click', ()=>{
        setOverlay(el.ovResult,false);
        hardReset(true);
        toast('S·∫µn s√†ng ch∆°i l·∫°i');
        if (CONFIG.settings.autoStartStudent && state.mode==='student') startGame();
      });
      el.btnRender.addEventListener('click', ()=>{ renderResultCanvas(); toast('ƒê√£ render ·∫£nh'); });

      document.addEventListener('keydown', (e)=>{
        if (e.key==='Escape'){
          [el.ovTeacher, el.ovPoll, el.ovFinal, el.ovResult].forEach(ov=>ov.classList.remove('show'));
        }
        if (state.mode==='student' && state.running && !state.paused && !state.locked && !state.revealed){
          const k = e.key.toLowerCase();
          const map = {a:0,b:1,c:2,d:3};
          if (k in map){
            const idx = map[k];
            if (!state.fiftyEliminated.has(idx)) onSelectAnswer(idx);
          }
        }
      }, { passive:true });
    }

    // =========================
    // Boot
    // =========================
    function init(){
      el.logoBox.innerHTML = CONFIG.assets.logoSvg;
      el.gameTitle.textContent = CONFIG.text.gameTitle;
      el.gameTagline.textContent = `Student Mode ‚Ä¢ ${CONFIG.text.tagline}`;

      if (CONFIG.assets.stageBg){
        document.documentElement.style.setProperty('--stage-bg', `url("${CONFIG.assets.stageBg}")`);
      } else {
        document.documentElement.style.setProperty('--stage-bg', 'none');
      }

      el.selSet.innerHTML = '';
      CONFIG.questionSets.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        el.selSet.appendChild(opt);
      });

      el.inpTime.value = String(state.timePerQ);

      loadSet(state.setId);
      buildLadder();
      hardReset(true);
      bindEvents();
      updateTeacherPanelState();
      updateButtons();

      // ‚úÖ Auto-start in Student mode
      if (CONFIG.settings.autoStartStudent && state.mode === 'student' && !state.teacherAuthed){
        startGame();
      }
    }

    init();
  </script>
</body>
</html>
